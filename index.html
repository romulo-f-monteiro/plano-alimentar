<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Alimentar – Dietas Personalizadas</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #059669;
            --primary-hover: #047857;
            --primary-light: #ecfdf5;
            --primary-text: #065f46;
            --border-color: #d1fae5;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
        }
        
        .theme-bg { background-color: var(--primary) !important; }
        .theme-bg-hover:hover { background-color: var(--primary-hover) !important; }
        .theme-bg-light { background-color: var(--primary-light) !important; }
        .theme-text { color: var(--primary) !important; }
        .theme-text-dark { color: var(--primary-text) !important; }
        .theme-border { border-color: var(--border-color) !important; }
        .theme-ring:focus { --tw-ring-color: var(--primary); }

        /* Remove setas do input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .backdrop-blur-sm {
                backdrop-filter: none !important;
                background-color: rgba(255, 255, 255, 0.9) !important;
            }
            .table-container { overflow-x: auto; }
        }

        /* --- CONFIGURAÇÃO DE IMPRESSÃO (NATIVO) --- */
        @media print {
            @page { margin: 10mm; size: auto; }

            * {
                animation: none !important;
                transition: none !important;
                transform: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                box-shadow: none !important;
                text-shadow: none !important;
                filter: none !important;
            }

            body { 
                background-color: white; 
                margin: 0; 
                padding: 0; 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            #toast { display: none !important; }
            #splash-screen { display: none !important; } /* Garante que a tela inicial não imprima */

            .container, #document-area {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }

            table { width: 100% !important; table-layout: fixed !important; }
            
            /* --- ALTERAÇÕES DE LARGURA DE COLUNA --- */
            .col-name { width: 42% !important; }
            
            .col-qty { 
                width: 11% !important; 
                text-align: center !important; 
                white-space: nowrap !important;
                overflow: hidden !important;
                padding: 0 !important; 
            } 
            
            .col-qty .qty-wrapper {
                justify-content: center !important;
                width: 100% !important;
            }
            
            .col-cal { 
                width: 9% !important; 
                text-align: center !important; 
                white-space: nowrap !important; 
            }
            
            .col-macro { 
                width: 8% !important; 
                text-align: center !important;
                white-space: nowrap !important;
                font-size: 9px !important; 
            }
            
            .col-actions { display: none !important; width: 0 !important; }

            .card, .break-inside-avoid { 
                break-inside: avoid; 
                page-break-inside: avoid; 
                border: 1px solid #ddd;
                box-shadow: none !important;
            }
            
            .qty-input {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                text-align: right !important;
                width: auto !important;
                max-width: 40px !important;
                font-weight: normal !important;
                margin-right: 2px !important;
            }

            .meal-header {
                background-color: #f8fafc !important;
                border-bottom: 1px solid #e2e8f0 !important;
            }
            
            .totals-footer {
                background-color: #f1f5f9 !important;
                border-top: 1px solid #cbd5e1 !important;
                color: #334155 !important;
                font-weight: bold !important;
            }
        }

        .editable-div {
            min-height: 100px;
            overflow: hidden;
            outline: none;
        }
        .editable-div:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .clean-input {
            background: transparent;
            border: none;
            text-align: center;
            width: 100%;
            outline: none;
        }
        .clean-input:focus { background: rgba(0,0,0,0.02); }

        .measure-cell {
            padding: 8px;
            border: 1px solid #cbd5e1;
            text-align: center;
        }

        [contenteditable="true"]:hover {
            background-color: #f8fafc;
            cursor: text;
            text-decoration: underline;
            text-decoration-style: dashed;
            text-decoration-color: #cbd5e1;
        }
        [contenteditable="true"]:focus {
            background-color: #ffffff;
            outline: 2px solid var(--primary-light);
            text-decoration: none;
            border-radius: 4px;
        }

        .qty-input {
            width: 45px;
            text-align: center;
            background-color: transparent;
            border-bottom: 1px dashed #cbd5e1;
            transition: border 0.2s;
        }
        .qty-input:focus {
            outline: none;
            background-color: white;
            border-bottom: 2px solid var(--primary);
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- ============================== -->
    <!-- TELA INICIAL (SPLASH SCREEN) -->
    <!-- ============================== -->
    <div id="splash-screen" class="fixed inset-0 z-[100] bg-gradient-to-br from-emerald-600 to-teal-900 flex flex-col items-center justify-center text-white px-4 transition-opacity duration-700 ease-out no-print">
        <div class="max-w-md w-full bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-2xl shadow-2xl text-center transform transition-all hover:scale-[1.01]">
            
            <div class="mb-6 inline-flex items-center justify-center w-20 h-20 bg-white rounded-full text-emerald-600 shadow-lg">
                <i class="fa-solid fa-leaf text-4xl"></i>
            </div>

            <h1 class="text-3xl font-black mb-2 tracking-tight">Sejam bem vindos nutris!</h1>
            
            <p class="text-lg opacity-90 mb-6 leading-relaxed font-light">
                Aproveite o máximo da ferramenta, ela te ajudará além do calculo da dieta.
            </p>

            <div class="bg-black/20 rounded-lg p-3 mb-8 inline-block">
                <p class="text-sm font-medium flex items-center gap-2 justify-center">
                    <span class="opacity-75">Feito por um nutri:</span>
                    <a href="https://instagram.com/romulof.monteiro" target="_blank" class="font-bold hover:text-emerald-200 transition flex items-center gap-1">
                        <i class="fa-brands fa-instagram"></i> romulof.monteiro
                    </a>
                </p>
            </div>

            <button onclick="closeSplash()" class="w-full bg-white text-emerald-800 font-bold py-4 rounded-xl shadow-lg hover:bg-emerald-50 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2">
                Começar a Planejar <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>
    <!-- FIM DA TELA INICIAL -->


    <!-- Header Principal -->
    <header class="theme-bg text-white shadow-lg no-print transition-colors duration-300">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="flex items-center justify-center w-12 h-12 bg-white/20 rounded-lg border-2 border-white/30 backdrop-blur-sm">
                    <span class="text-xl font-black tracking-tighter">RFM</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold">Plano Alimentar</h1>
                    <p class="text-xs opacity-90">Dietas Personalizadas</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <!-- Botão Gerenciar Pacientes -->
                <button onclick="openPatientModal()" class="bg-slate-900/30 hover:bg-slate-900/50 text-white px-4 py-2 rounded-lg font-semibold text-sm transition shadow-sm flex items-center gap-2 border border-white/20">
                    <i class="fa-solid fa-users"></i> <span id="current-patient-label">Pacientes</span>
                </button>

                <button onclick="printDiet()" class="bg-white text-slate-700 hover:bg-slate-100 px-4 py-2 rounded-lg font-semibold text-sm transition shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-print text-slate-600"></i> Imprimir PDF
                </button>
            </div>
        </div>
    </header>

    <!-- Área de Conteúdo (Documento) -->
    <div id="document-area" class="bg-white md:bg-transparent w-full max-w-[1200px] mx-auto">
        
        <!-- Cabeçalho do Documento -->
        <div class="container mx-auto px-4 mt-6 mb-2">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center text-center gap-2 w-full break-inside-avoid">
                
                <!-- Logo Topo -->
                <div class="mb-4 relative group cursor-pointer" onclick="document.getElementById('logo-upload').click()">
                    <img id="logo-img-main" src="" class="h-24 object-contain hidden mx-auto">
                    <div id="logo-placeholder" class="w-24 h-24 bg-slate-50 rounded-full border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400 mx-auto">
                        <i class="fa-solid fa-camera text-2xl mb-1"></i>
                        <span class="text-[10px]">Add Logo</span>
                    </div>
                    <span class="text-xs text-blue-500 hover:underline mt-1 block no-print">Alterar Logo (Max 2MB)</span>
                    <input type="file" id="logo-upload" accept="image/*" class="hidden" onchange="handleImageUpload(event, 'logo-img-main', 'logo-placeholder'); triggerAutoSave();">
                </div>

                <!-- Dados do Paciente -->
                <div class="w-full max-w-2xl space-y-1">
                    <input type="text" id="patient-name" class="clean-input text-2xl font-bold text-slate-800 placeholder-slate-300" placeholder="Nome do Paciente" value="Paciente Exemplo" onkeyup="triggerAutoSave()">
                    <input type="text" id="patient-goal" class="clean-input text-md font-medium text-slate-600 placeholder-slate-300" placeholder="Objetivo" value="Objetivo: Hipertrofia" onkeyup="triggerAutoSave()">
                    <div class="relative">
                        <input type="date" id="diet-date" class="clean-input text-sm text-slate-500 font-medium no-print" onchange="updateDateDisplay(); triggerAutoSave();">
                        <span id="date-display" class="hidden print-only text-sm text-slate-500 font-medium w-full text-center block"></span>
                    </div>
                </div>
            </div>
        </div>

        <main class="flex-grow container mx-auto px-4 py-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- COLUNA DA ESQUERDA: Controles (Oculto no PDF) -->
            <div class="lg:col-span-4 no-print">
                
                <!-- CONTAINER STICKY PARA O MENU LATERAL -->
                <div class="sticky top-4 space-y-6 max-h-[calc(100vh-2rem)] overflow-y-auto custom-scroll pr-1 pb-4">
                    
                    <!-- 1. Cor (FIXADO NO TOPO) -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-xs font-bold text-slate-500 uppercase mb-3">Personalizar Cor</h3>
                        <div class="grid grid-cols-5 gap-3">
                            <button onclick="setTheme('emerald'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-emerald-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Verde Esmeralda"></button>
                            <button onclick="setTheme('blue'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-blue-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Azul"></button>
                            <button onclick="setTheme('indigo'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-indigo-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Índigo"></button>
                            <button onclick="setTheme('rose'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-rose-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Rosa"></button>
                            <button onclick="setTheme('amber'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-amber-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Âmbar/Laranja"></button>
                            <button onclick="setTheme('purple'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-purple-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Roxo"></button>
                            <button onclick="setTheme('cyan'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-cyan-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Ciano"></button>
                            <button onclick="setTheme('teal'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-teal-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Turquesa"></button>
                            <button onclick="setTheme('lime'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-lime-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Verde Limão"></button>
                            <button onclick="setTheme('fuchsia'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-fuchsia-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Fúcsia"></button>
                        </div>
                    </div>

                    <!-- 2. NOVA CALCULADORA DO PROFISSIONAL -->
                    <div class="bg-slate-800 text-white p-5 rounded-xl shadow-lg border border-slate-700 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <i class="fa-solid fa-calculator text-6xl"></i>
                        </div>
                        
                        <h2 class="font-bold text-lg mb-4 flex items-center gap-2 relative z-10">
                            Área do Nutricionista
                        </h2>

                        <!-- Inputs Antropométricos -->
                        <div class="space-y-3 relative z-10 text-sm">
                            <div class="flex gap-2 bg-slate-700/50 p-1 rounded-lg">
                                <label class="flex-1 text-center cursor-pointer">
                                    <input type="radio" name="calc-sex" value="m" checked class="peer sr-only" onchange="calculateEnergy(); triggerAutoSave();">
                                    <div class="py-1.5 rounded peer-checked:bg-blue-600 peer-checked:text-white text-slate-400 transition text-xs font-bold">Homem</div>
                                </label>
                                <label class="flex-1 text-center cursor-pointer">
                                    <input type="radio" name="calc-sex" value="f" class="peer sr-only" onchange="calculateEnergy(); triggerAutoSave();">
                                    <div class="py-1.5 rounded peer-checked:bg-pink-600 peer-checked:text-white text-slate-400 transition text-xs font-bold">Mulher</div>
                                </label>
                            </div>

                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="text-[10px] text-slate-400 uppercase">Peso (kg)</label>
                                    <input type="number" id="calc-weight" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-center focus:border-emerald-500 outline-none" placeholder="0" onkeyup="calculateEnergy(); triggerAutoSave();">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 uppercase">Altura (cm)</label>
                                    <input type="number" id="calc-height" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-center focus:border-emerald-500 outline-none" placeholder="0" onkeyup="calculateEnergy(); triggerAutoSave();">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 uppercase">Idade</label>
                                    <input type="number" id="calc-age" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-center focus:border-emerald-500 outline-none" placeholder="0" onkeyup="calculateEnergy(); triggerAutoSave();">
                                </div>
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-400 uppercase">Fórmula TMB</label>
                                <select id="calc-formula" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-xs outline-none" onchange="toggleBodyFatInput(); calculateEnergy(); triggerAutoSave();">
                                    <option value="mifflin" selected>Mifflin-St Jeor (Padrão)</option>
                                    <option value="harris">Harris-Benedict</option>
                                    <option value="tinsley_ph">Tinsley (Peso e Altura)</option>
                                    <option value="tinsley_katch">Tinsley / Katch–McArdle (MLG)</option>
                                    <option value="cunningham">Cunningham, 1980 (MLG)</option>
                                </select>
                            </div>

                            <!-- Campo % Gordura (Escondido por padrão) -->
                            <div id="bf-container" class="hidden">
                                <label class="text-[10px] text-slate-400 uppercase">% Gordura (BF)</label>
                                <input type="number" id="calc-bf" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-center focus:border-emerald-500 outline-none" placeholder="Ex: 15" onkeyup="calculateEnergy(); triggerAutoSave();">
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-400 uppercase">Nível de Atividade</label>
                                <select id="calc-activity" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-xs outline-none" onchange="calculateEnergy(); triggerAutoSave();">
                                    <option value="1.2">Sedentário (Pouco ou nenhum - FA 1 - 1,39)</option>
                                    <option value="1.375">Leve (1-3 dias/sem - FA 1,4 - 1,59)</option>
                                    <option value="1.55" selected>Moderado (3-5 dias/sem - FA 1,6 - 1,89)</option>
                                    <option value="1.725">Intenso (6-7 dias/sem - FA 1,9 - 2,49)</option>
                                    <option value="1.9">Muito Intenso (Atleta - FA > 2,5)</option>
                                </select>
                            </div>

                            <!-- Resultados Calculados -->
                            <div class="grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-slate-700">
                                <div class="text-center">
                                    <div class="text-[10px] text-slate-400">IMC</div>
                                    <div id="res-bmi" class="font-bold text-emerald-400 text-lg">--</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-[10px] text-slate-400">Basal (TMB)</div>
                                    <div id="res-bmr" class="font-bold text-white text-sm">--</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-[10px] text-slate-400">Total (GET)</div>
                                    <div id="res-tdee" class="font-bold text-white text-sm">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Painel de Metas da Dieta -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="font-bold text-sm mb-3 flex items-center gap-2 text-slate-700 uppercase tracking-wide">
                            <i class="fa-solid fa-bullseye text-blue-500"></i> Metas da Dieta
                        </h2>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs font-bold text-slate-500">Meta Calórica (Kcal)</label>
                                <input type="number" id="target-cal" class="w-full border border-slate-300 rounded p-2 text-center font-bold text-slate-700 focus:ring-2 focus:ring-blue-200 outline-none" value="2000" onkeyup="renderDiet(); triggerAutoSave();">
                            </div>

                             <!-- NOVO: META DE FIBRAS -->
                             <div>
                                <label class="text-xs font-bold text-slate-500">Meta de Fibras (g)</label>
                                <input type="number" id="target-fiber" class="w-full border border-slate-300 rounded p-2 text-center font-bold text-slate-700 focus:ring-2 focus:ring-emerald-200 outline-none" value="25" onkeyup="renderDiet(); triggerAutoSave();" placeholder="Ex: 25">
                            </div>

                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <div class="flex justify-between text-[10px] text-slate-400 uppercase font-bold mb-1">
                                    <span>Carbo</span>
                                    <span>Prot</span>
                                    <span>Gord</span>
                                </div>
                                <div class="flex gap-2">
                                    <input type="number" id="target-carb-pct" class="w-full p-1 text-center border rounded text-xs" value="50" onkeyup="renderDiet(); triggerAutoSave();">
                                    <input type="number" id="target-prot-pct" class="w-full p-1 text-center border rounded text-xs" value="30" onkeyup="renderDiet(); triggerAutoSave();">
                                    <input type="number" id="target-fat-pct" class="w-full p-1 text-center border rounded text-xs" value="20" onkeyup="renderDiet(); triggerAutoSave();">
                                </div>
                                <div class="text-[10px] text-center mt-1 text-slate-400">
                                    Total: <span id="total-pct-display">100</span>%
                                </div>
                            </div>

                            <!-- Comparativo Rápido (Exibe Metas Calculadas) -->
                            <div id="comparison-widget" class="text-xs space-y-1 pt-2 border-t border-slate-100">
                                <!-- Preenchido via JS -->
                            </div>
                        </div>
                    </div>

                    <!-- 4. Adicionar Refeições (Card Principal) -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700">
                            <i class="fa-solid fa-carrot theme-text"></i> Adicionar Refeições
                        </h2>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Escolha a Refeição</label>
                                <select id="select-meal" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none text-sm font-semibold text-slate-700">
                                    <!-- JS Populates -->
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Opção</label>
                                <div class="flex gap-2">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="meal-option" value="A" checked class="peer sr-only">
                                        <div class="text-center py-2 border rounded-lg peer-checked:bg-slate-800 peer-checked:text-white text-xs font-semibold transition">Opção A</div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="meal-option" value="B" class="peer sr-only">
                                        <div class="text-center py-2 border rounded-lg peer-checked:bg-slate-800 peer-checked:text-white text-xs font-semibold transition">Opção B</div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="meal-option" value="C" class="peer sr-only">
                                        <div class="text-center py-2 border rounded-lg peer-checked:bg-slate-800 peer-checked:text-white text-xs font-semibold transition">Opção C</div>
                                    </label>
                                </div>
                            </div>

                            <!-- BUSCA DE ALIMENTOS -->
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Alimento (TACO/Unicamp)</label>
                                <!-- Input de pesquisa -->
                                <div class="relative mb-2">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <i class="fa-solid fa-search text-slate-400"></i>
                                    </div>
                                    <input type="text" id="search-food" onkeyup="filterFoods()" placeholder="Buscar alimento (ex: arroz, frango)..." class="w-full p-2 pl-10 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none text-sm">
                                </div>
                                
                                <!-- DICA VISUAL PARA CLICAR NA LISTA -->
                                <div id="search-hint" class="hidden bg-blue-50 text-blue-600 text-xs p-2 rounded mb-2 flex items-center gap-2 border border-blue-100 animate-pulse">
                                    <i class="fa-solid fa-arrow-down"></i> Selecione o alimento na lista abaixo:
                                </div>

                                <!-- Select Filtrável -->
                                <select id="select-food" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none custom-scroll text-sm">
                                    <!-- JS Populates -->
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Quantidade</label>
                                <div class="flex gap-2">
                                    <input type="number" id="input-qty" value="100" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none" placeholder="Ex: 100">
                                    <span class="flex items-center bg-slate-100 border border-slate-200 px-3 rounded-lg text-slate-500 text-sm">g/ml</span>
                                </div>
                            </div>

                            <button onclick="addToPlan(); triggerAutoSave();" class="w-full theme-bg theme-bg-hover text-white font-semibold py-3 rounded-lg transition shadow-md flex justify-center items-center gap-2">
                                <i class="fa-solid fa-check"></i> Inserir
                            </button>
                        </div>
                    </div>

                    <!-- 5. Nova Refeição -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700">
                            <i class="fa-solid fa-calendar-plus theme-text"></i> Criar Refeição Extra
                        </h2>
                        <div class="flex gap-2">
                            <input type="text" id="new-meal-name" placeholder="Ex: Pré-Treino..." class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none text-sm">
                            <button onclick="addNewMeal(); triggerAutoSave();" class="bg-slate-800 text-white px-4 rounded-lg hover:bg-slate-700 transition">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 6. Adicionar Novos Alimentos -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700 cursor-pointer" onclick="toggleCustomForm()">
                            <i class="fa-solid fa-pen-to-square text-blue-500"></i> Adicionar Novos Alimentos
                            <i class="fa-solid fa-chevron-down ml-auto text-xs text-slate-400"></i>
                        </h2>
                        
                        <div id="custom-food-form" class="hidden space-y-3 pt-2 border-t border-slate-100">
                            <!-- MENSAGEM DE AVISO -->
                            <div class="bg-amber-50 p-3 rounded-lg text-xs text-amber-800 mb-2 border border-amber-100 leading-relaxed">
                                <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                                <strong>Atenção:</strong> Os alimentos adicionados ficarão salvos no navegador.
                            </div>
                            
                            <input type="text" id="new-name" placeholder="Nome do Alimento" class="w-full p-2 text-sm border rounded">
                            
                            <!-- Novo campo de Porção Base -->
                            <div class="relative">
                                <label class="text-[10px] text-slate-400 uppercase font-bold ml-1">Porção utilizada nos dados abaixo:</label>
                                <div class="flex gap-2 mb-2">
                                    <input type="number" id="new-serving" placeholder="Porção (g)" value="100" class="w-1/3 p-2 text-sm border rounded bg-slate-50 text-center font-semibold">
                                    <span class="flex items-center text-xs text-slate-500">gramas (padrão)</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] text-slate-400 font-bold ml-1">Calorias</label>
                                    <input type="number" id="new-cal" placeholder="Kcal" class="w-full p-2 text-sm border rounded">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 font-bold ml-1">Carboidrato</label>
                                    <input type="number" id="new-carb" placeholder="Carb (g)" class="w-full p-2 text-sm border rounded">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 font-bold ml-1">Proteína</label>
                                    <input type="number" id="new-prot" placeholder="Prot (g)" class="w-full p-2 text-sm border rounded">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 font-bold ml-1">Gordura</label>
                                    <input type="number" id="new-fat" placeholder="Gord (g)" class="w-full p-2 text-sm border rounded">
                                </div>
                                <!-- NOVO CAMPO FIBRAS -->
                                <div class="col-span-2">
                                    <label class="text-[10px] text-slate-400 font-bold ml-1">Fibras</label>
                                    <input type="number" id="new-fiber" placeholder="Fibras (g)" class="w-full p-2 text-sm border rounded">
                                </div>
                            </div>
                            <button onclick="createCustomFood()" class="w-full bg-blue-50 text-blue-600 hover:bg-blue-100 py-2 rounded-lg text-sm font-semibold transition border border-blue-200 mt-2">
                                Salvar no Banco (Permanente)
                            </button>

                            <!-- NOVOS BOTÕES DE BACKUP DE ALIMENTOS -->
                            <div class="mt-4 pt-4 border-t border-slate-100">
                                <p class="text-[10px] text-slate-400 mb-2 italic text-center">Salve sua lista personalizada em um arquivo para não perder seus cadastros.</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="exportFoodBackup()" class="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 py-2 rounded text-xs font-bold transition border border-indigo-200">
                                        <i class="fa-solid fa-download"></i> Baixar Lista
                                    </button>
                                    <button onclick="document.getElementById('food-backup-upload').click()" class="bg-slate-100 text-slate-600 hover:bg-slate-200 py-2 rounded text-xs font-bold transition border border-slate-300">
                                        <i class="fa-solid fa-upload"></i> Restaurar Lista
                                    </button>
                                    <input type="file" id="food-backup-upload" accept=".json" class="hidden" onchange="importFoodBackup(event)">
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-slate-100">
                                 <button onclick="clearCustomFoods()" class="text-xs text-red-400 hover:text-red-600 underline w-full text-center">
                                    Limpar alimentos personalizados salvos
                                 </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUNA DA DIREITA: A Dieta -->
            <div class="lg:col-span-8 space-y-6 w-full">
                <div id="diet-container" class="space-y-6">
                    <!-- Cards renderizados -->
                </div>

                <!-- Metas -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-8 break-inside-avoid">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-lg">
                        <i class="fa-solid fa-bullseye theme-text"></i> Orientações e Recomendações
                    </h3>
                    <div id="goals-area" class="editable-div w-full p-2 bg-transparent text-slate-700 leading-relaxed" contenteditable="true" placeholder="Clique aqui para digitar as metas e orientações..." onblur="triggerAutoSave()"></div>
                </div>

                <!-- Histórico da composição corporal -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-6 break-inside-avoid w-full overflow-hidden">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-lg">
                        <i class="fa-solid fa-weight-scale theme-text"></i> Histórico da composição corporal
                    </h3>
                    <div class="w-full">
                        <table id="history-table" class="w-full text-xs text-center border-collapse border border-slate-300 table-fixed">
                            <thead>
                                <tr class="bg-slate-100 text-slate-700 font-bold">
                                    <th class="measure-cell w-20">Data</th>
                                    <th class="measure-cell">Peso</th>
                                    <th class="measure-cell">Cintura</th>
                                    <th class="measure-cell">Abdômen</th>
                                    <th class="measure-cell">Quadril</th>
                                    <th class="measure-cell">Braço(D/E)</th>
                                    <th class="measure-cell">Perna(D/E)</th>
                                </tr>
                            </thead>
                            <tbody class="text-slate-700">
                                <tr><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td></tr>
                                <tr><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td></tr>
                                <tr><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td></tr>
                                <tr><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td></tr>
                                <tr><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td><td class="measure-cell" contenteditable="true" onblur="triggerAutoSave()"></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Rodapé -->
                <div class="mt-8 pt-8 border-t border-slate-300 flex flex-col md:flex-row justify-between items-center gap-8 text-slate-800 break-inside-avoid">
                    
                    <!-- Dados Profissional (Esquerda - Vertical) -->
                    <div class="w-full md:w-1/2 flex flex-col gap-3 text-left">
                        <input type="text" id="prof-name" class="clean-input text-left font-bold text-lg placeholder-slate-400" placeholder="Nome do Profissional" onkeyup="triggerAutoSave()">
                        
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-xs text-slate-500 w-8">CRN:</span>
                            <input type="text" id="prof-crn" class="clean-input text-left text-sm font-medium placeholder-slate-400 flex-grow" placeholder="00000" onkeyup="triggerAutoSave()">
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <i class="fa-brands fa-whatsapp text-green-600 text-lg w-8 text-center"></i>
                            <input type="text" id="prof-phone" class="clean-input text-left text-sm font-medium placeholder-slate-400 flex-grow" placeholder="(00) 00000-0000" onkeyup="triggerAutoSave()">
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <i class="fa-brands fa-instagram text-pink-600 text-lg w-8 text-center"></i>
                            <input type="text" id="prof-insta" class="clean-input text-left text-sm font-medium placeholder-slate-400 flex-grow" placeholder="@seu.perfil" onkeyup="triggerAutoSave()">
                        </div>
                    </div>

                    <!-- Logo Secundária (Direita) -->
                    <div class="w-full md:w-1/2 flex flex-col items-center md:items-end">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('logo-upload-footer').click()">
                            <img id="logo-img-footer" src="" class="h-24 object-contain hidden">
                            <div id="logo-placeholder-footer" class="w-32 h-24 bg-slate-50 rounded-lg border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400">
                                <i class="fa-solid fa-image text-xl mb-1"></i>
                                <span class="text-[10px]">Logo/Assinatura</span>
                            </div>
                            <span class="text-xs text-blue-500 hover:underline mt-1 block text-center md:text-right no-print">Adicionar Imagem</span>
                            <input type="file" id="logo-upload-footer" accept="image/*" class="hidden" onchange="handleImageUpload(event, 'logo-img-footer', 'logo-placeholder-footer'); triggerAutoSave();">
                        </div>
                    </div>
                </div>

                <!-- Créditos e Fonte (TACO) -->
                <div class="text-center mt-10 pb-4 border-t border-slate-100 pt-4 break-inside-avoid">
                    <p class="text-[10px] text-slate-500 italic mb-1">
                        Alimentos da tabela UNICAMP. Tabela Brasileira de Composição de Alimentos – TACO (4ª Edição)
                    </p>
                    <p class="text-[10px] text-slate-400 font-medium">
                        Criado por Rômulo F. Monteiro <span class="text-blue-400">@romulof.monteiro</span>
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL DE SUBSTITUIÇÃO (ATUALIZADO) -->
    <div id="substitution-modal" class="fixed inset-0 modal-overlay z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-exchange-alt"></i> Encontrar Substituto</h3>
                <button onclick="closeSubModal()" class="text-indigo-200 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-4 bg-indigo-50 border-b border-indigo-100">
                <div id="sub-source-info" class="text-sm text-indigo-900 mb-3 font-medium"></div>
                
                <div class="flex gap-2">
                    <button onclick="filterSubstitutes('carb')" id="btn-sub-carb" class="flex-1 py-2 rounded-lg text-xs font-bold border border-blue-200 bg-white text-blue-600 hover:bg-blue-50 transition shadow-sm">
                        Igualar Carboidrato
                    </button>
                    <button onclick="filterSubstitutes('prot')" id="btn-sub-prot" class="flex-1 py-2 rounded-lg text-xs font-bold border border-emerald-200 bg-white text-emerald-600 hover:bg-emerald-50 transition shadow-sm">
                        Igualar Proteína
                    </button>
                    <button onclick="filterSubstitutes('fat')" id="btn-sub-fat" class="flex-1 py-2 rounded-lg text-xs font-bold border border-yellow-200 bg-white text-yellow-600 hover:bg-yellow-50 transition shadow-sm">
                        Igualar Gordura
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-0">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 font-bold text-xs sticky top-0 border-b bg-white z-10 shadow-sm">
                        <tr>
                            <th class="p-3">Alimento Sugerido</th>
                            <th class="p-3 text-center w-16">Qtd</th>
                            <th class="p-3 text-center w-14 text-[10px]">Dif. Kcal</th>
                            <th class="p-3 text-center w-14 text-[10px]">Dif. Carb</th>
                            <th class="p-3 text-center w-14 text-[10px]">Dif. Prot</th>
                            <th class="p-3 text-center w-14 text-[10px]">Dif. Gord</th>
                            <th class="p-3 text-center w-14 text-[10px]">Dif. Fibras</th> <!-- Nova Coluna Fibras -->
                            <th class="p-3 text-center w-20">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="sub-list" class="divide-y divide-slate-100 text-slate-700">
                        <!-- JS Populate -->
                    </tbody>
                </table>
            </div>
            <div class="p-3 bg-slate-50 border-t text-center text-xs text-slate-400">
                * A quantidade é calculada para atingir o mesmo valor do macronutriente selecionado.
            </div>
        </div>
    </div>

    <!-- MODAL DE PACIENTES -->
    <div id="patient-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-users"></i> Gerenciar Pacientes</h3>
                <button onclick="closePatientModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-4 bg-amber-50 border-b border-amber-100 text-xs text-amber-800 leading-relaxed">
                <div class="flex gap-2">
                    <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
                    <div>
                        <strong>Aviso Importante:</strong> Os dados deste app ficam salvos <u>apenas neste navegador</u>. Se você limpar o cache, usar uma guia anônima ou trocar de computador, os dados não aparecerão.
                        <div class="mt-1 font-bold">Faça Backups regularmente se quiser garantir seus dados!</div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-b border-slate-200 space-y-3">
                <button onclick="createNewPatient()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition">
                    <i class="fa-solid fa-user-plus"></i> Novo Paciente
                </button>
                
                <div class="grid grid-cols-2 gap-3 pt-2 border-t border-slate-200">
                     <button onclick="exportBackup()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-xs font-bold shadow-sm flex items-center justify-center gap-2 transition">
                        <i class="fa-solid fa-download"></i> Baixar Backup
                    </button>
                     <button onclick="document.getElementById('backup-upload').click()" class="bg-slate-600 hover:bg-slate-700 text-white py-2 px-3 rounded-lg text-xs font-bold shadow-sm flex items-center justify-center gap-2 transition">
                        <i class="fa-solid fa-upload"></i> Restaurar Backup
                    </button>
                    <input type="file" id="backup-upload" accept=".json" class="hidden" onchange="importBackup(event)">
                </div>
            </div>

            <div class="p-0 max-h-[50vh] overflow-y-auto custom-scroll">
                <ul id="patient-list" class="divide-y divide-slate-100">
                    <!-- Lista Preenchida via JS -->
                </ul>
                <div id="empty-patients" class="p-8 text-center text-slate-400 text-sm italic hidden">
                    Nenhum paciente salvo.
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3" data-html2canvas-ignore="true">
        <i class="fa-solid fa-circle-check text-emerald-400"></i>
        <span id="toast-msg">Ação realizada</span>
    </div>

    <script>
        // --- FUNÇÃO PARA FECHAR O SPLASH SCREEN ---
        function closeSplash() {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0'; // Inicia o fade-out
            setTimeout(() => {
                splash.style.display = 'none'; // Remove da tela após a transição
            }, 700);
        }

        // --- DADOS DA TABELA TACO (200+ Alimentos) ---
        // Valores por 100g de parte comestível
        // ATUALIZAÇÃO: Campo 'fiber' (Fibras) adicionado
        let foodDatabase = [
            // === CEREAIS, LEGUMINOSAS E DERIVADOS ===
            { id: 101, name: "Arroz Integral, Cozido", cal: 124, carb: 25.8, prot: 2.6, fat: 1.0, fiber: 2.7 },
            { id: 102, name: "Arroz Tipo 1, Cozido", cal: 128, carb: 28.1, prot: 2.5, fat: 0.2, fiber: 1.6 },
            { id: 103, name: "Arroz Tipo 2, Cozido", cal: 130, carb: 28.2, prot: 2.6, fat: 0.4, fiber: 1.1 },
            { id: 104, name: "Aveia, Flocos Crus", cal: 394, carb: 66.6, prot: 13.9, fat: 8.5, fiber: 9.1 },
            { id: 105, name: "Biscoito, Cream Cracker", cal: 432, carb: 68.7, prot: 10.1, fat: 14.4, fiber: 3.5 },
            { id: 106, name: "Biscoito, Maria", cal: 436, carb: 75.2, prot: 7.9, fat: 12.5, fiber: 2.2 },
            { id: 107, name: "Biscoito, Recheado, Chocolate", cal: 472, carb: 70.5, prot: 6.4, fat: 19.6, fiber: 2.0 },
            { id: 108, name: "Bolo, Mistura p/ Preparo, Chocolate", cal: 398, carb: 80.4, prot: 6.2, fat: 5.7, fiber: 2.0 },
            { id: 109, name: "Canjica Branca, Crua", cal: 358, carb: 78.6, prot: 7.2, fat: 1.1, fiber: 4.8 },
            { id: 110, name: "Cereal Matinal, Milho", cal: 377, carb: 83.8, prot: 7.2, fat: 1.2, fiber: 4.1 },
            { id: 111, name: "Creme de Milho, Pó", cal: 337, carb: 80.1, prot: 4.8, fat: 0.8, fiber: 1.0 },
            { id: 112, name: "Curau, Milho Verde", cal: 78, carb: 12.8, prot: 2.3, fat: 2.3, fiber: 0.5 },
            { id: 113, name: "Farinha de Aveia", cal: 404, carb: 69.1, prot: 13.5, fat: 9.1, fiber: 9.0 },
            { id: 114, name: "Farinha de Mandioca, Crua", cal: 361, carb: 87.9, prot: 1.6, fat: 0.3, fiber: 6.4 },
            { id: 115, name: "Farinha de Milho, Amarela", cal: 370, carb: 79.1, prot: 7.2, fat: 1.5, fiber: 5.5 },
            { id: 116, name: "Farinha de Rosca", cal: 371, carb: 75.8, prot: 11.2, fat: 1.5, fiber: 4.8 },
            { id: 117, name: "Farinha de Trigo", cal: 360, carb: 75.1, prot: 9.8, fat: 1.4, fiber: 2.3 },
            { id: 118, name: "Feijão Carioca, Cozido (50% Caldo)", cal: 76, carb: 13.6, prot: 4.8, fat: 0.5, fiber: 8.5 },
            { id: 119, name: "Feijão Fradinho, Cozido", cal: 78, carb: 13.7, prot: 5.1, fat: 0.6, fiber: 7.2 },
            { id: 120, name: "Feijão Preto, Cozido", cal: 77, carb: 14.0, prot: 4.5, fat: 0.5, fiber: 8.4 },
            { id: 121, name: "Grão de Bico, Cozido", cal: 164, carb: 27.4, prot: 8.9, fat: 2.6, fiber: 7.6 },
            { id: 122, name: "Lentilha, Cozida", cal: 93, carb: 16.3, prot: 6.3, fat: 0.5, fiber: 7.9 },
            { id: 123, name: "Macarrão, Trigo, Cozido", cal: 157, carb: 30.9, prot: 5.8, fat: 0.9, fiber: 1.8 },
            { id: 124, name: "Macarrão Instantâneo (Miojo)", cal: 436, carb: 60.1, prot: 8.8, fat: 17.2, fiber: 2.8 },
            { id: 125, name: "Milho Verde, Enlatado, Drenado", cal: 138, carb: 28.6, prot: 3.2, fat: 2.4, fiber: 4.6 },
            { id: 126, name: "Pão de Forma, Integral", cal: 253, carb: 49.9, prot: 9.4, fat: 3.7, fiber: 6.9 },
            { id: 127, name: "Pão de Forma, Tradicional", cal: 269, carb: 53.6, prot: 8.2, fat: 3.3, fiber: 2.5 },
            { id: 128, name: "Pão de Queijo, Assado", cal: 363, carb: 34.0, prot: 5.1, fat: 24.6, fiber: 0.6 },
            { id: 129, name: "Pão Francês", cal: 300, carb: 58.6, prot: 8.0, fat: 3.1, fiber: 2.3 },
            { id: 130, name: "Pipoca, Com Sal e Óleo", cal: 448, carb: 57.1, prot: 9.9, fat: 19.4, fiber: 14.3 },
            { id: 131, name: "Polenta, Cozida", cal: 92, carb: 20.9, prot: 2.2, fat: 0.3, fiber: 1.5 },
            { id: 132, name: "Soja, Cozida", cal: 173, carb: 9.9, prot: 16.6, fat: 8.9, fiber: 6.1 },
            { id: 133, name: "Tapioca, Goma Hidratada", cal: 236, carb: 54.8, prot: 0.0, fat: 0.0, fiber: 0.2 },
            { id: 134, name: "Torrada, Pão Francês", cal: 377, carb: 74.6, prot: 10.5, fat: 3.6, fiber: 3.0 },
            { id: 135, name: "Trigo para Kibe, Cru", cal: 342, carb: 72.9, prot: 11.2, fat: 1.5, fiber: 12.2 },

            // === VERDURAS, LEGUMES E TUBÉRCULOS ===
            { id: 201, name: "Abóbora, Cabotian, Cozida", cal: 48, carb: 10.8, prot: 1.4, fat: 0.7, fiber: 2.5 },
            { id: 202, name: "Abobrinha, Italiana, Cozida", cal: 15, carb: 3.0, prot: 1.1, fat: 0.1, fiber: 1.6 },
            { id: 203, name: "Acelga, Crua", cal: 21, carb: 4.6, prot: 1.4, fat: 0.1, fiber: 1.1 },
            { id: 204, name: "Agrião, Cru", cal: 17, carb: 2.3, prot: 2.7, fat: 0.2, fiber: 2.1 },
            { id: 205, name: "Aipim / Mandioca, Cozida", cal: 125, carb: 30.1, prot: 0.6, fat: 0.3, fiber: 1.6 },
            { id: 206, name: "Aipim, Frito", cal: 300, carb: 50.3, prot: 1.4, fat: 11.2, fiber: 1.9 },
            { id: 207, name: "Alface, Crespa, Crua", cal: 11, carb: 1.7, prot: 1.3, fat: 0.2, fiber: 1.8 },
            { id: 208, name: "Alho, Cru", cal: 113, carb: 23.9, prot: 7.0, fat: 0.2, fiber: 4.3 },
            { id: 209, name: "Batata Doce, Cozida", cal: 77, carb: 18.4, prot: 0.6, fat: 0.1, fiber: 2.2 },
            { id: 210, name: "Batata Inglesa, Cozida", cal: 52, carb: 11.9, prot: 1.2, fat: 0.0, fiber: 1.3 },
            { id: 211, name: "Batata Inglesa, Frita", cal: 267, carb: 35.6, prot: 5.0, fat: 13.1, fiber: 3.5 },
            { id: 212, name: "Berinjela, Cozida", cal: 19, carb: 4.5, prot: 0.7, fat: 0.1, fiber: 2.5 },
            { id: 213, name: "Beterraba, Cozida", cal: 32, carb: 7.2, prot: 1.3, fat: 0.1, fiber: 1.9 },
            { id: 214, name: "Beterraba, Crua", cal: 48, carb: 11.1, prot: 1.6, fat: 0.1, fiber: 3.4 },
            { id: 215, name: "Brócolis, Cozido", cal: 25, carb: 4.4, prot: 2.1, fat: 0.5, fiber: 3.4 },
            { id: 216, name: "Cebola, Crua", cal: 39, carb: 8.9, prot: 1.7, fat: 0.1, fiber: 2.2 },
            { id: 217, name: "Cenoura, Cozida", cal: 30, carb: 6.7, prot: 0.8, fat: 0.2, fiber: 2.6 },
            { id: 218, name: "Cenoura, Crua", cal: 34, carb: 7.7, prot: 1.3, fat: 0.2, fiber: 3.2 },
            { id: 219, name: "Chuchu, Cozido", cal: 19, carb: 4.8, prot: 0.4, fat: 0.0, fiber: 1.2 },
            { id: 220, name: "Couve, Refogada", cal: 90, carb: 8.7, prot: 2.9, fat: 5.7, fiber: 5.7 },
            { id: 221, name: "Couve-Flor, Cozida", cal: 19, carb: 3.9, prot: 1.2, fat: 0.3, fiber: 2.1 },
            { id: 222, name: "Espinafre, Refogado", cal: 67, carb: 4.2, prot: 2.7, fat: 5.4, fiber: 2.5 },
            { id: 223, name: "Inhame, Cozido", cal: 76, carb: 18.1, prot: 1.8, fat: 0.1, fiber: 1.7 },
            { id: 224, name: "Pepino, Cru", cal: 10, carb: 2.0, prot: 0.9, fat: 0.0, fiber: 1.1 },
            { id: 225, name: "Pimentão, Verde, Cru", cal: 21, carb: 4.9, prot: 1.1, fat: 0.2, fiber: 2.6 },
            { id: 226, name: "Quiabo, Cozido", cal: 22, carb: 4.7, prot: 1.4, fat: 0.2, fiber: 1.8 },
            { id: 227, name: "Repolho, Branco, Cru", cal: 17, carb: 3.9, prot: 0.9, fat: 0.1, fiber: 1.9 },
            { id: 228, name: "Rúcula, Crua", cal: 13, carb: 2.2, prot: 1.8, fat: 0.1, fiber: 1.7 },
            { id: 229, name: "Tomate, Salada", cal: 15, carb: 3.1, prot: 1.1, fat: 0.2, fiber: 1.2 },
            { id: 230, name: "Vagem, Cozida", cal: 25, carb: 5.3, prot: 1.8, fat: 0.2, fiber: 1.2 },

            // === FRUTAS ===
            { id: 301, name: "Abacate, Cru", cal: 96, carb: 6.0, prot: 1.2, fat: 8.4, fiber: 6.3 },
            { id: 302, name: "Abacaxi, Cru", cal: 48, carb: 12.3, prot: 0.9, fat: 0.1, fiber: 1.0 },
            { id: 303, name: "Acerola, Crua", cal: 33, carb: 8.0, prot: 0.9, fat: 0.2, fiber: 1.5 },
            { id: 304, name: "Ameixa, Preta, Crua", cal: 53, carb: 13.9, prot: 0.8, fat: 0.0, fiber: 2.4 },
            { id: 305, name: "Banana, Maçã, Crua", cal: 87, carb: 22.3, prot: 1.8, fat: 0.1, fiber: 2.6 },
            { id: 306, name: "Banana, Nanica, Crua", cal: 92, carb: 23.8, prot: 1.4, fat: 0.1, fiber: 1.9 },
            { id: 307, name: "Banana, Prata, Crua", cal: 98, carb: 26.0, prot: 1.3, fat: 0.1, fiber: 2.0 },
            { id: 308, name: "Caju, Cru", cal: 43, carb: 10.3, prot: 1.0, fat: 0.3, fiber: 1.7 },
            { id: 309, name: "Caqui, Chocolate, Cru", cal: 71, carb: 19.3, prot: 0.4, fat: 0.1, fiber: 6.5 },
            { id: 310, name: "Coco, Água de", cal: 22, carb: 5.3, prot: 0.0, fat: 0.0, fiber: 0.1 },
            { id: 311, name: "Coco, Cru", cal: 406, carb: 10.4, prot: 3.7, fat: 42.0, fiber: 5.4 },
            { id: 312, name: "Figo, Cru", cal: 41, carb: 10.2, prot: 1.0, fat: 0.2, fiber: 1.8 },
            { id: 313, name: "Goiaba, Branca, Crua", cal: 52, carb: 12.4, prot: 0.9, fat: 0.5, fiber: 6.3 },
            { id: 314, name: "Goiaba, Vermelha, Crua", cal: 54, carb: 13.0, prot: 1.1, fat: 0.4, fiber: 6.2 },
            { id: 315, name: "Kiwi, Cru", cal: 51, carb: 11.5, prot: 1.3, fat: 0.6, fiber: 2.7 },
            { id: 316, name: "Laranja, Lima, Crua", cal: 39, carb: 9.2, prot: 1.1, fat: 0.1, fiber: 1.8 },
            { id: 317, name: "Laranja, Pera, Crua", cal: 37, carb: 8.9, prot: 1.0, fat: 0.1, fiber: 1.8 },
            { id: 318, name: "Limão, Suco", cal: 29, carb: 11.1, prot: 1.1, fat: 0.0, fiber: 0.0 },
            { id: 319, name: "Maçã, Fuji, Com Casca", cal: 56, carb: 15.2, prot: 0.3, fat: 0.2, fiber: 1.3 },
            { id: 320, name: "Mamão, Formosa, Cru", cal: 45, carb: 11.6, prot: 0.8, fat: 0.1, fiber: 1.8 },
            { id: 321, name: "Mamão, Papaia, Cru", cal: 40, carb: 10.4, prot: 0.5, fat: 0.1, fiber: 1.0 },
            { id: 322, name: "Manga, Palmer, Crua", cal: 72, carb: 19.4, prot: 0.4, fat: 0.2, fiber: 1.6 },
            { id: 323, name: "Maracujá, Polpa, Crua", cal: 68, carb: 12.3, prot: 2.0, fat: 2.1, fiber: 1.1 },
            { id: 324, name: "Melancia, Crua", cal: 33, carb: 8.1, prot: 0.9, fat: 0.0, fiber: 0.1 },
            { id: 325, name: "Melão, Cru", cal: 29, carb: 7.5, prot: 0.7, fat: 0.0, fiber: 0.3 },
            { id: 326, name: "Morango, Cru", cal: 30, carb: 6.8, prot: 0.9, fat: 0.3, fiber: 1.7 },
            { id: 327, name: "Pera, Williams, Crua", cal: 53, carb: 14.0, prot: 0.6, fat: 0.1, fiber: 3.0 },
            { id: 328, name: "Pêssego, Cru", cal: 36, carb: 9.3, prot: 0.8, fat: 0.0, fiber: 1.4 },
            { id: 329, name: "Tangerina/Mexerica, Crua", cal: 38, carb: 9.3, prot: 0.7, fat: 0.1, fiber: 2.7 },
            { id: 330, name: "Uva, Itália, Crua", cal: 53, carb: 13.6, prot: 0.9, fat: 0.2, fiber: 0.9 },

            // === CARNES, PESCADOS E OVOS (Geralmente 0 fibra) ===
            { id: 401, name: "Boi, Acém, Moído, Cozido", cal: 212, carb: 0.0, prot: 26.7, fat: 10.9, fiber: 0 },
            { id: 402, name: "Boi, Alcatra, Grelhada", cal: 241, carb: 0.0, prot: 31.9, fat: 11.6, fiber: 0 },
            { id: 403, name: "Boi, Contrafilé, Grelhado", cal: 278, carb: 0.0, prot: 32.4, fat: 15.5, fiber: 0 },
            { id: 404, name: "Boi, Costela, Assada", cal: 373, carb: 0.0, prot: 28.8, fat: 27.7, fiber: 0 },
            { id: 405, name: "Boi, Coxão Mole, Cozido", cal: 219, carb: 0.0, prot: 32.4, fat: 8.9, fiber: 0 },
            { id: 406, name: "Boi, Filé Mignon, Grelhado", cal: 220, carb: 0.0, prot: 32.8, fat: 8.8, fiber: 0 },
            { id: 407, name: "Boi, Fígado, Grelhado", cal: 225, carb: 4.2, prot: 29.9, fat: 9.0, fiber: 0 },
            { id: 408, name: "Boi, Músculo, Cozido", cal: 194, carb: 0.0, prot: 31.2, fat: 6.7, fiber: 0 },
            { id: 409, name: "Boi, Patinho, Grelhado", cal: 219, carb: 0.0, prot: 35.9, fat: 7.3, fiber: 0 },
            { id: 410, name: "Boi, Picanha, Grelhada", cal: 289, carb: 0.0, prot: 26.4, fat: 19.5, fiber: 0 },
            { id: 411, name: "Frango, Coração, Assado", cal: 207, carb: 0.6, prot: 25.6, fat: 10.9, fiber: 0 },
            { id: 412, name: "Frango, Coxa, Assada (com pele)", cal: 215, carb: 0.1, prot: 27.0, fat: 11.1, fiber: 0 },
            { id: 413, name: "Frango, Peito, Grelhado", cal: 159, carb: 0.0, prot: 32.0, fat: 2.5, fiber: 0 },
            { id: 414, name: "Frango, Sobrecoxa, Assada", cal: 260, carb: 0.0, prot: 23.0, fat: 18.0, fiber: 0 },
            { id: 415, name: "Linguiça, Calabresa, Frita", cal: 380, carb: 1.5, prot: 19.3, fat: 32.5, fiber: 0 },
            { id: 416, name: "Linguiça, Frango, Assada", cal: 236, carb: 1.7, prot: 21.0, fat: 16.0, fiber: 0 },
            { id: 417, name: "Ovo de Codorna, Inteiro", cal: 177, carb: 1.6, prot: 13.7, fat: 12.6, fiber: 0 },
            { id: 418, name: "Ovo de Galinha, Cozido", cal: 146, carb: 0.6, prot: 13.3, fat: 9.5, fiber: 0 },
            { id: 419, name: "Ovo de Galinha, Frito", cal: 240, carb: 1.2, prot: 15.6, fat: 18.6, fiber: 0 },
            { id: 420, name: "Peixe, Atum, Conserva Óleo", cal: 166, carb: 0.0, prot: 26.2, fat: 6.0, fiber: 0 },
            { id: 421, name: "Peixe, Bacalhau, Assado", cal: 110, carb: 0.0, prot: 24.0, fat: 1.2, fiber: 0 },
            { id: 422, name: "Peixe, Cação, Cozido", cal: 116, carb: 0.0, prot: 25.6, fat: 0.7, fiber: 0 },
            { id: 423, name: "Peixe, Merluza, Filé, Assado", cal: 122, carb: 0.0, prot: 26.6, fat: 0.9, fiber: 0 },
            { id: 424, name: "Peixe, Salmão, Grelhado", cal: 229, carb: 0.0, prot: 24.0, fat: 14.0, fiber: 0 },
            { id: 425, name: "Peixe, Sardinha, Assada", cal: 164, carb: 0.0, prot: 32.2, fat: 3.0, fiber: 0 },
            { id: 426, name: "Peixe, Tilápia, Grelhada", cal: 128, carb: 0.0, prot: 26.1, fat: 2.7, fiber: 0 },
            { id: 427, name: "Porco, Bisteca, Grelhada", cal: 280, carb: 0.0, prot: 28.6, fat: 17.4, fiber: 0 },
            { id: 428, name: "Porco, Lombo, Assado", cal: 210, carb: 0.0, prot: 35.7, fat: 6.4, fiber: 0 },
            { id: 429, name: "Presunto, Cozido", cal: 120, carb: 1.0, prot: 16.5, fat: 5.5, fiber: 0 },
            { id: 430, name: "Salsicha, Cozida", cal: 246, carb: 2.0, prot: 13.0, fat: 21.0, fiber: 0 },

            // === LEITE E DERIVADOS (Geralmente 0 fibra) ===
            { id: 501, name: "Creme de Leite", cal: 221, carb: 4.5, prot: 1.5, fat: 22.0, fiber: 0 },
            { id: 502, name: "Iogurte, Natural", cal: 51, carb: 5.3, prot: 4.1, fat: 3.0, fiber: 0 },
            { id: 503, name: "Iogurte, Natural, Desnatado", cal: 41, carb: 6.8, prot: 3.8, fat: 0.1, fiber: 0 },
            { id: 504, name: "Iogurte, Sabor Morango", cal: 70, carb: 12.5, prot: 2.7, fat: 1.2, fiber: 0 },
            { id: 505, name: "Leite, Condensado", cal: 313, carb: 57.0, prot: 7.7, fat: 6.0, fiber: 0 },
            { id: 506, name: "Leite, Fermentado (Yakult)", cal: 72, carb: 15.0, prot: 2.0, fat: 0.0, fiber: 0 },
            { id: 507, name: "Leite, Vaca, Desnatado", cal: 35, carb: 4.7, prot: 3.1, fat: 0.5, fiber: 0 },
            { id: 508, name: "Leite, Vaca, Desnatado, Pó", cal: 362, carb: 51.6, prot: 34.7, fat: 0.9, fiber: 0 },
            { id: 509, name: "Leite, Vaca, Integral", cal: 60, carb: 4.5, prot: 3.2, fat: 3.0, fiber: 0 },
            { id: 510, name: "Leite, Vaca, Integral, Pó", cal: 497, carb: 39.2, prot: 25.4, fat: 26.7, fiber: 0 },
            { id: 511, name: "Manteiga, Com Sal", cal: 726, carb: 0.1, prot: 0.4, fat: 82.0, fiber: 0 },
            { id: 512, name: "Queijo, Minas, Frescal", cal: 264, carb: 3.2, prot: 17.4, fat: 20.2, fiber: 0 },
            { id: 513, name: "Queijo, Mussarela", cal: 328, carb: 3.0, prot: 22.6, fat: 25.2, fiber: 0 },
            { id: 514, name: "Queijo, Parmesão", cal: 453, carb: 1.7, prot: 35.6, fat: 33.5, fiber: 0 },
            { id: 515, name: "Queijo, Prato", cal: 360, carb: 1.9, prot: 22.7, fat: 29.1, fiber: 0 },
            { id: 516, name: "Queijo, Ricota", cal: 140, carb: 3.8, prot: 12.6, fat: 8.1, fiber: 0 },
            { id: 517, name: "Requeijão, Cremoso", cal: 308, carb: 2.4, prot: 9.6, fat: 28.9, fiber: 0 },

            // === ÓLEOS, GORDURAS E OLEAGINOSAS ===
            { id: 601, name: "Amendoim, Torrado", cal: 606, carb: 18.7, prot: 22.5, fat: 54.0, fiber: 8.0 },
            { id: 602, name: "Azeite de Dendê", cal: 884, carb: 0.0, prot: 0.0, fat: 100.0, fiber: 0 },
            { id: 603, name: "Azeite de Oliva, Extra Virgem", cal: 884, carb: 0.0, prot: 0.0, fat: 100.0, fiber: 0 },
            { id: 604, name: "Bacon, Frito", cal: 697, carb: 0.0, prot: 33.0, fat: 60.3, fiber: 0 },
            { id: 605, name: "Castanha de Caju, Torrada", cal: 570, carb: 32.9, prot: 18.5, fat: 46.3, fiber: 3.7 },
            { id: 606, name: "Castanha do Brasil (Pará)", cal: 643, carb: 15.1, prot: 14.5, fat: 63.5, fiber: 7.9 },
            { id: 607, name: "Margarina, Com Sal", cal: 723, carb: 0.0, prot: 0.0, fat: 81.7, fiber: 0 },
            { id: 608, name: "Maionese, Industrializada", cal: 302, carb: 7.6, prot: 0.6, fat: 30.5, fiber: 0 },
            { id: 609, name: "Noz, Crua", cal: 620, carb: 18.4, prot: 14.0, fat: 59.4, fiber: 7.2 },
            { id: 610, name: "Óleo de Milho", cal: 884, carb: 0.0, prot: 0.0, fat: 100.0, fiber: 0 },
            { id: 611, name: "Óleo de Soja", cal: 884, carb: 0.0, prot: 0.0, fat: 100.0, fiber: 0 },
            { id: 701, name: "Achocolatado, Pó", cal: 401, carb: 90.0, prot: 2.0, fat: 2.3, fiber: 2.5 },
            { id: 702, name: "Açúcar, Mascavo", cal: 369, carb: 95.5, prot: 0.8, fat: 0.0, fiber: 0 },
            { id: 703, name: "Açúcar, Refinado", cal: 387, carb: 99.5, prot: 0.3, fat: 0.0, fiber: 0 },
            { id: 704, name: "Café, Infusão (Sem açúcar)", cal: 2, carb: 0.3, prot: 0.3, fat: 0.1, fiber: 0 },
            { id: 705, name: "Chocolate, Ao Leite", cal: 540, carb: 59.6, prot: 7.2, fat: 29.7, fiber: 1.0 },
            { id: 706, name: "Chocolate, Meio Amargo", cal: 475, carb: 55.0, prot: 5.0, fat: 30.0, fiber: 5.0 },
            { id: 707, name: "Cocada, Branca", cal: 440, carb: 65.0, prot: 2.0, fat: 18.0, fiber: 4.0 },
            { id: 708, name: "Doce de Leite", cal: 306, carb: 55.0, prot: 6.0, fat: 7.0, fiber: 0 },
            { id: 709, name: "Geleia, Mocotó", cal: 176, carb: 36.6, prot: 6.4, fat: 0.1, fiber: 0 },
            { id: 710, name: "Goiabada", cal: 294, carb: 74.0, prot: 0.5, fat: 0.1, fiber: 0.6 },
            { id: 711, name: "Mel de Abelha", cal: 309, carb: 84.0, prot: 0.3, fat: 0.0, fiber: 0 },
            { id: 712, name: "Refrigerante, Coca-Cola", cal: 42, carb: 10.5, prot: 0.0, fat: 0.0, fiber: 0 },
            { id: 713, name: "Refrigerante, Guaraná", cal: 40, carb: 10.0, prot: 0.0, fat: 0.0, fiber: 0 },
            { id: 714, name: "Suco de Laranja, Natural", cal: 45, carb: 10.5, prot: 0.7, fat: 0.2, fiber: 0.1 },
            { id: 715, name: "Suco de Uva, Concentrado", cal: 58, carb: 14.7, prot: 0.0, fat: 0.0, fiber: 0.2 },
            { id: 716, name: "Vinho, Tinto", cal: 65, carb: 0.2, prot: 0.0, fat: 0.0, fiber: 0 }
        ];

        // Default Meals Structure
        const defaultMeals = [
            { id: 1, title: "Café da Manhã (Desjejum)", foods: [], observation: "" },
            { id: 2, title: "Lanche da Manhã (Colação)", foods: [], observation: "" },
            { id: 3, title: "Almoço", foods: [], observation: "" },
            { id: 4, title: "Lanche da Tarde", foods: [], observation: "" },
            { id: 5, title: "Jantar", foods: [], observation: "" },
            { id: 6, title: "Ceia", foods: [], observation: "" }
        ];

        let dietMeals = JSON.parse(JSON.stringify(defaultMeals));
        let currentTheme = 'emerald';
        let showGoals = true;
        let currentPatientId = null;
        let saveTimeout;
        let currentSubMealId = null;
        let currentSubFoodIndex = null;

        const themes = {
            emerald: { primary: '#059669', hover: '#047857', light: '#ecfdf5', text: '#065f46', border: '#d1fae5' },
            blue: { primary: '#2563eb', hover: '#1d4ed8', light: '#eff6ff', text: '#1e40af', border: '#dbeafe' },
            indigo: { primary: '#4f46e5', hover: '#4338ca', light: '#eef2ff', text: '#3730a3', border: '#e0e7ff' },
            rose: { primary: '#e11d48', hover: '#be123c', light: '#fff1f2', text: '#9f1239', border: '#ffe4e6' },
            amber: { primary: '#d97706', hover: '#b45309', light: '#fffbeb', text: '#92400e', border: '#fef3c7' },
            purple: { primary: '#9333ea', hover: '#7e22ce', light: '#f3e8ff', text: '#6b21a8', border: '#e9d5ff' },
            cyan: { primary: '#06b6d4', hover: '#0891b2', light: '#ecfeff', text: '#155e75', border: '#cffafe' },
            teal: { primary: '#14b8a6', hover: '#0d9488', light: '#f0fdfa', text: '#115e59', border: '#ccfbf1' },
            lime: { primary: '#84cc16', hover: '#65a30d', light: '#f7fee7', text: '#3f6212', border: '#d9f99d' },
            fuchsia: { primary: '#d946ef', hover: '#c026d3', light: '#fdf4ff', text: '#86198f', border: '#f0abfc' }
        };

        function init() {
            loadCustomFoodsFromStorage();
            const dateInput = document.getElementById('diet-date');
            if(dateInput) {
                dateInput.valueAsDate = new Date();
                updateDateDisplay();
            }
            
            const lastPatientId = localStorage.getItem('diet_last_patient_id');
            let loaded = false;
            
            if (lastPatientId) {
                loaded = loadPatient(lastPatientId);
            } 
            
            if (!loaded) {
                createNewPatient();
            }
            renderFoodSelect();
        }

        // ==========================================
        // === SISTEMA DE EDITAR MACROS NA TABELA ===
        // ==========================================

        function updateFoodMacro(mealId, foodIndex, type, newValue) {
            const meal = dietMeals.find(m => m.id === mealId);
            if (!meal || !meal.foods[foodIndex]) return;

            const food = meal.foods[foodIndex];
            const val = parseFloat(newValue.replace(/[^0-9.]/g, '')); // Remove 'kcal', 'g'

            if (isNaN(val)) return; // Se não for número, ignora

            // Atualiza o valor total naquela entrada específica
            if (type === 'cal') food.totalCal = val;
            if (type === 'carb') food.totalCarb = val;
            if (type === 'prot') food.totalProt = val;
            if (type === 'fat') food.totalFat = val;
            if (type === 'fiber') food.totalFiber = val; // Agora editável

            // --- LÓGICA DE INTELIGÊNCIA ---
            // Se o usuário mudou o total manualmente, devemos atualizar a BASE (kcal por 100g)
            // para que se ele mudar a quantidade depois, a proporção se mantenha correta.
            if (food.qty > 0) {
                const factor = food.qty / 100;
                if (type === 'cal') food.cal = val / factor;
                if (type === 'carb') food.carb = val / factor;
                if (type === 'prot') food.prot = val / factor;
                if (type === 'fat') food.fat = val / factor;
                if (type === 'fiber') food.fiber = val / factor;
            }

            renderDiet();
            triggerAutoSave();
            showToast("Valor atualizado", "neutral");
        }

        
        function exportBackup() {
            const backup = {
                meta: { date: new Date().toISOString(), version: '1.0' },
                patientsList: localStorage.getItem('diet_patients_list'),
                customFoods: localStorage.getItem('dietCustomFoods'),
                patientData: {}
            };
            const list = getPatientsList();
            list.forEach(p => {
                const key = 'diet_data_' + p.id;
                backup.patientData[key] = localStorage.getItem(key);
            });
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const dateStr = new Date().toISOString().slice(0,10);
            downloadAnchorNode.setAttribute("download", `backup_dietas_${dateStr}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if(!backup.meta || !backup.patientsList) throw new Error("Formato inválido.");
                    if(confirm("Restaurar backup substituirá dados atuais. Continuar?")) {
                        if(backup.patientsList) localStorage.setItem('diet_patients_list', backup.patientsList);
                        if(backup.customFoods) localStorage.setItem('dietCustomFoods', backup.customFoods);
                        if(backup.patientData) {
                            for (const [key, value] of Object.entries(backup.patientData)) {
                                if(value) localStorage.setItem(key, value);
                            }
                        }
                        alert("Backup restaurado!");
                        location.reload();
                    }
                } catch (err) { alert("Erro: " + err.message); }
            };
            reader.readAsText(file);
        }
        
        // --- FUNÇÕES DE BACKUP DE ALIMENTOS ---
        function exportFoodBackup() {
            const foods = localStorage.getItem('dietCustomFoods');
            if(!foods) return showToast("Nenhum alimento personalizado para salvar.", "error");
            
            const backup = { foods: foods, type: "food_backup" };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const dateStr = new Date().toISOString().slice(0,10);
            downloadAnchorNode.setAttribute("download", `meus_alimentos_${dateStr}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importFoodBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if(backup.type !== "food_backup" && !Array.isArray(JSON.parse(backup.foods || "[]"))) throw new Error("Formato inválido.");
                    
                    if(confirm("Isso irá adicionar os alimentos do arquivo à sua lista atual. Continuar?")) {
                        const newFoods = JSON.parse(backup.foods);
                        const currentFoods = JSON.parse(localStorage.getItem('dietCustomFoods') || "[]");
                        // Merge avoiding exact duplicates by ID
                        const merged = [...currentFoods];
                        newFoods.forEach(nf => {
                            if(!merged.find(cf => cf.id === nf.id)) merged.push(nf);
                        });
                        
                        localStorage.setItem('dietCustomFoods', JSON.stringify(merged));
                        alert("Alimentos restaurados com sucesso!");
                        location.reload();
                    }
                } catch (err) { alert("Erro ao importar: O arquivo não parece ser um backup de alimentos."); }
            };
            reader.readAsText(file);
        }

        function getPatientsList() {
            const list = localStorage.getItem('diet_patients_list');
            return list ? JSON.parse(list) : [];
        }
        function savePatientsList(list) { localStorage.setItem('diet_patients_list', JSON.stringify(list)); }
        
        function openPatientModal() {
            const list = getPatientsList();
            const ul = document.getElementById('patient-list');
            ul.innerHTML = '';
            if (list.length === 0) {
                document.getElementById('empty-patients').classList.remove('hidden');
            } else {
                document.getElementById('empty-patients').classList.add('hidden');
                list.forEach(p => {
                    const isActive = p.id === currentPatientId;
                    const date = new Date(p.lastModified).toLocaleDateString('pt-BR');
                    const li = document.createElement('li');
                    li.className = `p-3 flex justify-between items-center hover:bg-slate-100 transition cursor-pointer ${isActive ? 'bg-blue-50 border-l-4 border-blue-500' : ''}`;
                    li.onclick = (e) => { if(!e.target.closest('button')) loadPatient(p.id); };
                    li.innerHTML = `<div><div class="font-bold text-slate-800">${p.name}</div><div class="text-[10px] text-slate-400">Mod: ${date}</div></div><div class="flex gap-2">${isActive ? '<span class="text-xs text-blue-500 font-bold px-2 py-1 bg-blue-100 rounded">Ativo</span>' : ''}<button onclick="deletePatient('${p.id}')" class="text-slate-300 hover:text-red-500 p-2 transition"><i class="fa-solid fa-trash"></i></button></div>`;
                    ul.appendChild(li);
                });
            }
            document.getElementById('patient-modal').classList.remove('hidden');
        }
        function closePatientModal() { document.getElementById('patient-modal').classList.add('hidden'); }

        function createNewPatient() {
            currentPatientId = 'pat_' + Date.now();
            dietMeals = JSON.parse(JSON.stringify(defaultMeals));
            currentTheme = 'emerald';
            document.getElementById('patient-name').value = "Novo Paciente";
            document.getElementById('patient-goal').value = "";
            document.getElementById('diet-date').valueAsDate = new Date();
            document.getElementById('logo-img-main').classList.add('hidden');
            document.getElementById('logo-placeholder').classList.remove('hidden');
            document.getElementById('logo-img-footer').classList.add('hidden');
            document.getElementById('logo-placeholder-footer').classList.remove('hidden');
            document.getElementById('target-cal').value = 2000;
            document.getElementById('target-fiber').value = 25; // Reset default fiber
            document.getElementById('calc-weight').value = "";
            document.getElementById('calc-height').value = "";
            document.getElementById('calc-age').value = "";
            document.getElementById('goals-area').innerText = "";
            document.querySelectorAll('#history-table td').forEach(c => c.innerText = "");
            
            saveCurrentPatientState();
            renderMealSelect(); renderDiet(); setTheme('emerald'); closePatientModal(); showToast("Novo paciente criado!");
        }

        function deletePatient(id) {
            if(!confirm("Apagar paciente?")) return;
            let list = getPatientsList().filter(p => p.id !== id);
            savePatientsList(list);
            localStorage.removeItem('diet_data_' + id);
            if(id === currentPatientId) createNewPatient();
            else openPatientModal();
        }

        function loadPatient(id) {
            const d = localStorage.getItem('diet_data_' + id);
            if (!d) return false;
            
            try {
                const data = JSON.parse(d);
                currentPatientId = id;
                
                // --- FIX: Ensure meals structure is valid ---
                if (!data.meals || !Array.isArray(data.meals) || data.meals.length === 0) {
                    dietMeals = JSON.parse(JSON.stringify(defaultMeals));
                } else {
                    dietMeals = data.meals;
                }
                
                currentTheme = data.theme || 'emerald';
                
                // Added target-fiber to fields
                const fields = ['patient-name','patient-goal','diet-date','prof-name','prof-crn','prof-phone','prof-insta','calc-weight','calc-height','calc-age','calc-bf','target-cal','target-carb-pct','target-prot-pct','target-fat-pct', 'target-fiber'];
                fields.forEach(f => { if(document.getElementById(f) && data.inputs[f]!==undefined) document.getElementById(f).value = data.inputs[f]; });
                
                if(data.selects) {
                    document.getElementById('calc-formula').value = data.selects['calc-formula'] || 'mifflin';
                    document.getElementById('calc-activity').value = data.selects['calc-activity'] || '1.55';
                    const rad = document.querySelector(`input[name="calc-sex"][value="${data.selects['calc-sex']}"]`);
                    if(rad) rad.checked = true;
                }
                if(data.images) {
                    const setImg = (id, phId, src) => {
                        if(src) { document.getElementById(id).src=src; document.getElementById(id).classList.remove('hidden'); document.getElementById(phId).classList.add('hidden'); }
                        else { document.getElementById(id).classList.add('hidden'); document.getElementById(phId).classList.remove('hidden'); }
                    };
                    setImg('logo-img-main', 'logo-placeholder', data.images.mainLogo);
                    setImg('logo-img-footer', 'logo-placeholder-footer', data.images.footerLogo);
                }
                if(data.history) {
                    const rows = document.querySelectorAll('#history-table tbody tr');
                    data.history.forEach((r,i) => { if(rows[i]) rows[i].querySelectorAll('td').forEach((c,j) => c.innerText = r[j]||""); });
                }
                if(data.goalsText) document.getElementById('goals-area').innerText = data.goalsText;

                setTheme(currentTheme); renderMealSelect(); renderDiet(); calculateEnergy(); updateDateDisplay(); toggleBodyFatInput();
                localStorage.setItem('diet_last_patient_id', id);
                closePatientModal(); showToast("Paciente carregado!");
                return true;
            } catch (e) {
                return false;
            }
        }

        function triggerAutoSave() { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveCurrentPatientState, 1000); }
        function saveCurrentPatientState() {
            if (!currentPatientId) return;
            const inputs = {};
            // Added target-fiber
            ['patient-name','patient-goal','diet-date','prof-name','prof-crn','prof-phone','prof-insta','calc-weight','calc-height','calc-age','calc-bf','target-cal','target-carb-pct','target-prot-pct','target-fat-pct', 'target-fiber'].forEach(f => inputs[f] = document.getElementById(f).value);
            
            const history = [];
            document.querySelectorAll('#history-table tbody tr').forEach(r => {
                const row = []; r.querySelectorAll('td').forEach(c => row.push(c.innerText)); history.push(row);
            });

            const data = {
                id: currentPatientId, lastModified: Date.now(), theme: currentTheme, inputs, history, meals: dietMeals,
                goalsText: document.getElementById('goals-area').innerText,
                selects: { 'calc-formula': document.getElementById('calc-formula').value, 'calc-activity': document.getElementById('calc-activity').value, 'calc-sex': document.querySelector('input[name="calc-sex"]:checked').value },
                images: { mainLogo: document.getElementById('logo-img-main').src.includes('data:') ? document.getElementById('logo-img-main').src : null, footerLogo: document.getElementById('logo-img-footer').src.includes('data:') ? document.getElementById('logo-img-footer').src : null }
            };
            localStorage.setItem('diet_data_' + currentPatientId, JSON.stringify(data));
            
            let list = getPatientsList();
            const idx = list.findIndex(p => p.id === currentPatientId);
            const meta = { id: currentPatientId, name: inputs['patient-name'] || "Sem Nome", lastModified: Date.now() };
            if (idx >= 0) list[idx] = meta; else list.push(meta);
            savePatientsList(list);
            const lbl = document.getElementById('current-patient-label'); if(lbl) lbl.innerText = inputs['patient-name'] || "Pacientes";
        }

        function toggleBodyFatInput() {
            const f = document.getElementById('calc-formula').value;
            if(f==='tinsley_katch'||f==='cunningham') document.getElementById('bf-container').classList.remove('hidden');
            else document.getElementById('bf-container').classList.add('hidden');
        }
        function calculateEnergy() {
            const w = parseFloat(document.getElementById('calc-weight').value)||0, h = parseFloat(document.getElementById('calc-height').value)||0, a = parseFloat(document.getElementById('calc-age').value)||0, bf = parseFloat(document.getElementById('calc-bf').value)||0, act = parseFloat(document.getElementById('calc-activity').value)||1.2, s = document.querySelector('input[name="calc-sex"]:checked').value, f = document.getElementById('calc-formula').value;
            
            if(w>0 && h>0) document.getElementById('res-bmi').innerText = (w/((h/100)*(h/100))).toFixed(1);
            else document.getElementById('res-bmi').innerText = '--';

            let bmr = 0;
            if(w>0) {
                if(f==='mifflin' && h>0 && a>0) bmr = (10*w) + (6.25*h) - (5*a) + (s==='m'?5:-161);
                else if(f==='harris' && h>0 && a>0) bmr = s==='m' ? 88.362+(13.397*w)+(4.799*h)-(5.677*a) : 447.593+(9.247*w)+(3.098*h)-(4.330*a);
                else if(f==='tinsley_ph' && h>0) bmr = (9.65*w) + (573*(h/100)) - (s==='m'?5.08:4.92);
                else if((f==='tinsley_katch'||f==='cunningham') && bf>0) { const mlg = w*(1-(bf/100)); bmr = f==='cunningham' ? 500+(22*mlg) : 370+(21.6*mlg); }
            }
            if(bmr>0) { document.getElementById('res-bmr').innerText = bmr.toFixed(0)+' kcal'; document.getElementById('res-tdee').innerText = (bmr*act).toFixed(0)+' kcal'; }
            else { document.getElementById('res-bmr').innerText = '--'; document.getElementById('res-tdee').innerText = '--'; }
        }

        // --- MANIPULAÇÃO DE DADOS ---
        function addNewMeal() {
            const n = document.getElementById('new-meal-name').value.trim();
            if(!n) return showToast("Nome vazio","error");
            dietMeals.push({ id: Date.now(), title: n, foods: [], observation: "" });
            document.getElementById('new-meal-name').value=''; renderMealSelect(); renderDiet(); showToast("Criada!");
        }
        function deleteMeal(id) { if(confirm("Apagar refeição?")) { dietMeals = dietMeals.filter(m=>m.id!==id); renderMealSelect(); renderDiet(); triggerAutoSave(); } }
        function duplicateMeal(id) {
            const idx = dietMeals.findIndex(m=>m.id===id); if(idx===-1)return;
            const c = JSON.parse(JSON.stringify(dietMeals[idx])); c.id=Date.now(); c.title+=' (Cópia)';
            dietMeals.splice(idx+1,0,c); renderDiet(); renderMealSelect(); triggerAutoSave();
        }
        function moveMeal(i, d) {
            if((d===-1&&i>0)||(d===1&&i<dietMeals.length-1)) { [dietMeals[i], dietMeals[i+d]] = [dietMeals[i+d], dietMeals[i]]; renderDiet(); renderMealSelect(); triggerAutoSave(); }
        }
        function updateMealTitle(id, v) { const m=dietMeals.find(x=>x.id===id); if(m){ m.title=v.trim(); renderMealSelect(); triggerAutoSave(); } }
        function updateMealObservation(id, v) { const m=dietMeals.find(x=>x.id===id); if(m){ m.observation=v; triggerAutoSave(); } }
        function clearMealObservation(id) { const m=dietMeals.find(x=>x.id===id); if(m && confirm("Limpar obs?")) { m.observation=""; renderDiet(); triggerAutoSave(); } }
        
        function renderMealSelect() {
            const s = document.getElementById('select-meal'); const old = s.value; s.innerHTML='';
            dietMeals.forEach(m => { const o=document.createElement('option'); o.value=m.id; o.text=m.title; s.appendChild(o); });
            if(old) s.value=old;
        }

        function renderFoodSelect(ft="") {
            const s = document.getElementById('select-food'); s.innerHTML='';
            let list = [...foodDatabase].sort((a,b)=>a.name.localeCompare(b.name));
            if(ft) list = list.filter(f=>f.name.toLowerCase().includes(ft.toLowerCase()));
            
            if(list.length===0) { const o=document.createElement('option'); o.text="Sem resultados"; s.appendChild(o); s.disabled=true; return; }
            s.disabled=false;
            list.forEach(f => { const o=document.createElement('option'); o.value=f.id; o.text=`${f.isCustom?'★ ':''}${f.name} (${f.cal.toFixed(0)}kcal)`; s.appendChild(o); });
            if(list.length>0) s.value=list[0].id;
        }
        function filterFoods() { const v=document.getElementById('search-food').value; renderFoodSelect(v); document.getElementById('search-hint').classList.toggle('hidden', v.length===0); }

        function updateFoodName(mid, fid, v) { const m=dietMeals.find(x=>x.id===mid); if(m&&m.foods[fid]) { m.foods[fid].name=v.trim(); triggerAutoSave(); } }
        function updateFoodQty(mid, fid, v) {
            const m=dietMeals.find(x=>x.id===mid); if(!m||!m.foods[fid]) return;
            const q=parseFloat(v); if(isNaN(q)||q<=0) return;
            const f=m.foods[fid], fac=q/100;
            f.qty=q; f.totalCal=f.cal*fac; f.totalCarb=f.carb*fac; f.totalProt=f.prot*fac; f.totalFat=f.fat*fac; 
            // Update Fiber too
            f.totalFiber=(f.fiber||0)*fac;
            renderDiet(); triggerAutoSave();
        }
        function moveFood(mid, fid, d) {
            const m=dietMeals.find(x=>x.id===mid); if(!m)return;
            const ni=fid+d; if(ni>=0 && ni<m.foods.length) { [m.foods[fid], m.foods[ni]] = [m.foods[ni], m.foods[fid]]; renderDiet(); triggerAutoSave(); }
        }
        function removeFood(mid, fid) { const m=dietMeals.find(x=>x.id===mid); if(m) { m.foods.splice(fid,1); renderDiet(); triggerAutoSave(); } }
        function removeGoals() { showGoals=false; renderDiet(); }

        // --- SISTEMA DE SUBSTITUIÇÃO (NOVO) ---
        let currentSubSource = null;
        function openSubstitutionModal(mealId, foodIndex) {
            currentSubMealId = mealId; // Salva contexto
            currentSubFoodIndex = foodIndex; // Salva contexto
            const meal = dietMeals.find(m => m.id === mealId);
            if (!meal || !meal.foods[foodIndex]) return;
            const f = meal.foods[foodIndex];
            
            currentSubSource = {
                name: f.name,
                cal: f.totalCal,
                carb: f.totalCarb,
                prot: f.totalProt,
                fat: f.totalFat,
                fiber: f.totalFiber || 0 // Incluindo Fibra
            };
            
            document.getElementById('sub-source-info').innerHTML = `
                Alimento Base: <span class="text-black font-bold">${f.name}</span> (${f.qty}g)<br>
                <div class="grid grid-cols-5 gap-2 mt-1 text-xs text-slate-500">
                    <span>Kcal: ${f.totalCal.toFixed(0)}</span>
                    <span>C: ${f.totalCarb.toFixed(1)}g</span>
                    <span>P: ${f.totalProt.toFixed(1)}g</span>
                    <span>G: ${f.totalFat.toFixed(1)}g</span>
                    <span>F: ${(f.totalFiber||0).toFixed(1)}g</span>
                </div>
            `;
            
            // Default filter: Carb or Cal
            filterSubstitutes('carb');
            document.getElementById('substitution-modal').classList.remove('hidden');
        }
        
        function closeSubModal() { document.getElementById('substitution-modal').classList.add('hidden'); }
        
        function confirmSubstitution(newId, newQty) {
            const m = dietMeals.find(x => x.id === currentSubMealId);
            if(!m || !m.foods[currentSubFoodIndex]) return;

            const oldFood = m.foods[currentSubFoodIndex];
            const newFoodDb = foodDatabase.find(f => f.id === newId);

            if(!newFoodDb) return;

            const fac = newQty / 100;

            // Construct new food object with calculated macros
            const newFoodObj = {
                ...newFoodDb, // id, name, cal (base), carb (base), etc.
                qty: newQty,
                option: oldFood.option, // Keep original option (A, B, C)
                totalCal: newFoodDb.cal * fac,
                totalCarb: newFoodDb.carb * fac,
                totalProt: newFoodDb.prot * fac,
                totalFat: newFoodDb.fat * fac,
                totalFiber: (newFoodDb.fiber||0) * fac
            };

            // Replace in array
            m.foods[currentSubFoodIndex] = newFoodObj;

            renderDiet();
            triggerAutoSave();
            closeSubModal();
            showToast("Alimento substituído com sucesso!");
        }

        function filterSubstitutes(macro) {
            const tbody = document.getElementById('sub-list');
            tbody.innerHTML = '';
            
            // Highlight active button
            ['carb','prot','fat'].forEach(m => {
                const btn = document.getElementById('btn-sub-'+m);
                if(m === macro) btn.classList.add('ring-2', 'ring-offset-1');
                else btn.classList.remove('ring-2', 'ring-offset-1');
            });
            
            const targetVal = currentSubSource[macro];
            
            if (targetVal <= 0.5) {
                tbody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-slate-400">O alimento base tem quase 0g deste nutriente.</td></tr>`;
                return;
            }

            // Helper for diff styling
            const formatDiff = (val) => {
                const v = Math.round(val);
                const sign = v > 0 ? '+' : '';
                // Simple color logic for diffs
                let color = 'text-slate-400';
                if(v > 2) color = 'text-red-500 font-bold'; 
                else if(v < -2) color = 'text-emerald-600 font-bold';
                return `<span class="${color} text-[10px] font-mono whitespace-nowrap">${sign}${v}</span>`;
            };

            // Find candidates
            const candidates = foodDatabase.map(f => {
                // macro content per 1g of product
                const contentPerGram = f[macro] / 100;
                
                if (contentPerGram <= 0) return null;
                
                // Qty needed to match targetVal
                const neededQty = targetVal / contentPerGram;
                
                // Calculate resulting Macros of this substitute portion
                const resultingCal = (f.cal / 100) * neededQty;
                const resultingCarb = (f.carb / 100) * neededQty;
                const resultingProt = (f.prot / 100) * neededQty;
                const resultingFat = (f.fat / 100) * neededQty;
                const resultingFiber = ((f.fiber||0) / 100) * neededQty;

                const diffs = {
                    cal: resultingCal - currentSubSource.cal,
                    carb: resultingCarb - currentSubSource.carb,
                    prot: resultingProt - currentSubSource.prot,
                    fat: resultingFat - currentSubSource.fat,
                    fiber: resultingFiber - currentSubSource.fiber
                };
                
                return {
                    id: f.id,
                    name: f.name,
                    qty: neededQty,
                    diffs: diffs,
                    // Use Calorie diff as sorting metric (keep diet balanced)
                    sortMetric: Math.abs(diffs.cal)
                };
            }).filter(x => x !== null);
            
            // Sort by lowest Calorie Difference to keep diet balanced
            candidates.sort((a,b) => a.sortMetric - b.sortMetric);
            
            // Show top 20
            candidates.slice(0, 20).forEach(c => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-50";
                
                // CORREÇÃO: Arredondar a quantidade para inteiro antes de usar
                const roundedQty = Math.round(c.qty);

                tr.innerHTML = `
                    <td class="p-3 font-medium text-sm truncate max-w-[200px]" title="${c.name}">${c.name}</td>
                    <td class="p-3 text-center font-bold text-blue-600 text-xs">${roundedQty}g</td>
                    <td class="p-3 text-center">${formatDiff(c.diffs.cal)}</td>
                    <td class="p-3 text-center">${formatDiff(c.diffs.carb)}</td>
                    <td class="p-3 text-center">${formatDiff(c.diffs.prot)}</td>
                    <td class="p-3 text-center">${formatDiff(c.diffs.fat)}</td>
                    <td class="p-3 text-center">${formatDiff(c.diffs.fiber)}</td> <!-- Coluna Fibra -->
                    <td class="p-3 text-center">
                        <button onclick="confirmSubstitution(${c.id}, ${roundedQty})" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 text-xs font-bold px-3 py-1 rounded transition">
                            Trocar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderDiet() {
            const c = document.getElementById('diet-container'); c.innerHTML='';
            let dt = {cal:0, c:0, p:0, f:0, fib:0}; // Added fib
            const tc = parseFloat(document.getElementById('target-cal').value)||2000;
            const tfiber = parseFloat(document.getElementById('target-fiber').value)||25; // Target fiber
            const pc = parseFloat(document.getElementById('target-carb-pct').value)||50;
            const pp = parseFloat(document.getElementById('target-prot-pct').value)||30;
            const pf = parseFloat(document.getElementById('target-fat-pct').value)||20;
            document.getElementById('total-pct-display').innerText = (pc+pp+pf);

            dietMeals.forEach((m, idx) => {
                let mc={cal:0, c:0, p:0, f:0, fib:0};
                m.foods.forEach(f => {
                    mc.cal+=f.totalCal; mc.c+=f.totalCarb; mc.p+=f.totalProt; mc.f+=f.totalFat; mc.fib+=(f.totalFiber||0);
                    if(f.option==='A'){ dt.cal+=f.totalCal; dt.c+=f.totalCarb; dt.p+=f.totalProt; dt.f+=f.totalFat; dt.fib+=(f.totalFiber||0); }
                });

                let html = '';
                ['A','B','C'].forEach(opt => {
                    const g = m.foods.filter(f=>f.option===opt);
                    if(g.length>0) {
                        if(opt!=='A' || m.foods.some(x=>x.option!=='A')) html+=`<div class="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-500 uppercase border-y border-slate-100 mt-2">${opt==='A'?'Opção Principal':'Opção '+opt}</div>`;
                        html+=`<div class="table-container"><table class="w-full text-left text-sm"><tbody class="divide-y divide-slate-100">`;
                        g.forEach(f => {
                            const originalIndex = m.foods.indexOf(f);
                            html+=`<tr class="hover:bg-slate-50 group">
                                <td class="p-3 font-medium col-name" contenteditable="true" onblur="updateFoodName(${m.id},${originalIndex},this.innerText)">${f.name}</td>
                                <td class="p-3 col-qty"><input type="number" class="qty-input" value="${f.qty}" onchange="updateFoodQty(${m.id},${originalIndex},this.value)"> g</td>
                                <td class="p-3 text-center text-xs col-cal cursor-text hover:bg-slate-100 rounded" contenteditable="true" onblur="updateFoodMacro(${m.id},${originalIndex},'cal',this.innerText)" title="Clique para editar">${f.totalCal.toFixed(0)} kcal</td>
                                <td class="p-3 text-center text-[10px] col-macro cursor-text hover:bg-slate-100 rounded" contenteditable="true" onblur="updateFoodMacro(${m.id},${originalIndex},'carb',this.innerText)" title="Clique para editar">C: ${f.totalCarb.toFixed(0)}</td>
                                <td class="p-3 text-center text-[10px] col-macro cursor-text hover:bg-slate-100 rounded" contenteditable="true" onblur="updateFoodMacro(${m.id},${originalIndex},'prot',this.innerText)" title="Clique para editar">P: ${f.totalProt.toFixed(0)}</td>
                                <td class="p-3 text-center text-[10px] col-macro cursor-text hover:bg-slate-100 rounded" contenteditable="true" onblur="updateFoodMacro(${m.id},${originalIndex},'fat',this.innerText)" title="Clique para editar">G: ${f.totalFat.toFixed(0)}</td>
                                <td class="p-3 text-center text-[10px] col-macro cursor-text hover:bg-slate-100 rounded" contenteditable="true" onblur="updateFoodMacro(${m.id},${originalIndex},'fiber',this.innerText)" title="Clique para editar">F: ${(f.totalFiber||0).toFixed(1)}</td>
                                <td class="p-3 text-center w-28 col-actions no-print">
                                    <div class="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100">
                                        <button onclick="openSubstitutionModal(${m.id}, ${originalIndex})" class="text-indigo-400 hover:text-indigo-600 px-1" title="Encontrar Substituto"><i class="fa-solid fa-exchange-alt"></i></button>
                                        <button onclick="moveFood(${m.id},${originalIndex},-1)" class="text-slate-400 hover:text-blue-500 px-1"><i class="fa-solid fa-chevron-up"></i></button>
                                        <button onclick="moveFood(${m.id},${originalIndex},1)" class="text-slate-400 hover:text-blue-500 px-1"><i class="fa-solid fa-chevron-down"></i></button>
                                        <button onclick="removeFood(${m.id},${originalIndex})" class="text-slate-300 hover:text-red-500 px-1"><i class="fa-solid fa-times"></i></button>
                                    </div>
                                </td>
                            </tr>`;
                        });
                        html+=`</tbody></table></div>`;
                    }
                });
                
                if(m.foods.length===0) html=`<div class="p-6 text-center text-slate-400 text-sm italic no-print">Nenhum alimento.</div>`;

                c.innerHTML += `<div class="card bg-white rounded-xl shadow-sm theme-border border overflow-hidden break-inside-avoid relative group mt-4">
                    <div class="absolute top-4 right-4 flex gap-2 no-print opacity-0 group-hover:opacity-100 z-10"><button onclick="duplicateMeal(${m.id})" class="text-slate-300 hover:text-blue-500"><i class="fa-regular fa-copy"></i></button><button onclick="deleteMeal(${m.id})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div>
                    <div class="meal-header theme-bg-light p-4 border-b theme-border flex justify-between items-center"><div class="flex items-center gap-3"><div class="flex flex-col gap-1 no-print"><button onclick="moveMeal(${idx},-1)"><i class="fa-solid fa-chevron-up text-slate-400 text-[10px]"></i></button><button onclick="moveMeal(${idx},1)"><i class="fa-solid fa-chevron-down text-slate-400 text-[10px]"></i></button></div><h3 class="font-bold text-slate-700 cursor-text" contenteditable="true" onblur="updateMealTitle(${m.id},this.innerText)">${m.title}</h3></div></div>
                    <div>${html}</div>
                    <div class="totals-footer p-3 bg-slate-50 border-t border-slate-100 flex justify-end gap-4 text-xs font-bold text-slate-600"><span>Total:</span><span>${mc.cal.toFixed(0)} kcal</span><span class="text-blue-600">C: ${mc.c.toFixed(0)}g</span><span class="text-emerald-600">P: ${mc.p.toFixed(0)}g</span><span class="text-yellow-600">G: ${mc.f.toFixed(0)}g</span><span class="text-orange-600">F: ${mc.fib.toFixed(1)}g</span></div>
                    <div class="px-4 pb-4 pt-2 border-t border-slate-100 relative group/obs"><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold text-slate-400 uppercase">Observações</span><button onclick="clearMealObservation(${m.id})" class="no-print opacity-0 group-hover/obs:opacity-100 text-slate-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button></div><div class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm text-slate-600 outline-none" contenteditable="true" onblur="updateMealObservation(${m.id},this.innerText)">${m.observation||''}</div></div>
                </div>`;
            });

            // CARD: INGESTÃO DIÁRIA (DARK) - Atualizado com FIBRAS
            c.innerHTML += `<div class="card bg-slate-800 text-white rounded-xl shadow-md border border-slate-700 break-inside-avoid mt-6"><div class="p-4 border-b border-slate-700 flex justify-between"><h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-chart-pie text-emerald-400"></i> 🍎 Ingestão Diária</h3><span class="text-xs text-slate-400">(Opções A)</span></div><div class="p-6 grid grid-cols-2 md:grid-cols-5 gap-6 text-center"><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Calorias</div><div class="text-3xl font-bold">${dt.cal.toFixed(0)}</div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Carboidrato</div><div class="text-2xl font-bold text-blue-400">${dt.c.toFixed(0)}g</div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Proteína</div><div class="text-2xl font-bold text-emerald-400">${dt.p.toFixed(0)}g</div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Gordura</div><div class="text-2xl font-bold text-yellow-400">${dt.f.toFixed(0)}g</div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Fibras</div><div class="text-2xl font-bold text-orange-400">${dt.fib.toFixed(0)}g</div></div></div></div>`;

            // CARD: META DIÁRIA (AGORA DARK TAMBÉM) - Atualizado
            if(showGoals) {
                c.innerHTML += `<div class="card bg-slate-800 text-white rounded-xl shadow-md border border-slate-700 break-inside-avoid mt-4 relative group">
                    <button onclick="removeGoals()" class="absolute top-3 right-3 text-slate-400 hover:text-red-500 transition no-print opacity-0 group-hover:opacity-100" title="Ocultar Metas"><i class="fa-solid fa-xmark"></i></button>
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa-solid fa-flag-checkered text-emerald-400"></i> Meta Diária
                        </h3>
                    </div>
                    <div class="p-6 grid grid-cols-2 md:grid-cols-5 gap-6 text-center">
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Kcal</div>
                            <div class="text-3xl font-bold text-white">${tc.toFixed(0)}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Carbo</div>
                            <div class="text-2xl font-bold text-blue-400">${(tc*(pc/100)/4).toFixed(0)}g <span class="text-xs text-slate-500 font-normal">(${pc}%)</span></div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Prot</div>
                            <div class="text-2xl font-bold text-emerald-400">${(tc*(pp/100)/4).toFixed(0)}g <span class="text-xs text-slate-500 font-normal">(${pp}%)</span></div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Gord</div>
                            <div class="text-2xl font-bold text-yellow-400">${(tc*(pf/100)/9).toFixed(0)}g <span class="text-xs text-slate-500 font-normal">(${pf}%)</span></div>
                        </div>
                         <div>
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Fibras</div>
                            <div class="text-2xl font-bold text-orange-400">${tfiber}g</div>
                        </div>
                    </div>
                </div>`;
            }
            // Widget Comparison - Atualizado com FIBRAS
            const w=document.getElementById('comparison-widget'); if(w) w.innerHTML=`<div class="flex justify-end border-b pb-1 mb-2 text-[11px] font-bold text-slate-500"><span>Consumido / Meta</span></div><div class="flex justify-between"><span class="text-slate-500">Calorias:</span><span class="font-bold ${dt.cal-tc>100?'text-red-500':'text-green-500'}">${dt.cal.toFixed(0)} / ${tc.toFixed(0)}</span></div><div class="flex justify-between"><span class="text-blue-500">Carboidrato:</span><span>${dt.c.toFixed(0)}g / ${(tc*(pc/100)/4).toFixed(0)}g</span></div><div class="flex justify-between"><span class="text-emerald-500">Proteína:</span><span>${dt.p.toFixed(0)}g / ${(tc*(pp/100)/4).toFixed(0)}g</span></div><div class="flex justify-between"><span class="text-yellow-500">Gordura:</span><span>${dt.f.toFixed(0)}g / ${(tc*(pf/100)/9).toFixed(0)}g</span></div><div class="flex justify-between"><span class="text-orange-500">Fibras:</span><span>${dt.fib.toFixed(0)}g / ${tfiber}g</span></div>`;
        }

        function addToPlan() {
            const mid=parseInt(document.getElementById('select-meal').value), fid=parseInt(document.getElementById('select-food').value), q=parseFloat(document.getElementById('input-qty').value), opt=document.querySelector('input[name="meal-option"]:checked').value;
            if(isNaN(mid)||!q||q<=0) return showToast("Erro nos dados","error");
            const f=foodDatabase.find(x=>x.id===fid), m=dietMeals.find(x=>x.id===mid);
            if(f&&m) { 
                const fac=q/100; 
                m.foods.push({
                    ...f, 
                    qty:q, 
                    option:opt, 
                    totalCal:f.cal*fac, 
                    totalCarb:f.carb*fac, 
                    totalProt:f.prot*fac, 
                    totalFat:f.fat*fac,
                    totalFiber:(f.fiber||0)*fac // Add Fiber
                }); 
                renderDiet(); showToast("Adicionado!"); triggerAutoSave(); 
            }
        }

        // Custom Food Logic
        function loadCustomFoodsFromStorage() { try{const c=JSON.parse(localStorage.getItem('dietCustomFoods')); if(Array.isArray(c)) foodDatabase=[...foodDatabase,...c];}catch(e){} }
        function saveCustomFoodToStorage(f) { const c=JSON.parse(localStorage.getItem('dietCustomFoods'))||[]; c.push(f); localStorage.setItem('dietCustomFoods',JSON.stringify(c)); }
        function clearCustomFoods() { if(confirm("Limpar alimentos?")) { localStorage.removeItem('dietCustomFoods'); location.reload(); } }
        function createCustomFood() {
            const n=document.getElementById('new-name').value, s=parseFloat(document.getElementById('new-serving').value), c=parseFloat(document.getElementById('new-cal').value);
            // new fiber
            const fib = parseFloat(document.getElementById('new-fiber').value)||0;

            if(!n||!s||isNaN(c)) return showToast("Preencha tudo","error");
            const fac=100/s, nf={id:Date.now(), name:n, cal:c*fac, carb:(parseFloat(document.getElementById('new-carb').value)||0)*fac, prot:(parseFloat(document.getElementById('new-prot').value)||0)*fac, fat:(parseFloat(document.getElementById('new-fat').value)||0)*fac, fiber:fib*fac, isCustom:true};
            foodDatabase.push(nf); saveCustomFoodToStorage(nf); renderFoodSelect(); document.getElementById('select-food').value=nf.id; toggleCustomForm(); showToast("Criado!");
        }
        function toggleCustomForm() { document.getElementById('custom-food-form').classList.toggle('hidden'); }
        function setTheme(n) { currentTheme=n; const t=themes[n], r=document.documentElement; r.style.setProperty('--primary',t.primary); r.style.setProperty('--primary-hover',t.hover); r.style.setProperty('--primary-light',t.light); r.style.setProperty('--primary-text',t.text); r.style.setProperty('--border-color',t.border); }
        function updateDateDisplay() { const d=document.getElementById('diet-date').value; if(d) document.getElementById('date-display').innerText=d.split('-').reverse().join('/'); }
        function printDiet() { updateDateDisplay(); window.print(); }
        function showToast(m,t) { const x=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; x.classList.remove('translate-y-20','opacity-0'); setTimeout(()=>x.classList.add('translate-y-20','opacity-0'),3000); }
        function handleImageUpload(e, id, pid) { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(v)=>{ const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas'), ctx=c.getContext('2d'); let w=i.width, h=i.height; if(w>h){if(w>300){h*=300/w;w=300}}else{if(h>150){w*=150/h;h=150}} c.width=w; c.height=h; ctx.drawImage(i,0,0,w,h); const d=c.toDataURL('image/png'); document.getElementById(id).src=d; document.getElementById(id).classList.remove('hidden'); document.getElementById(pid).classList.add('hidden'); triggerAutoSave(); }; i.src=v.target.result; }; r.readAsDataURL(f); }

        init();
    </script>
</body>
</html>
