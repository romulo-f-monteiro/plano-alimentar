<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Alimentar – Dietas Personalizadas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

    <style>
        :root {
            --primary: #059669;
            --primary-hover: #047857;
            --primary-light: #ecfdf5;
            --primary-text: #065f46;
            --border-color: #d1fae5;
        }

        body { font-family: 'Inter', sans-serif; }
        
        .theme-bg { background-color: var(--primary) !important; }
        .theme-bg-hover:hover { background-color: var(--primary-hover) !important; }
        .theme-bg-light { background-color: var(--primary-light) !important; }
        .theme-text { color: var(--primary) !important; }
        .theme-text-dark { color: var(--primary-text) !important; }
        .theme-border { border-color: var(--border-color) !important; }
        .theme-ring:focus { --tw-ring-color: var(--primary); }

        /* --- CONFIGURAÇÃO DE IMPRESSÃO (NATIVO) --- */
        @media print {
            @page {
                margin: 10mm;
                size: auto;
            }

            body { 
                background-color: white; 
                margin: 0; 
                padding: 0; 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .no-print { display: none !important; }
            .print-only { display: block !important; }

            .container, #document-area {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            table { width: 100% !important; }
            
            .card, .break-inside-avoid { 
                break-inside: avoid; 
                page-break-inside: avoid; 
                border: 1px solid #ddd;
                box-shadow: none !important;
            }

            ::-webkit-scrollbar { display: none; }
        }

        .editable-div {
            min-height: 100px;
            overflow: hidden;
            outline: none;
        }
        .editable-div:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .clean-input {
            background: transparent;
            border: none;
            text-align: center;
            width: 100%;
            outline: none;
        }
        .clean-input:focus { background: rgba(0,0,0,0.02); }

        .measure-cell {
            padding: 8px;
            border: 1px solid #cbd5e1;
            text-align: center;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Header Principal -->
    <header class="theme-bg text-white shadow-lg no-print transition-colors duration-300">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <i class="fa-solid fa-leaf text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold">Plano Alimentar</h1>
                    <p class="text-xs opacity-90">Dietas Personalizadas</p>
                </div>
            </div>
            
            <button onclick="printDiet()" class="bg-white text-slate-700 hover:bg-slate-100 px-4 py-2 rounded-lg font-semibold text-sm transition shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-print text-slate-600"></i> Imprimir / Salvar PDF
            </button>
        </div>
    </header>

    <!-- Área de Conteúdo (Documento) -->
    <div id="document-area" class="bg-white md:bg-transparent w-full max-w-[1200px] mx-auto">
        
        <!-- Cabeçalho do Documento -->
        <div class="container mx-auto px-4 mt-6 mb-2">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center text-center gap-2 w-full break-inside-avoid">
                
                <!-- Logo Topo -->
                <div class="mb-4 relative group cursor-pointer" onclick="document.getElementById('logo-upload').click()">
                    <img id="logo-img-main" src="" class="h-24 object-contain hidden mx-auto">
                    <div id="logo-placeholder" class="w-24 h-24 bg-slate-50 rounded-full border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400 mx-auto">
                        <i class="fa-solid fa-camera text-2xl mb-1"></i>
                        <span class="text-[10px]">Add Logo</span>
                    </div>
                    <span class="text-xs text-blue-500 hover:underline mt-1 block no-print">Alterar Logo</span>
                    <input type="file" id="logo-upload" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
                </div>

                <!-- Dados do Paciente -->
                <div class="w-full max-w-2xl space-y-1">
                    <input type="text" id="patient-name" class="clean-input text-2xl font-bold text-slate-800 placeholder-slate-300" placeholder="Nome do Paciente" value="Paciente Exemplo">
                    <input type="text" id="patient-goal" class="clean-input text-md font-medium text-slate-600 placeholder-slate-300" placeholder="Objetivo" value="Objetivo: Hipertrofia">
                    <div class="relative">
                        <input type="date" id="diet-date" class="clean-input text-sm text-slate-500 font-medium no-print" onchange="updateDateDisplay()">
                        <span id="date-display" class="hidden print-only text-sm text-slate-500 font-medium w-full text-center block"></span>
                    </div>
                </div>
            </div>
        </div>

        <main class="flex-grow container mx-auto px-4 py-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- COLUNA DA ESQUERDA: Controles (Oculto no PDF) -->
            <div class="lg:col-span-4 space-y-6 no-print">
                
                <!-- Cor -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-3">Personalizar Cor (10 opções)</h3>
                    <div class="grid grid-cols-5 gap-3">
                        <!-- Linha 1 -->
                        <button onclick="setTheme('emerald')" class="w-8 h-8 rounded-full bg-emerald-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Verde Esmeralda"></button>
                        <button onclick="setTheme('blue')" class="w-8 h-8 rounded-full bg-blue-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Azul"></button>
                        <button onclick="setTheme('indigo')" class="w-8 h-8 rounded-full bg-indigo-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Índigo"></button>
                        <button onclick="setTheme('rose')" class="w-8 h-8 rounded-full bg-rose-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Rosa"></button>
                        <button onclick="setTheme('amber')" class="w-8 h-8 rounded-full bg-amber-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Âmbar/Laranja"></button>
                        
                        <!-- Linha 2 -->
                        <button onclick="setTheme('purple')" class="w-8 h-8 rounded-full bg-purple-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Roxo"></button>
                        <button onclick="setTheme('cyan')" class="w-8 h-8 rounded-full bg-cyan-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Ciano"></button>
                        <button onclick="setTheme('teal')" class="w-8 h-8 rounded-full bg-teal-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Turquesa"></button>
                        <button onclick="setTheme('lime')" class="w-8 h-8 rounded-full bg-lime-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Verde Limão"></button>
                        <button onclick="setTheme('fuchsia')" class="w-8 h-8 rounded-full bg-fuchsia-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300" title="Fúcsia"></button>
                    </div>
                </div>

                <!-- Nova Refeição -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700">
                        <i class="fa-solid fa-calendar-plus theme-text"></i> Criar Refeição Extra
                    </h2>
                    <div class="flex gap-2">
                        <input type="text" id="new-meal-name" placeholder="Ex: Pré-Treino..." class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none text-sm">
                        <button onclick="addNewMeal()" class="bg-slate-800 text-white px-4 rounded-lg hover:bg-slate-700 transition">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Adicionar Refeições (Card Principal) -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700">
                        <i class="fa-solid fa-carrot theme-text"></i> Adicionar Refeições
                    </h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Escolha a Refeição</label>
                            <select id="select-meal" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none text-sm font-semibold text-slate-700">
                                <!-- JS Populates -->
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Opção</label>
                            <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="meal-option" value="A" checked class="peer sr-only">
                                    <div class="text-center py-2 border rounded-lg peer-checked:bg-slate-800 peer-checked:text-white text-xs font-semibold transition">Opção A</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="meal-option" value="B" class="peer sr-only">
                                    <div class="text-center py-2 border rounded-lg peer-checked:bg-slate-800 peer-checked:text-white text-xs font-semibold transition">Opção B</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="meal-option" value="C" class="peer sr-only">
                                    <div class="text-center py-2 border rounded-lg peer-checked:bg-slate-800 peer-checked:text-white text-xs font-semibold transition">Opção C</div>
                                </label>
                            </div>
                        </div>

                        <!-- BUSCA DE ALIMENTOS -->
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Alimento (TACO/Unicamp)</label>
                            <!-- Input de pesquisa -->
                            <div class="relative mb-2">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <i class="fa-solid fa-search text-slate-400"></i>
                                </div>
                                <input type="text" id="search-food" onkeyup="filterFoods()" placeholder="Buscar alimento (ex: arroz, frango)..." class="w-full p-2 pl-10 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none text-sm">
                            </div>
                            <!-- Select Filtrável -->
                            <select id="select-food" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none custom-scroll text-sm">
                                <!-- JS Populates -->
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Quantidade</label>
                            <div class="flex gap-2">
                                <input type="number" id="input-qty" value="100" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none" placeholder="Ex: 100">
                                <span class="flex items-center bg-slate-100 border border-slate-200 px-3 rounded-lg text-slate-500 text-sm">g/ml</span>
                            </div>
                        </div>

                        <button onclick="addToPlan()" class="w-full theme-bg theme-bg-hover text-white font-semibold py-3 rounded-lg transition shadow-md flex justify-center items-center gap-2">
                            <i class="fa-solid fa-check"></i> Inserir
                        </button>
                    </div>
                </div>

                <!-- Adicionar Novos Alimentos -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700 cursor-pointer" onclick="toggleCustomForm()">
                        <i class="fa-solid fa-pen-to-square text-blue-500"></i> Adicionar Novos Alimentos
                        <i class="fa-solid fa-chevron-down ml-auto text-xs text-slate-400"></i>
                    </h2>
                    
                    <div id="custom-food-form" class="hidden space-y-3 pt-2 border-t border-slate-100">
                        <input type="text" id="new-name" placeholder="Nome do Alimento" class="w-full p-2 text-sm border rounded">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="new-cal" placeholder="Kcal" class="w-full p-2 text-sm border rounded">
                            <input type="number" id="new-carb" placeholder="Carb" class="w-full p-2 text-sm border rounded">
                            <input type="number" id="new-prot" placeholder="Prot" class="w-full p-2 text-sm border rounded">
                            <input type="number" id="new-fat" placeholder="Gord" class="w-full p-2 text-sm border rounded">
                        </div>
                        <button onclick="createCustomFood()" class="w-full bg-blue-50 text-blue-600 hover:bg-blue-100 py-2 rounded-lg text-sm font-semibold transition border border-blue-200">
                            Salvar no Banco
                        </button>
                    </div>
                </div>
            </div>

            <!-- COLUNA DA DIREITA: A Dieta -->
            <div class="lg:col-span-8 space-y-6 w-full">
                <div id="diet-container" class="space-y-6">
                    <!-- Cards renderizados -->
                </div>

                <!-- Metas -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-8 break-inside-avoid">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-lg">
                        <i class="fa-solid fa-bullseye theme-text"></i> Metas e Orientações
                    </h3>
                    <div id="goals-area" class="editable-div w-full p-2 bg-transparent text-slate-700 leading-relaxed" contenteditable="true" placeholder="Clique aqui para digitar as metas e orientações..."></div>
                </div>

                <!-- Histórico da composição corporal -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-6 break-inside-avoid w-full overflow-hidden">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-lg">
                        <i class="fa-solid fa-weight-scale theme-text"></i> Histórico da composição corporal
                    </h3>
                    <div class="w-full">
                        <table class="w-full text-xs text-center border-collapse border border-slate-300 table-fixed">
                            <thead>
                                <tr class="bg-slate-100 text-slate-700 font-bold">
                                    <th class="measure-cell w-20">Data</th>
                                    <th class="measure-cell">Peso</th>
                                    <th class="measure-cell">Cintura</th>
                                    <th class="measure-cell">Abdômen</th>
                                    <th class="measure-cell">Quadril</th>
                                    <th class="measure-cell">Braço(D/E)</th>
                                    <th class="measure-cell">Perna(D/E)</th>
                                </tr>
                            </thead>
                            <tbody class="text-slate-700">
                                <tr><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td></tr>
                                <tr><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td></tr>
                                <tr><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td></tr>
                                <tr><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td></tr>
                                <tr><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td><td class="measure-cell" contenteditable="true"></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Rodapé -->
                <div class="mt-8 pt-8 border-t border-slate-300 flex flex-col md:flex-row justify-between items-center gap-8 text-slate-800 break-inside-avoid">
                    
                    <!-- Dados Profissional (Esquerda - Vertical) -->
                    <div class="w-full md:w-1/2 flex flex-col gap-3 text-left">
                        <input type="text" id="prof-name" class="clean-input text-left font-bold text-lg placeholder-slate-400" placeholder="Nome do Profissional">
                        
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-xs text-slate-500 w-8">CRN:</span>
                            <input type="text" id="prof-crn" class="clean-input text-left text-sm font-medium placeholder-slate-400 flex-grow" placeholder="00000">
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <i class="fa-brands fa-whatsapp text-green-600 text-lg w-8 text-center"></i>
                            <input type="text" id="prof-phone" class="clean-input text-left text-sm font-medium placeholder-slate-400 flex-grow" placeholder="(00) 00000-0000">
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <i class="fa-brands fa-instagram text-pink-600 text-lg w-8 text-center"></i>
                            <input type="text" id="prof-insta" class="clean-input text-left text-sm font-medium placeholder-slate-400 flex-grow" placeholder="@seu.perfil">
                        </div>
                    </div>

                    <!-- Logo Secundária (Direita) -->
                    <div class="w-full md:w-1/2 flex flex-col items-center md:items-end">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('logo-upload-footer').click()">
                            <img id="logo-img-footer" src="" class="h-24 object-contain hidden">
                            <div id="logo-placeholder-footer" class="w-32 h-24 bg-slate-50 rounded-lg border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400">
                                <i class="fa-solid fa-image text-xl mb-1"></i>
                                <span class="text-[10px]">Logo/Assinatura</span>
                            </div>
                            <span class="text-xs text-blue-500 hover:underline mt-1 block text-center md:text-right no-print">Adicionar Imagem</span>
                            <input type="file" id="logo-upload-footer" accept="image/*" class="hidden" onchange="handleLogoUploadFooter(event)">
                        </div>
                    </div>
                </div>

                <!-- Créditos e Fonte (TACO) -->
                <div class="text-center mt-10 pb-4 border-t border-slate-100 pt-4 break-inside-avoid">
                    <p class="text-[10px] text-slate-500 italic mb-1">
                        Alimentos da tabela UNICAMP. Tabela Brasileira de Composição de Alimentos – TACO (4ª Edição)
                    </p>
                    <p class="text-[10px] text-slate-400 font-medium">
                        Criado por Rômulo F. Monteiro <span class="text-blue-400">@romulof.monteiro</span>
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3" data-html2canvas-ignore="true">
        <i class="fa-solid fa-circle-check text-emerald-400"></i>
        <span id="toast-msg">Ação realizada</span>
    </div>

    <script>
        // --- DADOS DA TABELA TACO (200+ Alimentos) ---
        // Valores por 100g de parte comestível
        let foodDatabase = [
            // === CEREAIS, LEGUMINOSAS E DERIVADOS ===
            { id: 101, name: "Arroz Integral, Cozido", cal: 124, carb: 25.8, prot: 2.6, fat: 1.0 },
            { id: 102, name: "Arroz Tipo 1, Cozido", cal: 128, carb: 28.1, prot: 2.5, fat: 0.2 },
            { id: 103, name: "Arroz Tipo 2, Cozido", cal: 130, carb: 28.2, prot: 2.6, fat: 0.4 },
            { id: 104, name: "Aveia, Flocos Crus", cal: 394, carb: 66.6, prot: 13.9, fat: 8.5 },
            { id: 105, name: "Biscoito, Cream Cracker", cal: 432, carb: 68.7, prot: 10.1, fat: 14.4 },
            { id: 106, name: "Biscoito, Maria", cal: 436, carb: 75.2, prot: 7.9, fat: 12.5 },
            { id: 107, name: "Biscoito, Recheado, Chocolate", cal: 472, carb: 70.5, prot: 6.4, fat: 19.6 },
            { id: 108, name: "Bolo, Mistura p/ Preparo, Chocolate", cal: 398, carb: 80.4, prot: 6.2, fat: 5.7 },
            { id: 109, name: "Canjica Branca, Crua", cal: 358, carb: 78.6, prot: 7.2, fat: 1.1 },
            { id: 110, name: "Cereal Matinal, Milho", cal: 377, carb: 83.8, prot: 7.2, fat: 1.2 },
            { id: 111, name: "Creme de Milho, Pó", cal: 337, carb: 80.1, prot: 4.8, fat: 0.8 },
            { id: 112, name: "Curau, Milho Verde", cal: 78, carb: 12.8, prot: 2.3, fat: 2.3 },
            { id: 113, name: "Farinha de Aveia", cal: 404, carb: 69.1, prot: 13.5, fat: 9.1 },
            { id: 114, name: "Farinha de Mandioca, Crua", cal: 361, carb: 87.9, prot: 1.6, fat: 0.3 },
            { id: 115, name: "Farinha de Milho, Amarela", cal: 370, carb: 79.1, prot: 7.2, fat: 1.5 },
            { id: 116, name: "Farinha de Rosca", cal: 371, carb: 75.8, prot: 11.2, fat: 1.5 },
            { id: 117, name: "Farinha de Trigo", cal: 360, carb: 75.1, prot: 9.8, fat: 1.4 },
            { id: 118, name: "Feijão Carioca, Cozido (50% Caldo)", cal: 76, carb: 13.6, prot: 4.8, fat: 0.5 },
            { id: 119, name: "Feijão Fradinho, Cozido", cal: 78, carb: 13.7, prot: 5.1, fat: 0.6 },
            { id: 120, name: "Feijão Preto, Cozido", cal: 77, carb: 14.0, prot: 4.5, fat: 0.5 },
            { id: 121, name: "Grão de Bico, Cozido", cal: 164, carb: 27.4, prot: 8.9, fat: 2.6 },
            { id: 122, name: "Lentilha, Cozida", cal: 93, carb: 16.3, prot: 6.3, fat: 0.5 },
            { id: 123, name: "Macarrão, Trigo, Cozido", cal: 157, carb: 30.9, prot: 5.8, fat: 0.9 },
            { id: 124, name: "Macarrão Instantâneo (Miojo)", cal: 436, carb: 60.1, prot: 8.8, fat: 17.2 },
            { id: 125, name: "Milho Verde, Enlatado, Drenado", cal: 138, carb: 28.6, prot: 3.2, fat: 2.4 },
            { id: 126, name: "Pão de Forma, Integral", cal: 253, carb: 49.9, prot: 9.4, fat: 3.7 },
            { id: 127, name: "Pão de Forma, Tradicional", cal: 269, carb: 53.6, prot: 8.2, fat: 3.3 },
            { id: 128, name: "Pão de Queijo, Assado", cal: 363, carb: 34.0, prot: 5.1, fat: 24.6 },
            { id: 129, name: "Pão Francês", cal: 300, carb: 58.6, prot: 8.0, fat: 3.1 },
            { id: 130, name: "Pipoca, Com Sal e Óleo", cal: 448, carb: 57.1, prot: 9.9, fat: 19.4 },
            { id: 131, name: "Polenta, Cozida", cal: 92, carb: 20.9, prot: 2.2, fat: 0.3 },
            { id: 132, name: "Soja, Cozida", cal: 173, carb: 9.9, prot: 16.6, fat: 8.9 },
            { id: 133, name: "Tapioca, Goma Hidratada", cal: 236, carb: 54.8, prot: 0.0, fat: 0.0 },
            { id: 134, name: "Torrada, Pão Francês", cal: 377, carb: 74.6, prot: 10.5, fat: 3.6 },
            { id: 135, name: "Trigo para Kibe, Cru", cal: 342, carb: 72.9, prot: 11.2, fat: 1.5 },

            // === VERDURAS, LEGUMES E TUBÉRCULOS ===
            { id: 201, name: "Abóbora, Cabotian, Cozida", cal: 48, carb: 10.8, prot: 1.4, fat: 0.7 },
            { id: 202, name: "Abobrinha, Italiana, Cozida", cal: 15, carb: 3.0, prot: 1.1, fat: 0.1 },
            { id: 203, name: "Acelga, Crua", cal: 21, carb: 4.6, prot: 1.4, fat: 0.1 },
            { id: 204, name: "Agrião, Cru", cal: 17, carb: 2.3, prot: 2.7, fat: 0.2 },
            { id: 205, name: "Aipim / Mandioca, Cozida", cal: 125, carb: 30.1, prot: 0.6, fat: 0.3 },
            { id: 206, name: "Aipim, Frito", cal: 300, carb: 50.3, prot: 1.4, fat: 11.2 },
            { id: 207, name: "Alface, Crespa, Crua", cal: 11, carb: 1.7, prot: 1.3, fat: 0.2 },
            { id: 208, name: "Alho, Cru", cal: 113, carb: 23.9, prot: 7.0, fat: 0.2 },
            { id: 209, name: "Batata Doce, Cozida", cal: 77, carb: 18.4, prot: 0.6, fat: 0.1 },
            { id: 210, name: "Batata Inglesa, Cozida", cal: 52, carb: 11.9, prot: 1.2, fat: 0.0 },
            { id: 211, name: "Batata Inglesa, Frita", cal: 267, carb: 35.6, prot: 5.0, fat: 13.1 },
            { id: 212, name: "Berinjela, Cozida", cal: 19, carb: 4.5, prot: 0.7, fat: 0.1 },
            { id: 213, name: "Beterraba, Cozida", cal: 32, carb: 7.2, prot: 1.3, fat: 0.1 },
            { id: 214, name: "Beterraba, Crua", cal: 48, carb: 11.1, prot: 1.6, fat: 0.1 },
            { id: 215, name: "Brócolis, Cozido", cal: 25, carb: 4.4, prot: 2.1, fat: 0.5 },
            { id: 216, name: "Cebola, Crua", cal: 39, carb: 8.9, prot: 1.7, fat: 0.1 },
            { id: 217, name: "Cenoura, Cozida", cal: 30, carb: 6.7, prot: 0.8, fat: 0.2 },
            { id: 218, name: "Cenoura, Crua", cal: 34, carb: 7.7, prot: 1.3, fat: 0.2 },
            { id: 219, name: "Chuchu, Cozido", cal: 19, carb: 4.8, prot: 0.4, fat: 0.0 },
            { id: 220, name: "Couve, Refogada", cal: 90, carb: 8.7, prot: 2.9, fat: 5.7 },
            { id: 221, name: "Couve-Flor, Cozida", cal: 19, carb: 3.9, prot: 1.2, fat: 0.3 },
            { id: 222, name: "Espinafre, Refogado", cal: 67, carb: 4.2, prot: 2.7, fat: 5.4 },
            { id: 223, name: "Inhame, Cozido", cal: 76, carb: 18.1, prot: 1.8, fat: 0.1 },
            { id: 224, name: "Pepino, Cru", cal: 10, carb: 2.0, prot: 0.9, fat: 0.0 },
            { id: 225, name: "Pimentão, Verde, Cru", cal: 21, carb: 4.9, prot: 1.1, fat: 0.2 },
            { id: 226, name: "Quiabo, Cozido", cal: 22, carb: 4.7, prot: 1.4, fat: 0.2 },
            { id: 227, name: "Repolho, Branco, Cru", cal: 17, carb: 3.9, prot: 0.9, fat: 0.1 },
            { id: 228, name: "Rúcula, Crua", cal: 13, carb: 2.2, prot: 1.8, fat: 0.1 },
            { id: 229, name: "Tomate, Salada", cal: 15, carb: 3.1, prot: 1.1, fat: 0.2 },
            { id: 230, name: "Vagem, Cozida", cal: 25, carb: 5.3, prot: 1.8, fat: 0.2 },

            // === FRUTAS ===
            { id: 301, name: "Abacate, Cru", cal: 96, carb: 6.0, prot: 1.2, fat: 8.4 },
            { id: 302, name: "Abacaxi, Cru", cal: 48, carb: 12.3, prot: 0.9, fat: 0.1 },
            { id: 303, name: "Acerola, Crua", cal: 33, carb: 8.0, prot: 0.9, fat: 0.2 },
            { id: 304, name: "Ameixa, Preta, Crua", cal: 53, carb: 13.9, prot: 0.8, fat: 0.0 },
            { id: 305, name: "Banana, Maçã, Crua", cal: 87, carb: 22.3, prot: 1.8, fat: 0.1 },
            { id: 306, name: "Banana, Nanica, Crua", cal: 92, carb: 23.8, prot: 1.4, fat: 0.1 },
            { id: 307, name: "Banana, Prata, Crua", cal: 98, carb: 26.0, prot: 1.3, fat: 0.1 },
            { id: 308, name: "Caju, Cru", cal: 43, carb: 10.3, prot: 1.0, fat: 0.3 },
            { id: 309, name: "Caqui, Chocolate, Cru", cal: 71, carb: 19.3, prot: 0.4, fat: 0.1 },
            { id: 310, name: "Coco, Água de", cal: 22, carb: 5.3, prot: 0.0, fat: 0.0 },
            { id: 311, name: "Coco, Cru", cal: 406, carb: 10.4, prot: 3.7, fat: 42.0 },
            { id: 312, name: "Figo, Cru", cal: 41, carb: 10.2, prot: 1.0, fat: 0.2 },
            { id: 313, name: "Goiaba, Branca, Crua", cal: 52, carb: 12.4, prot: 0.9, fat: 0.5 },
            { id: 314, name: "Goiaba, Vermelha, Crua", cal: 54, carb: 13.0, prot: 1.1, fat: 0.4 },
            { id: 315, name: "Kiwi, Cru", cal: 51, carb: 11.5, prot: 1.3, fat: 0.6 },
            { id: 316, name: "Laranja, Lima, Crua", cal: 39, carb: 9.2, prot: 1.1, fat: 0.1 },
            { id: 317, name: "Laranja, Pera, Crua", cal: 37, carb: 8.9, prot: 1.0, fat: 0.1 },
            { id: 318, name: "Limão, Suco", cal: 29, carb: 11.1, prot: 1.1, fat: 0.0 },
            { id: 319, name: "Maçã, Fuji, Com Casca", cal: 56, carb: 15.2, prot: 0.3, fat: 0.2 },
            { id: 320, name: "Mamão, Formosa, Cru", cal: 45, carb: 11.6, prot: 0.8, fat: 0.1 },
            { id: 321, name: "Mamão, Papaia, Cru", cal: 40, carb: 10.4, prot: 0.5, fat: 0.1 },
            { id: 322, name: "Manga, Palmer, Crua", cal: 72, carb: 19.4, prot: 0.4, fat: 0.2 },
            { id: 323, name: "Maracujá, Polpa, Crua", cal: 68, carb: 12.3, prot: 2.0, fat: 2.1 },
            { id: 324, name: "Melancia, Crua", cal: 33, carb: 8.1, prot: 0.9, fat: 0.0 },
            { id: 325, name: "Melão, Cru", cal: 29, carb: 7.5, prot: 0.7, fat: 0.0 },
            { id: 326, name: "Morango, Cru", cal: 30, carb: 6.8, prot: 0.9, fat: 0.3 },
            { id: 327, name: "Pera, Williams, Crua", cal: 53, carb: 14.0, prot: 0.6, fat: 0.1 },
            { id: 328, name: "Pêssego, Cru", cal: 36, carb: 9.3, prot: 0.8, fat: 0.0 },
            { id: 329, name: "Tangerina/Mexerica, Crua", cal: 38, carb: 9.3, prot: 0.7, fat: 0.1 },
            { id: 330, name: "Uva, Itália, Crua", cal: 53, carb: 13.6, prot: 0.9, fat: 0.2 },

            // === CARNES, PESCADOS E OVOS ===
            { id: 401, name: "Boi, Acém, Moído, Cozido", cal: 212, carb: 0.0, prot: 26.7, fat: 10.9 },
            { id: 402, name: "Boi, Alcatra, Grelhada", cal: 241, carb: 0.0, prot: 31.9, fat: 11.6 },
            { id: 403, name: "Boi, Contrafilé, Grelhado", cal: 278, carb: 0.0, prot: 32.4, fat: 15.5 },
            { id: 404, name: "Boi, Costela, Assada", cal: 373, carb: 0.0, prot: 28.8, fat: 27.7 },
            { id: 405, name: "Boi, Coxão Mole, Cozido", cal: 219, carb: 0.0, prot: 32.4, fat: 8.9 },
            { id: 406, name: "Boi, Filé Mignon, Grelhado", cal: 220, carb: 0.0, prot: 32.8, fat: 8.8 },
            { id: 407, name: "Boi, Fígado, Grelhado", cal: 225, carb: 4.2, prot: 29.9, fat: 9.0 },
            { id: 408, name: "Boi, Músculo, Cozido", cal: 194, carb: 0.0, prot: 31.2, fat: 6.7 },
            { id: 409, name: "Boi, Patinho, Grelhado", cal: 219, carb: 0.0, prot: 35.9, fat: 7.3 },
            { id: 410, name: "Boi, Picanha, Grelhada", cal: 289, carb: 0.0, prot: 26.4, fat: 19.5 },
            { id: 411, name: "Frango, Coração, Assado", cal: 207, carb: 0.6, prot: 25.6, fat: 10.9 },
            { id: 412, name: "Frango, Coxa, Assada (com pele)", cal: 215, carb: 0.1, prot: 27.0, fat: 11.1 },
            { id: 413, name: "Frango, Peito, Grelhado", cal: 159, carb: 0.0, prot: 32.0, fat: 2.5 },
            { id: 414, name: "Frango, Sobrecoxa, Assada", cal: 260, carb: 0.0, prot: 23.0, fat: 18.0 },
            { id: 415, name: "Linguiça, Calabresa, Frita", cal: 380, carb: 1.5, prot: 19.3, fat: 32.5 },
            { id: 416, name: "Linguiça, Frango, Assada", cal: 236, carb: 1.7, prot: 21.0, fat: 16.0 },
            { id: 417, name: "Ovo de Codorna, Inteiro", cal: 177, carb: 1.6, prot: 13.7, fat: 12.6 },
            { id: 418, name: "Ovo de Galinha, Cozido", cal: 146, carb: 0.6, prot: 13.3, fat: 9.5 },
            { id: 419, name: "Ovo de Galinha, Frito", cal: 240, carb: 1.2, prot: 15.6, fat: 18.6 },
            { id: 420, name: "Peixe, Atum, Conserva Óleo", cal: 166, carb: 0.0, prot: 26.2, fat: 6.0 },
            { id: 421, name: "Peixe, Bacalhau, Assado", cal: 110, carb: 0.0, prot: 24.0, fat: 1.2 },
            { id: 422, name: "Peixe, Cação, Cozido", cal: 116, carb: 0.0, prot: 25.6, fat: 0.7 },
            { id: 423, name: "Peixe, Merluza, Filé, Assado", cal: 122, carb: 0.0, prot: 26.6, fat: 0.9 },
            { id: 424, name: "Peixe, Salmão, Grelhado", cal: 229, carb: 0.0, prot: 24.0, fat: 14.0 },
            { id: 425, name: "Peixe, Sardinha, Assada", cal: 164, carb: 0.0, prot: 32.2, fat: 3.0 },
            { id: 426, name: "Peixe, Tilápia, Grelhada", cal: 128, carb: 0.0, prot: 26.1, fat: 2.7 },
            { id: 427, name: "Porco, Bisteca, Grelhada", cal: 280, carb: 0.0, prot: 28.6, fat: 17.4 },
            { id: 428, name: "Porco, Lombo, Assado", cal: 210, carb: 0.0, prot: 35.7, fat: 6.4 },
            { id: 429, name: "Presunto, Cozido", cal: 120, carb: 1.0, prot: 16.5, fat: 5.5 },
            { id: 430, name: "Salsicha, Cozida", cal: 246, carb: 2.0, prot: 13.0, fat: 21.0 },

            // === LEITE E DERIVADOS ===
            { id: 501, name: "Creme de Leite", cal: 221, carb: 4.5, prot: 1.5, fat: 22.0 },
            { id: 502, name: "Iogurte, Natural", cal: 51, carb: 5.3, prot: 4.1, fat: 3.0 },
            { id: 503, name: "Iogurte, Natural, Desnatado", cal: 41, carb: 6.8, prot: 3.8, fat: 0.1 },
            { id: 504, name: "Iogurte, Sabor Morango", cal: 70, carb: 12.5, prot: 2.7, fat: 1.2 },
            { id: 505, name: "Leite, Condensado", cal: 313, carb: 57.0, prot: 7.7, fat: 6.0 },
            { id: 506, name: "Leite, Fermentado (Yakult)", cal: 72, carb: 15.0, prot: 2.0, fat: 0.0 },
            { id: 507, name: "Leite, Vaca, Desnatado", cal: 35, carb: 4.7, prot: 3.1, fat: 0.5 },
            { id: 508, name: "Leite, Vaca, Desnatado, Pó", cal: 362, carb: 51.6, prot: 34.7, fat: 0.9 },
            { id: 509, name: "Leite, Vaca, Integral", cal: 60, carb: 4.5, prot: 3.2, fat: 3.0 },
            { id: 510, name: "Leite, Vaca, Integral, Pó", cal: 497, carb: 39.2, prot: 25.4, fat: 26.7 },
            { id: 511, name: "Manteiga, Com Sal", cal: 726, carb: 0.1, prot: 0.4, fat: 82.0 },
            { id: 512, name: "Queijo, Minas, Frescal", cal: 264, carb: 3.2, prot: 17.4, fat: 20.2 },
            { id: 513, name: "Queijo, Mussarela", cal: 328, carb: 3.0, prot: 22.6, fat: 25.2 },
            { id: 514, name: "Queijo, Parmesão", cal: 453, carb: 1.7, prot: 35.6, fat: 33.5 },
            { id: 515, name: "Queijo, Prato", cal: 360, carb: 1.9, prot: 22.7, fat: 29.1 },
            { id: 516, name: "Queijo, Ricota", cal: 140, carb: 3.8, prot: 12.6, fat: 8.1 },
            { id: 517, name: "Requeijão, Cremoso", cal: 308, carb: 2.4, prot: 9.6, fat: 28.9 },

            // === ÓLEOS, GORDURAS E OLEAGINOSAS ===
            { id: 601, name: "Amendoim, Torrado", cal: 606, carb: 18.7, prot: 22.5, fat: 54.0 },
            { id: 602, name: "Azeite de Dendê", cal: 884, carb: 0.0, prot: 0.0, fat: 100.0 },
            { id: 603, name: "Azeite de Oliva, Extra Virgem", cal: 884, carb: 0.0, prot: 0.0, fat: 100.0 },
            { id: 604, name: "Bacon, Frito", cal: 697, carb: 0.0, prot: 33.0, fat: 60.3 },
            { id: 605, name: "Castanha de Caju, Torrada", cal: 570, carb: 32.9, prot: 18.5, fat: 46.3 },
            { id: 606, name: "Castanha do Brasil (Pará)", cal: 643, carb: 15.1, prot: 14.5, fat: 63.5 },
            { id: 607, name: "Margarina, Com Sal", cal: 723, carb: 0.0, prot: 0.0, fat: 81.7 },
            { id: 608, name: "Maionese, Industrializada", cal: 302, carb: 7.6, prot: 0.6, fat: 30.5 },
            { id: 609, name: "Noz, Crua", cal: 620, carb: 18.4, prot: 14.0, fat: 59.4 },
            { id: 610, name: "Óleo de Milho", cal: 884, carb: 0.0, prot: 0.0, fat: 100.0 },
            { id: 611, name: "Óleo de Soja", cal: 884, carb: 0.0, prot: 0.0, fat: 100.0 },

            // === BEBIDAS, DOCES E OUTROS ===
            { id: 701, name: "Achocolatado, Pó", cal: 401, carb: 90.0, prot: 2.0, fat: 2.3 },
            { id: 702, name: "Açúcar, Mascavo", cal: 369, carb: 95.5, prot: 0.8, fat: 0.0 },
            { id: 703, name: "Açúcar, Refinado", cal: 387, carb: 99.5, prot: 0.3, fat: 0.0 },
            { id: 704, name: "Café, Infusão (Sem açúcar)", cal: 2, carb: 0.3, prot: 0.3, fat: 0.1 },
            { id: 705, name: "Chocolate, Ao Leite", cal: 540, carb: 59.6, prot: 7.2, fat: 29.7 },
            { id: 706, name: "Chocolate, Meio Amargo", cal: 475, carb: 55.0, prot: 5.0, fat: 30.0 },
            { id: 707, name: "Cocada, Branca", cal: 440, carb: 65.0, prot: 2.0, fat: 18.0 },
            { id: 708, name: "Doce de Leite", cal: 306, carb: 55.0, prot: 6.0, fat: 7.0 },
            { id: 709, name: "Geleia, Mocotó", cal: 176, carb: 36.6, prot: 6.4, fat: 0.1 },
            { id: 710, name: "Goiabada", cal: 294, carb: 74.0, prot: 0.5, fat: 0.1 },
            { id: 711, name: "Mel de Abelha", cal: 309, carb: 84.0, prot: 0.3, fat: 0.0 },
            { id: 712, name: "Refrigerante, Coca-Cola", cal: 42, carb: 10.5, prot: 0.0, fat: 0.0 },
            { id: 713, name: "Refrigerante, Guaraná", cal: 40, carb: 10.0, prot: 0.0, fat: 0.0 },
            { id: 714, name: "Suco de Laranja, Natural", cal: 45, carb: 10.5, prot: 0.7, fat: 0.2 },
            { id: 715, name: "Suco de Uva, Concentrado", cal: 58, carb: 14.7, prot: 0.0, fat: 0.0 },
            { id: 716, name: "Vinho, Tinto", cal: 65, carb: 0.2, prot: 0.0, fat: 0.0 }
        ];

        // Refeições Pré-definidas
        let dietMeals = [
            { id: 1, title: "Café da Manhã (Desjejum)", foods: [] },
            { id: 2, title: "Lanche da Manhã (Colação)", foods: [] },
            { id: 3, title: "Almoço", foods: [] },
            { id: 4, title: "Lanche da Tarde", foods: [] },
            { id: 5, title: "Jantar", foods: [] },
            { id: 6, title: "Ceia", foods: [] }
        ];

        let currentTheme = 'emerald';
        const themes = {
            emerald: { primary: '#059669', hover: '#047857', light: '#ecfdf5', text: '#065f46', border: '#d1fae5' },
            blue: { primary: '#2563eb', hover: '#1d4ed8', light: '#eff6ff', text: '#1e40af', border: '#dbeafe' },
            indigo: { primary: '#4f46e5', hover: '#4338ca', light: '#eef2ff', text: '#3730a3', border: '#e0e7ff' },
            rose: { primary: '#e11d48', hover: '#be123c', light: '#fff1f2', text: '#9f1239', border: '#ffe4e6' },
            amber: { primary: '#d97706', hover: '#b45309', light: '#fffbeb', text: '#92400e', border: '#fef3c7' },
            // NOVAS CORES
            purple: { primary: '#9333ea', hover: '#7e22ce', light: '#f3e8ff', text: '#6b21a8', border: '#e9d5ff' },
            cyan: { primary: '#06b6d4', hover: '#0891b2', light: '#ecfeff', text: '#155e75', border: '#cffafe' },
            teal: { primary: '#14b8a6', hover: '#0d9488', light: '#f0fdfa', text: '#115e59', border: '#ccfbf1' },
            lime: { primary: '#84cc16', hover: '#65a30d', light: '#f7fee7', text: '#3f6212', border: '#d9f99d' },
            fuchsia: { primary: '#d946ef', hover: '#c026d3', light: '#fdf4ff', text: '#86198f', border: '#f0abfc' }
        };

        function init() {
            const dateInput = document.getElementById('diet-date');
            if(dateInput) {
                dateInput.valueAsDate = new Date();
                updateDateDisplay();
            }
            renderFoodSelect(); // Renderiza todos inicialmente
            renderMealSelect();
            renderDiet();
        }

        // --- GESTÃO DE REFEIÇÕES ---

        function addNewMeal() {
            const nameInput = document.getElementById('new-meal-name');
            const name = nameInput.value.trim();
            if(!name) { showToast("Digite o nome da refeição", "error"); return; }
            const newId = Date.now();
            dietMeals.push({ id: newId, title: name, foods: [] });
            nameInput.value = '';
            renderMealSelect();
            renderDiet();
            showToast("Refeição criada!");
        }

        function deleteMeal(id) {
            if(confirm("Tem certeza que deseja apagar esta refeição inteira?")) {
                dietMeals = dietMeals.filter(m => m.id !== id);
                renderMealSelect();
                renderDiet();
                showToast("Refeição removida", "neutral");
            }
        }

        function renderMealSelect() {
            const select = document.getElementById('select-meal');
            const currentVal = select.value;
            select.innerHTML = '';
            dietMeals.forEach(meal => {
                const option = document.createElement('option');
                option.value = meal.id;
                option.text = meal.title;
                select.appendChild(option);
            });
            if(currentVal) select.value = currentVal;
        }

        // --- GESTÃO DE ALIMENTOS E BUSCA ---

        function renderFoodSelect(filterText = "") {
            const select = document.getElementById('select-food');
            select.innerHTML = '';
            
            // Ordenar alfabeticamente
            let sortedFoods = [...foodDatabase].sort((a, b) => a.name.localeCompare(b.name));

            // Filtrar se houver texto
            if (filterText) {
                const term = filterText.toLowerCase();
                sortedFoods = sortedFoods.filter(f => f.name.toLowerCase().includes(term));
            }

            if (sortedFoods.length === 0) {
                const option = document.createElement('option');
                option.text = "Nenhum alimento encontrado";
                select.appendChild(option);
                select.disabled = true;
                return;
            } else {
                select.disabled = false;
            }

            sortedFoods.forEach(food => {
                const option = document.createElement('option');
                option.value = food.id;
                option.text = `${food.name} (${food.cal}kcal/100g)`;
                select.appendChild(option);
            });
            
            // Selecionar o primeiro automaticamente
            if(sortedFoods.length > 0) select.value = sortedFoods[0].id;
        }

        function filterFoods() {
            const searchInput = document.getElementById('search-food');
            renderFoodSelect(searchInput.value);
        }

        // --- RENDERIZAÇÃO DA DIETA ---

        function renderDiet() {
            const container = document.getElementById('diet-container');
            container.innerHTML = '';

            let dailyTotal = { cal: 0, carb: 0, prot: 0, fat: 0 };

            dietMeals.forEach(meal => {
                let mCal = 0, mCarb = 0, mProt = 0, mFat = 0;
                meal.foods.forEach(f => {
                    // Totais da refeição (Visual Header) - Soma tudo
                    mCal += f.totalCal;
                    mCarb += f.totalCarb;
                    mProt += f.totalProt;
                    mFat += f.totalFat;

                    // Totais Diários (Apenas Opção A)
                    if(f.option === 'A') {
                        dailyTotal.cal += f.totalCal;
                        dailyTotal.carb += f.totalCarb;
                        dailyTotal.prot += f.totalProt;
                        dailyTotal.fat += f.totalFat;
                    }
                });

                const groups = { 'A': [], 'B': [], 'C': [] };
                meal.foods.forEach(f => {
                    if(!groups[f.option]) groups[f.option] = [];
                    groups[f.option].push(f);
                });

                let contentHtml = '';
                ['A', 'B', 'C'].forEach(opt => {
                    if (groups[opt].length > 0) {
                        const showHeader = opt !== 'A' || (groups['B'].length > 0 || groups['C'].length > 0);
                        if (showHeader) {
                            contentHtml += `
                                <div class="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-500 uppercase tracking-wide border-y border-slate-100 mt-2">
                                    ${opt === 'A' ? 'Opção Principal' : `Opção ${opt}`}
                                </div>
                            `;
                        }
                        contentHtml += `<table class="w-full text-left text-sm">
                                    <tbody class="divide-y divide-slate-100">
                                        ${groups[opt].map((food) => {
                                            const originalIndex = meal.foods.indexOf(food);
                                            return `
                                            <tr class="hover:bg-slate-50 transition group">
                                                <td class="p-3 text-slate-700 font-medium pl-4 w-1/2">${food.name}</td>
                                                <td class="p-3 text-center text-slate-600 bg-slate-50/50 text-xs">${food.qty}g</td>
                                                <td class="p-3 text-center font-bold text-slate-700 text-xs">${food.totalCal.toFixed(0)} kcal</td>
                                                <td class="p-3 text-center text-slate-400 text-[10px] hidden sm:table-cell">C:${food.totalCarb.toFixed(0)} P:${food.totalProt.toFixed(0)} G:${food.totalFat.toFixed(0)}</td>
                                                <td class="p-3 text-center no-print w-10">
                                                    <button onclick="removeFood(${meal.id}, ${originalIndex})" class="text-slate-300 hover:text-red-500 transition" data-html2canvas-ignore="true">
                                                        <i class="fa-solid fa-times"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>`;
                    }
                });

                if (meal.foods.length === 0) {
                    contentHtml = `<div class="p-6 text-center text-slate-400 text-sm italic no-print">Nenhum alimento adicionado.</div>`;
                }

                const mealHtml = `
                    <div class="card bg-white rounded-xl shadow-sm theme-border border overflow-hidden break-inside-avoid relative group">
                        <button onclick="deleteMeal(${meal.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 no-print opacity-0 group-hover:opacity-100 transition z-10" title="Apagar Refeição" data-html2canvas-ignore="true">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <div class="meal-header theme-bg-light p-4 border-b theme-border flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i class="fa-solid fa-utensils theme-text"></i> ${meal.title}
                            </h3>
                            <div class="flex flex-wrap gap-3 text-xs font-semibold">
                                <div class="theme-text bg-white px-3 py-1 rounded-full border theme-border shadow-sm">~${mCal.toFixed(0)} kcal</div>
                                <div class="text-blue-600 bg-blue-50 px-2 py-1 rounded-full border border-blue-100">C: ${mCarb.toFixed(0)}g</div>
                                <div class="text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full border border-emerald-100">P: ${mProt.toFixed(0)}g</div>
                                <div class="text-yellow-600 bg-yellow-50 px-2 py-1 rounded-full border border-yellow-100">G: ${mFat.toFixed(0)}g</div>
                            </div>
                        </div>
                        <div class="p-0">${contentHtml}</div>
                    </div>
                `;
                container.innerHTML += mealHtml;
            });

            // --- ADICIONAR CARD DE RESUMO TOTAL ---
            const totalHtml = `
                <div class="card bg-slate-800 text-white rounded-xl shadow-md border border-slate-700 overflow-hidden break-inside-avoid mt-6">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa-solid fa-chart-pie text-emerald-400"></i> Resumo Total Diário
                        </h3>
                        <span class="text-xs text-slate-400 font-normal">(Soma das Opções A)</span>
                    </div>
                    <div class="p-6 grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Calorias</div>
                            <div class="text-3xl font-bold text-white">${dailyTotal.cal.toFixed(0)} <span class="text-sm font-normal text-slate-400">kcal</span></div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Carboidratos</div>
                            <div class="text-2xl font-bold text-blue-400">${dailyTotal.carb.toFixed(1)} <span class="text-sm font-normal text-slate-400">g</span></div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Proteínas</div>
                            <div class="text-2xl font-bold text-emerald-400">${dailyTotal.prot.toFixed(1)} <span class="text-sm font-normal text-slate-400">g</span></div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Gorduras</div>
                            <div class="text-2xl font-bold text-yellow-400">${dailyTotal.fat.toFixed(1)} <span class="text-sm font-normal text-slate-400">g</span></div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += totalHtml;
        }

        function addToPlan() {
            const mealId = parseInt(document.getElementById('select-meal').value);
            const foodId = parseInt(document.getElementById('select-food').value);
            const qty = parseFloat(document.getElementById('input-qty').value);
            const option = document.querySelector('input[name="meal-option"]:checked').value;
            if (isNaN(mealId)) { showToast("Crie ou selecione uma refeição!", "error"); return; }
            if (!qty || qty <= 0) { showToast("Quantidade inválida!", "error"); return; }
            
            // Buscar na lista filtrada ou completa
            const food = foodDatabase.find(f => f.id === foodId);
            const meal = dietMeals.find(m => m.id === mealId);
            
            if (food && meal) {
                const factor = qty / 100;
                const newEntry = {
                    ...food,
                    qty: qty,
                    option: option,
                    totalCal: food.cal * factor,
                    totalCarb: food.carb * factor,
                    totalProt: food.prot * factor,
                    totalFat: food.fat * factor
                };
                meal.foods.push(newEntry);
                renderDiet();
                showToast(`Adicionado à ${meal.title}`);
                
                // Limpar busca para facilitar proxima inserção
                document.getElementById('search-food').value = '';
                renderFoodSelect();
            }
        }

        function removeFood(mealId, foodIndex) {
            const meal = dietMeals.find(m => m.id === mealId);
            if(meal) {
                meal.foods.splice(foodIndex, 1);
                renderDiet();
                showToast("Item removido", "neutral");
            }
        }

        function updateDateDisplay() {
            const dateInput = document.getElementById('diet-date');
            const display = document.getElementById('date-display');
            const dateVal = dateInput.value;
            if(dateVal) {
                const [year, month, day] = dateVal.split('-');
                display.innerText = `${day}/${month}/${year}`;
            } else {
                display.innerText = "";
            }
        }

        // --- IMPRESSÃO (NATIVO) ---
        function printDiet() {
            // Atualiza data antes de imprimir
            updateDateDisplay();
            window.print();
        }

        function setTheme(themeName) {
            currentTheme = themeName;
            const t = themes[themeName];
            const root = document.documentElement;
            root.style.setProperty('--primary', t.primary);
            root.style.setProperty('--primary-hover', t.hover);
            root.style.setProperty('--primary-light', t.light);
            root.style.setProperty('--primary-text', t.text);
            root.style.setProperty('--border-color', t.border);
            showToast(`Tema alterado para ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`);
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const result = e.target.result;
                    document.getElementById('logo-img-main').src = result;
                    document.getElementById('logo-img-main').classList.remove('hidden');
                    document.getElementById('logo-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function handleLogoUploadFooter(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const result = e.target.result;
                    document.getElementById('logo-img-footer').src = result;
                    document.getElementById('logo-img-footer').classList.remove('hidden');
                    document.getElementById('logo-placeholder-footer').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function createCustomFood() {
            const name = document.getElementById('new-name').value;
            const cal = parseFloat(document.getElementById('new-cal').value);
            if (!name || isNaN(cal)) { showToast("Preencha os dados!", "error"); return; }
            const newId = Date.now(); // ID único via timestamp
            foodDatabase.push({
                id: newId,
                name: name,
                cal: cal,
                carb: parseFloat(document.getElementById('new-carb').value) || 0,
                prot: parseFloat(document.getElementById('new-prot').value) || 0,
                fat: parseFloat(document.getElementById('new-fat').value) || 0
            });
            
            // Limpa form e busca
            document.getElementById('search-food').value = '';
            renderFoodSelect();
            
            // Seleciona o novo alimento criado
            document.getElementById('select-food').value = newId;
            
            toggleCustomForm();
            showToast("Alimento criado!");
        }

        function toggleCustomForm() {
            document.getElementById('custom-food-form').classList.toggle('hidden');
        }

        function showToast(message, type = "success") {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        init();
    </script>
</body>
</html>