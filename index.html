<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Alimentar - Dietas Personalizadas</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- Chart.js para o Gráfico -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- LZ-String para compressão de URL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    
    <style>
        :root {
            --primary: #059669;
            --primary-hover: #047857;
            --primary-light: #ecfdf5;
            --primary-text: #065f46;
            --border-color: #d1fae5;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
        }
        
        .theme-bg { background-color: var(--primary) !important; }
        .theme-bg-hover:hover { background-color: var(--primary-hover) !important; }
        .theme-bg-light { background-color: var(--primary-light) !important; }
        .theme-text { color: var(--primary) !important; }
        .theme-text-dark { color: var(--primary-text) !important; }
        .theme-border { border-color: var(--border-color) !important; }
        .theme-ring:focus { --tw-ring-color: var(--primary); }

        /* Remove setas do input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* --- VISIBILIDADE DO LINK DE SUBSTITUIÇÃO --- */
        /* Padrão: Oculto no modo edição */
        .patient-footer-link { display: none !important; }
        
        /* Visível apenas na impressão */
        @media print {
            .patient-footer-link { display: block !important; }
        }
        /* Visível apenas no modo visualização (link compartilhado) */
        body.view-mode .patient-footer-link { display: block !important; }


        @media (max-width: 768px) {
            .backdrop-blur-sm {
                backdrop-filter: none !important;
                background-color: rgba(255, 255, 255, 0.9) !important;
            }
            /* Ajuste fino para tabelas no mobile */
            .col-name { width: 40% !important; }
            .col-qty { width: 15% !important; }
            .col-cal { width: 15% !important; }
            .col-macro { width: 30% !important; display: block; }
            
            /* Tabela de refeições mobile */
            .meal-table-row {
                display: grid;
                grid-template-columns: 1fr auto auto;
                gap: 8px;
                padding: 10px;
                border-bottom: 1px solid #f1f5f9;
                align-items: center;
            }
            .meal-table-macros {
                grid-column: 1 / -1;
                display: flex;
                justify-content: space-between;
                background: #f8fafc;
                padding: 6px 10px;
                border-radius: 6px;
                font-size: 11px;
                color: #64748b;
                margin-top: 4px;
            }
        }

        /* --- CONFIGURAÇÃO DE IMPRESSÃO --- */
        @media print {
            @page { margin: 0; size: auto; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; box-shadow: none !important; text-shadow: none !important; }
            body { background-color: white; padding: 10mm 10mm !important; margin: 0 !important; zoom: 0.95; }
            
            /* Ocultar elementos específicos na impressão */
            .no-print, #toast, #splash-screen, #patient-welcome-screen, .hide-in-print, .nutritionist-only, .hidden-print-section { display: none !important; }
            
            /* OCULTAR MACROS INDIVIDUAIS NO PDF */
            .col-macro, .meal-table-macros { display: none !important; }

            /* Garantir visibilidade */
            .print-only { display: block !important; }
            .container, #document-area { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 0 !important; display: block !important; }
            
            main.grid { display: block !important; }
            .lg\:col-span-8, .lg\:col-span-9 { width: 100% !important; }
            
            /* Ajuste de tabela para não quebrar no print */
            table { width: 100% !important; table-layout: fixed !important; }
            
            /* Larguras personalizadas quando macros estão ocultos no print */
            .col-name { width: 60% !important; }
            .col-qty { width: 20% !important; text-align: center !important; } 
            .col-cal { width: 20% !important; text-align: center !important; }
            .col-actions { display: none !important; width: 0 !important; }
            
            .meal-card { break-inside: auto !important; page-break-inside: auto !important; border: 1px solid #ddd; margin-bottom: 20px !important; display: block !important; box-shadow: none !important; border-radius: 8px !important; }
            .meal-header { break-after: avoid; page-break-after: avoid; background-color: #f8fafc !important; border-bottom: 1px solid #e2e8f0 !important; }
            tr { break-inside: avoid; }
            .totals-footer { break-before: avoid; page-break-before: avoid; background-color: #f1f5f9 !important; border-top: 2px solid #e2e8f0 !important; }
            
            .summary-card { padding: 15px 20px !important; background-color: #1e293b !important; color: white !important; border-radius: 12px !important; margin-top: 20px !important; border: 1px solid #334155 !important; break-inside: avoid !important; page-break-inside: avoid !important; display: block !important; }
            .summary-card h3 { font-size: 16px !important; margin-bottom: 10px !important; padding-bottom: 8px !important; border-bottom: 1px solid #334155 !important; }
            .summary-card .grid { display: flex !important; justify-content: space-between !important; gap: 15px !important; padding: 5px !important; }
            .summary-card .text-3xl { font-size: 20px !important; margin-top: 5px !important; }
            .summary-card .text-2xl { font-size: 18px !important; margin-top: 5px !important; }
            
            #btn-add-row { display: none !important; }
            .col-history-action { display: none !important; width: 0 !important; }
            
            /* AJUSTE DO GRÁFICO NO PDF (Para não cortar a direita) */
            #chart-container { 
                break-inside: avoid; 
                page-break-inside: avoid; 
                height: 300px !important; 
                width: 85% !important; /* Reduzido para 85% para garantir que não corte nas bordas */
                margin: 20px auto !important; 
                display: block !important;
            }
            #chart-container canvas {
                max-width: 100% !important;
                height: auto !important;
            }
            
            #page-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 30px; text-align: center; font-size: 10px; color: #94a3b8; font-weight: 500; background-color: white; display: flex !important; align-items: center; justify-content: center; border-top: 1px dashed #e2e8f0; z-index: 9999; margin-bottom: 0 !important; padding-bottom: 5px; }
            
            /* Correção Logo na Impressão */
            #logo-container-wrapper { display: block !important; }
            .upload-ui-controls { display: none !important; }

            /* Estilos para os marcadores de hábito na impressão */
            .habit-check { 
                border: 1px solid #cbd5e1 !important; 
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            .habit-check.checked {
                background-color: var(--primary) !important;
                border-color: var(--primary) !important;
            }
        }

        .editable-div {
            min-height: 100px;
            overflow: hidden;
            outline: none;
        }
        /* Atualizado para funcionar em qualquer campo editável (como nas atividades) */
        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .clean-input {
            background: transparent;
            border: none;
            text-align: center;
            width: 100%;
            outline: none;
        }
        .clean-input:focus { background: rgba(0,0,0,0.02); }

        .measure-cell {
            padding: 8px;
            border: 1px solid #cbd5e1;
            text-align: center;
            min-width: 80px; /* Garante largura mínima no mobile */
        }

        [contenteditable="true"]:hover {
            background-color: #f8fafc;
            cursor: text;
            text-decoration: underline;
            text-decoration-style: dashed;
            text-decoration-color: #cbd5e1;
        }
        [contenteditable="true"]:focus {
            background-color: #ffffff;
            outline: 2px solid var(--primary-light);
            text-decoration: none;
            border-radius: 4px;
        }

        .qty-input {
            width: 45px;
            text-align: center;
            background-color: transparent;
            border-bottom: 1px dashed #cbd5e1;
            transition: border 0.2s;
        }
        .qty-input:focus {
            outline: none;
            background-color: white;
            border-bottom: 2px solid var(--primary);
            font-weight: bold;
        }
        
        .emoji-btn:hover { transform: scale(1.2); }

        /* --- MODO PACIENTE (VIEW MODE) - CSS --- */
        body.view-mode .nutritionist-only { display: none !important; }
        
        /* OCULTAR MACROS INDIVIDUAIS NO MODO LINK */
        body.view-mode .col-macro { display: none !important; }
        body.view-mode .meal-table-macros { display: none !important; }
        
        /* Ajuste do layout Desktop no Modo View */
        body.view-mode .lg\:col-span-8, 
        body.view-mode .lg\:col-span-9 { 
            grid-column: span 12 / span 12 !important; 
            width: 100% !important;
        }
        
        /* AJUSTE DE ESTÉTICA DESKTOP NO LINK COMPARTILHADO */
        @media (min-width: 1024px) {
            /* Descola os alimentos da borda esquerda no modo visualização */
            body.view-mode .col-name {
                padding-left: 2rem !important; 
            }
            body.view-mode .meal-header {
                padding-left: 1.5rem !important;
            }
        }
        
        /* Container centralizado e limitado no Desktop para não ficar "esticado" demais */
        body.view-mode #document-area {
            max-width: 1024px !important;
            margin: 0 auto;
        }

        body.view-mode [contenteditable] { 
            pointer-events: none; 
            border: none; 
            background: transparent !important;
            text-decoration: none !important;
            padding: 0;
        }
        body.view-mode input, body.view-mode select, body.view-mode .qty-input {
            pointer-events: none;
            border: none;
            background: transparent !important;
            appearance: none;
        }
        body.view-mode .qty-input { font-weight: bold; border-bottom: none; width: auto; max-width: 50px; }
        body.view-mode .measure-cell { border-color: #e2e8f0; }
        body.view-mode .col-actions { display: none !important; }
        body.view-mode .theme-ring { box-shadow: none !important; }
        body.view-mode .upload-ui-controls { display: none !important; } 
        
        body.view-mode .clean-input { 
            white-space: normal; 
            text-overflow: clip; 
            overflow: visible;
        }

        /* Estilos para Metas de Hábito */
        .habit-grid {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            gap: 4px;
        }
        @media (min-width: 640px) {
            .habit-grid {
                grid-template-columns: repeat(30, 1fr);
                gap: 6px;
            }
        }
        .habit-check {
            aspect-ratio: 1;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }
        .habit-check:hover { transform: scale(1.1); }
        .habit-check.checked { background-color: var(--primary); border-color: var(--primary); }
        
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- ============================== -->
    <!-- TELA INICIAL (SPLASH SCREEN - NUTRICIONISTA) -->
    <!-- ============================== -->
    <div id="splash-screen" class="fixed inset-0 z-[100] bg-gradient-to-br from-emerald-600 to-teal-900 flex flex-col items-center justify-center text-white px-4 transition-opacity duration-700 ease-out no-print">
        <div class="max-w-md w-full bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-2xl shadow-2xl text-center transform transition-all hover:scale-[1.01]">
            <div class="mb-6 inline-flex items-center justify-center w-20 h-20 bg-white rounded-full text-emerald-600 shadow-lg">
                <i class="fa-solid fa-leaf text-4xl"></i>
            </div>
            <h1 class="text-3xl font-black mb-2 tracking-tight">Sejam bem vindos nutris!</h1>
            <p class="text-lg opacity-90 mb-6 leading-relaxed font-light">Aproveite o máximo da ferramenta, ela te ajudará além do calculo da dieta.</p>
            <div class="bg-black/20 rounded-lg p-3 mb-8 inline-block">
                <p class="text-sm font-medium flex items-center gap-2 justify-center">
                    <span class="opacity-75">Feito por um nutri:</span>
                    <a href="https://instagram.com/romulof.monteiro" target="_blank" class="font-bold hover:text-emerald-200 transition flex items-center gap-1"><i class="fa-brands fa-instagram"></i> romulof.monteiro</a>
                </p>
            </div>
            <button onclick="closeSplash()" class="w-full bg-white text-emerald-800 font-bold py-4 rounded-xl shadow-lg hover:bg-emerald-50 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2">
                Começar a Planejar <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- ============================== -->
    <!-- TELA DE BOAS VINDAS (PACIENTE) -->
    <!-- ============================== -->
    <div id="patient-welcome-screen" class="fixed inset-0 z-[100] bg-gradient-to-br from-blue-500 to-indigo-900 hidden flex-col items-center justify-center text-white px-4 transition-opacity duration-700 ease-out no-print">
        <div class="max-w-md w-full bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-2xl shadow-2xl text-center transform transition-all hover:scale-[1.01]">
            <div class="mb-6 inline-flex items-center justify-center w-20 h-20 bg-white rounded-full text-blue-600 shadow-lg">
                <i class="fa-solid fa-heart-pulse text-4xl"></i>
            </div>
            <h1 class="text-2xl font-bold mb-4">Olá!</h1>
            <p class="text-lg opacity-90 mb-6 leading-relaxed font-light">
                Seja muito bem-vindo(a) à sua jornada de cuidados. Fique à vontade e conte comigo sempre que precisar.
                <br><br>
                <strong>Abs, Nutri</strong>
            </p>
            <button onclick="closePatientWelcome()" class="w-full bg-white text-blue-800 font-bold py-4 rounded-xl shadow-lg hover:bg-blue-50 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2">
                Visualizar minha dieta <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Header Principal -->
    <header class="theme-bg text-white shadow-lg no-print transition-colors duration-300">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="flex items-center justify-center w-12 h-12 bg-white/20 rounded-lg border-2 border-white/30 backdrop-blur-sm">
                    <span id="header-initials" class="text-xl font-black tracking-tighter">RFM</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold">Plano Alimentar</h1>
                    <p class="text-xs opacity-90">Dietas Personalizadas</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openPatientModal()" class="nutritionist-only bg-slate-900/30 hover:bg-slate-900/50 text-white px-4 py-2 rounded-lg font-semibold text-sm transition shadow-sm flex items-center gap-2 border border-white/20">
                    <i class="fa-solid fa-users"></i> <span id="current-patient-label">Pacientes</span>
                </button>
                <button onclick="openShareModal()" class="nutritionist-only bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm transition shadow-sm flex items-center gap-2 border border-blue-400">
                    <i class="fa-solid fa-share-nodes"></i> Compartilhar Link
                </button>
                <button onclick="printDiet()" class="bg-white text-slate-700 hover:bg-slate-100 px-4 py-2 rounded-lg font-semibold text-sm transition shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-print text-slate-600"></i> Imprimir PDF
                </button>
            </div>
        </div>
    </header>

    <!-- Área de Conteúdo -->
    <div id="document-area" class="bg-white md:bg-transparent w-full max-w-[1600px] mx-auto transition-all"> 
        
        <!-- Cabeçalho do Documento -->
        <div class="container mx-auto px-4 mt-6 mb-2">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center text-center gap-2 w-full break-inside-avoid">
                <div id="logo-container-wrapper" class="mb-4 relative group cursor-pointer">
                    <img id="logo-img-main" src="" class="h-24 object-contain hidden mx-auto">
                    <div id="logo-placeholder" class="upload-ui-controls w-24 h-24 bg-slate-50 rounded-full border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400 mx-auto" onclick="document.getElementById('logo-upload').click()">
                        <i class="fa-solid fa-camera text-2xl mb-1"></i>
                        <span class="text-[10px]">Add Logo</span>
                    </div>
                    <span class="upload-ui-controls text-xs text-blue-500 hover:underline mt-1 block no-print" onclick="document.getElementById('logo-upload').click()">Alterar Logo (Max 2MB)</span>
                    <input type="file" id="logo-upload" accept="image/*" class="hidden" onchange="handleImageUpload(event, 'logo-img-main', 'logo-placeholder'); triggerAutoSave();">
                </div>

                <div class="w-full max-w-2xl space-y-2 flex flex-col items-center">
                    <div id="patient-name-container" class="w-full">
                        <input type="text" id="patient-name" class="clean-input text-2xl font-bold text-slate-800 placeholder-slate-300 w-full" placeholder="Nome do Paciente" value="Paciente Exemplo" onkeyup="triggerAutoSave()">
                    </div>
                    <div id="patient-goal-container" class="w-full">
                        <input type="text" id="patient-goal" class="clean-input text-md font-medium text-slate-600 placeholder-slate-300 w-full" placeholder="Objetivo" value="Objetivo: Hipertrofia" onkeyup="triggerAutoSave()">
                    </div>
                    <div class="relative w-full">
                        <input type="date" id="diet-date" class="clean-input text-sm text-slate-500 font-medium no-print w-full" onchange="updateDateDisplay(); triggerAutoSave();">
                        <span id="date-display" class="hidden print-only text-sm text-slate-500 font-medium w-full text-center block"></span>
                    </div>
                </div>
            </div>
        </div>

        <main class="flex-grow container mx-auto px-4 py-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- COLUNA DA ESQUERDA (LATERAL) -->
            <div class="lg:col-span-3 no-print nutritionist-only">
                <div class="sticky top-4 space-y-6 max-h-[calc(100vh-2rem)] overflow-y-auto custom-scroll pr-1 pb-4">
                    <!-- 1. Cor -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-xs font-bold text-slate-500 uppercase mb-3">Personalizar Cor</h3>
                        <div class="grid grid-cols-5 gap-3">
                            <button onclick="setTheme('emerald'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-emerald-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                            <button onclick="setTheme('blue'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-blue-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                            <button onclick="setTheme('indigo'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-indigo-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                            <button onclick="setTheme('rose'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-rose-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                            <button onclick="setTheme('amber'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-amber-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                            <button onclick="setTheme('purple'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-purple-600 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                            <button onclick="setTheme('cyan'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-cyan-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                            <button onclick="setTheme('teal'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-teal-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                            <button onclick="setTheme('lime'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-lime-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                            <button onclick="setTheme('fuchsia'); triggerAutoSave();" class="w-8 h-8 rounded-full bg-fuchsia-500 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-slate-300"></button>
                        </div>
                    </div>

                    <!-- 2. Calculadora -->
                    <div id="nutritionist-calculator" class="bg-slate-800 text-white p-5 rounded-xl shadow-lg border border-slate-700 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fa-solid fa-calculator text-6xl"></i></div>
                        <h2 class="font-bold text-lg mb-4 flex items-center gap-2 relative z-10">Área do Nutricionista</h2>
                        <div class="space-y-3 relative z-10 text-sm">
                            <div class="flex gap-2 bg-slate-700/50 p-1 rounded-lg">
                                <label class="flex-1 text-center cursor-pointer">
                                    <input type="radio" name="calc-sex" value="m" checked class="peer sr-only" onchange="calculateEnergy(); triggerAutoSave();">
                                    <div class="py-1.5 rounded peer-checked:bg-blue-600 peer-checked:text-white text-slate-400 transition text-xs font-bold">Homem</div>
                                </label>
                                <label class="flex-1 text-center cursor-pointer">
                                    <input type="radio" name="calc-sex" value="f" class="peer sr-only" onchange="calculateEnergy(); triggerAutoSave();">
                                    <div class="py-1.5 rounded peer-checked:bg-pink-600 peer-checked:text-white text-slate-400 transition text-xs font-bold">Mulher</div>
                                </label>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div><label class="text-[10px] text-slate-400 uppercase">Peso (kg)</label><input type="number" id="calc-weight" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-center outline-none" placeholder="0" onkeyup="calculateEnergy(); triggerAutoSave();"></div>
                                <div><label class="text-[10px] text-slate-400 uppercase">Altura (cm)</label><input type="number" id="calc-height" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-center outline-none" placeholder="0" onkeyup="calculateEnergy(); triggerAutoSave();"></div>
                                <div><label class="text-[10px] text-slate-400 uppercase">Idade</label><input type="number" id="calc-age" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-center outline-none" placeholder="0" onkeyup="calculateEnergy(); triggerAutoSave();"></div>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 uppercase">Fórmula TMB</label>
                                <select id="calc-formula" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-xs outline-none" onchange="toggleBodyFatInput(); calculateEnergy(); triggerAutoSave();">
                                    <option value="mifflin" selected>Mifflin-St Jeor (Padrão)</option>
                                    <option value="harris">Harris-Benedict</option>
                                    <option value="tinsley_ph">Tinsley (Peso e Altura)</option>
                                    <option value="tinsley_katch">Tinsley / Katch–McArdle (MLG)</option>
                                    <option value="cunningham">Cunningham, 1980 (MLG)</option>
                                </select>
                            </div>
                            <div id="bf-container" class="hidden">
                                <label class="text-[10px] text-slate-400 uppercase">% Gordura (BF)</label>
                                <input type="number" id="calc-bf" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-center outline-none" placeholder="Ex: 15" onkeyup="calculateEnergy(); triggerAutoSave();">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 uppercase">Nível de Atividade</label>
                                <select id="calc-activity" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-white text-xs outline-none" onchange="calculateEnergy(); triggerAutoSave();">
                                    <option value="1.2">Sedentário (Pouco ou nenhum)</option>
                                    <option value="1.375">Leve (1-3 dias/sem)</option>
                                    <option value="1.55" selected>Moderado (3-5 dias/sem)</option>
                                    <option value="1.725">Intenso (6-7 dias/sem)</option>
                                    <option value="1.9">Muito Intenso (Atleta)</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-slate-700">
                                <div class="text-center"><div class="text-[10px] text-slate-400">IMC</div><div id="res-bmi" class="font-bold text-emerald-400 text-lg">--</div></div>
                                <div class="text-center"><div class="text-[10px] text-slate-400">Basal (TMB)</div><div id="res-bmr" class="font-bold text-white text-sm">--</div></div>
                                <div class="text-center"><div class="text-[10px] text-slate-400">Total (GET)</div><div id="res-tdee" class="font-bold text-white text-sm">--</div></div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Metas -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="font-bold text-sm mb-3 flex items-center gap-2 text-slate-700 uppercase tracking-wide"><i class="fa-solid fa-bullseye text-blue-500"></i> Metas da Dieta</h2>
                        <div class="space-y-3">
                            <div><label class="text-xs font-bold text-slate-500">Meta Calórica (Kcal)</label><input type="number" id="target-cal" class="w-full border border-slate-300 rounded p-2 text-center font-bold text-slate-700 focus:ring-2 focus:ring-blue-200 outline-none" value="2000" onkeyup="renderDiet(); triggerAutoSave();"></div>
                            <div><label class="text-xs font-bold text-slate-500">Meta de Fibras (g)</label><input type="number" id="target-fiber" class="w-full border border-slate-300 rounded p-2 text-center font-bold text-slate-700 focus:ring-2 focus:ring-emerald-200 outline-none" value="25" onkeyup="renderDiet(); triggerAutoSave();" placeholder="Ex: 25"></div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <div class="flex justify-between text-[10px] text-slate-400 uppercase font-bold mb-1"><span>Carb</span><span>Prot</span><span>Gord</span></div>
                                <div class="flex gap-2">
                                    <input type="number" id="target-carb-pct" class="w-full p-1 text-center border rounded text-xs" value="50" onkeyup="renderDiet(); triggerAutoSave();">
                                    <input type="number" id="target-prot-pct" class="w-full p-1 text-center border rounded text-xs" value="30" onkeyup="renderDiet(); triggerAutoSave();">
                                    <input type="number" id="target-fat-pct" class="w-full p-1 text-center border rounded text-xs" value="20" onkeyup="renderDiet(); triggerAutoSave();">
                                </div>
                                <div class="text-[10px] text-center mt-1 text-slate-400">Total: <span id="total-pct-display">100</span>%</div>
                            </div>
                            <div id="comparison-widget" class="text-xs space-y-1 pt-2 border-t border-slate-100"></div>
                        </div>
                    </div>

                    <!-- 4. Adicionar -->
                    <div id="add-food-section" class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700"><i class="fa-solid fa-carrot theme-text"></i> Adicionar Refeições</h2>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Refeição</label><select id="select-meal" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none text-sm font-semibold text-slate-700"></select></div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Opção</label>
                                <div class="flex gap-2">
                                    <label class="flex-1 cursor-pointer"><input type="radio" name="meal-option" value="A" checked class="peer sr-only"><div class="text-center py-2 border rounded-lg peer-checked:bg-slate-800 peer-checked:text-white text-xs font-semibold transition">Opção A</div></label>
                                    <label class="flex-1 cursor-pointer"><input type="radio" name="meal-option" value="B" class="peer sr-only"><div class="text-center py-2 border rounded-lg peer-checked:bg-slate-800 peer-checked:text-white text-xs font-semibold transition">Opção B</div></label>
                                    <label class="flex-1 cursor-pointer"><input type="radio" name="meal-option" value="C" class="peer sr-only"><div class="text-center py-2 border rounded-lg peer-checked:bg-slate-800 peer-checked:text-white text-xs font-semibold transition">Opção C</div></label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Alimento</label>
                                <div class="relative mb-2">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i class="fa-solid fa-search text-slate-400"></i></div>
                                    <input type="text" id="search-food" onkeyup="filterFoods()" placeholder="Buscar alimento..." class="w-full p-2 pl-10 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none text-sm">
                                </div>
                                <div id="search-hint" class="hidden bg-blue-50 text-blue-600 text-xs p-2 rounded mb-2 flex items-center gap-2 border border-blue-100 animate-pulse"><i class="fa-solid fa-arrow-down"></i> Selecione abaixo:</div>
                                <select id="select-food" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none custom-scroll text-sm"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Quantidade</label>
                                <div class="flex gap-2">
                                    <input type="number" id="input-qty" value="100" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none" placeholder="100">
                                    <span class="flex items-center bg-slate-100 border border-slate-200 px-3 rounded-lg text-slate-500 text-sm">g/ml</span>
                                </div>
                            </div>
                            <button onclick="addToPlan(); triggerAutoSave();" class="w-full theme-bg theme-bg-hover text-white font-semibold py-3 rounded-lg transition shadow-md flex justify-center items-center gap-2"><i class="fa-solid fa-check"></i> Inserir</button>
                        </div>
                    </div>

                    <!-- 5. Nova Refeição -->
                    <div id="new-meal-section" class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700"><i class="fa-solid fa-calendar-plus theme-text"></i> Criar Refeição Extra</h2>
                        <div class="flex gap-2">
                            <input type="text" id="new-meal-name" placeholder="Ex: Pré-Treino..." class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg theme-ring outline-none text-sm">
                            <button onclick="addNewMeal(); triggerAutoSave();" class="bg-slate-800 text-white px-4 rounded-lg hover:bg-slate-700 transition"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>

                    <!-- 6. Custom Foods -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 nutrition-only">
                        <h2 class="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700 cursor-pointer" onclick="toggleCustomForm()">
                            <i class="fa-solid fa-pen-to-square text-blue-500"></i> Adicionar Novos Alimentos
                            <i class="fa-solid fa-chevron-down ml-auto text-xs text-slate-400"></i>
                        </h2>
                        <div id="custom-food-form" class="hidden space-y-3 pt-2 border-t border-slate-100">
                            <input type="text" id="new-name" placeholder="Nome do Alimento" class="w-full p-2 text-sm border rounded">
                            <div class="flex gap-2 mb-2"><input type="number" id="new-serving" placeholder="Porção (g)" value="100" class="w-1/3 p-2 text-sm border rounded bg-slate-50 text-center font-semibold"><span class="flex items-center text-xs text-slate-500">gramas (padrão)</span></div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-[10px] text-slate-400 font-bold ml-1">Kcal</label><input type="number" id="new-cal" placeholder="Kcal" class="w-full p-2 text-sm border rounded"></div>
                                <div><label class="text-[10px] text-slate-400 font-bold ml-1">Carb</label><input type="number" id="new-carb" placeholder="Carb (g)" class="w-full p-2 text-sm border rounded"></div>
                                <div><label class="text-[10px] text-slate-400 font-bold ml-1">Prot</label><input type="number" id="new-prot" placeholder="Prot (g)" class="w-full p-2 text-sm border rounded"></div>
                                <div><label class="text-[10px] text-slate-400 font-bold ml-1">Gord</label><input type="number" id="new-fat" placeholder="Gord (g)" class="w-full p-2 text-sm border rounded"></div>
                                <div class="col-span-2"><label class="text-[10px] text-slate-400 font-bold ml-1">Fibras</label><input type="number" id="new-fiber" placeholder="Fibras (g)" class="w-full p-2 text-sm border rounded"></div>
                            </div>
                            <button onclick="createCustomFood()" class="w-full bg-blue-50 text-blue-600 hover:bg-blue-100 py-2 rounded-lg text-sm font-semibold transition border border-blue-200 mt-2">Salvar no Banco</button>
                            <div class="mt-4 pt-4 border-t border-slate-100">
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="exportFoodBackup()" class="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 py-2 rounded text-xs font-bold transition border border-indigo-200"><i class="fa-solid fa-download"></i> Baixar Lista</button>
                                    <button onclick="document.getElementById('food-backup-upload').click()" class="bg-slate-100 text-slate-600 hover:bg-slate-200 py-2 rounded text-xs font-bold transition border border-slate-300"><i class="fa-solid fa-upload"></i> Restaurar Lista</button>
                                    <input type="file" id="food-backup-upload" accept=".json" class="hidden" onchange="importFoodBackup(event)">
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-100"><button onclick="clearCustomFoods()" class="text-xs text-red-400 hover:text-red-600 underline w-full text-center">Limpar alimentos salvos</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUNA DA DIREITA AUMENTADA -->
            <div class="lg:col-span-9 space-y-6 w-full">
                <div id="diet-container" class="space-y-6"></div>

                <!-- Nova Seção de Metas (Metas de Hábito) -->
                <div id="habit-goals-section" class="mt-6 break-inside-avoid relative group">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 text-lg flex items-center gap-2"><i class="fa-solid fa-list-check theme-text"></i> Metas</h3>
                        <div class="flex gap-2">
                            <button onclick="addCustomGoal()" class="nutritionist-only bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded text-xs font-bold transition border border-slate-300"><i class="fa-solid fa-plus"></i> Adicionar meta</button>
                            <button onclick="hideSection('habit-goals-section')" class="nutritionist-only bg-white text-slate-300 hover:text-red-500 px-2 py-1 rounded text-xs transition border border-transparent hover:border-red-100"><i class="fa-solid fa-trash-can"></i> Excluir seção</button>
                        </div>
                    </div>
                    
                    <div id="habit-goals-container" class="space-y-4">
                        <!-- Metas inseridas aqui dinamicamente -->
                    </div>
                </div>

                <!-- Metas (Texto Livre) -->
                <div id="goals-card" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-8 break-inside-avoid relative group">
                    <button onclick="hideSection('goals-card')" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition no-print nutritionist-only opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash-can"></i></button>
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-bullseye theme-text"></i> Orientações e Recomendações</h3>
                    <div id="goals-area" class="editable-div w-full p-2 bg-transparent text-slate-700 leading-relaxed" contenteditable="true" placeholder="Digite aqui..." onblur="triggerAutoSave()"></div>
                </div>

                <!-- Seção de Atividade Física -->
                <div id="activity-section" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-6 break-inside-avoid relative group">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 text-lg flex items-center gap-2"><i class="fa-solid fa-person-running theme-text"></i> Atividade Física</h3>
                        <div class="flex gap-2 nutritionist-only">
                             <button onclick="hideSection('activity-section')" class="text-slate-300 hover:text-red-500 px-2 py-1 transition"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    
                    <div id="activity-list" class="space-y-4 mb-6"></div>
                    
                    <div class="flex justify-center mb-6 nutritionist-only">
                        <button onclick="addActivityRow()" class="bg-slate-50 hover:bg-slate-100 text-slate-600 px-3 py-1 rounded text-xs font-bold transition border border-slate-200"><i class="fa-solid fa-plus"></i> Adicionar nova atividade</button>
                    </div>

                    <div class="text-[10px] text-slate-400 text-center italic mt-4 border-t border-slate-100 pt-3">
                        “Consulte um profissional antes de iniciar ou alterar sua rotina de exercícios, pois as informações apresentadas não substituem acompanhamento especializado.”
                    </div>
                </div>

                <!-- Histórico -->
                <div id="history-card" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-6 break-inside-avoid w-full overflow-hidden relative group">
                    <button onclick="hideSection('history-card')" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition no-print nutritionist-only opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash-can"></i></button>
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-weight-scale theme-text"></i> Histórico da composição corporal</h3>
                    <div class="w-full overflow-x-auto"> <!-- Fix: Scroll horizontal no mobile -->
                        <table id="history-table" class="w-full text-xs text-center border-collapse border border-slate-300 min-w-[600px]"> <!-- Fix: Min width forçar scroll -->
                            <thead>
                                <tr class="bg-slate-100 text-slate-700 font-bold">
                                    <th class="measure-cell">Data</th>
                                    <th class="measure-cell">Peso</th>
                                    <th class="measure-cell">Cintura</th>
                                    <th class="measure-cell">Abdômen</th>
                                    <th class="measure-cell">Quadril</th>
                                    <th class="measure-cell">Braço(D/E)</th>
                                    <th class="measure-cell">Perna(D/E)</th>
                                    <th class="w-8 no-print col-history-action nutritionist-only"></th>
                                </tr>
                            </thead>
                            <tbody class="text-slate-700"></tbody>
                        </table>
                    </div>
                    <div class="mt-2 text-right nutritionist-only">
                         <button id="btn-add-row" onclick="addHistoryRow()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded text-xs font-bold transition border border-slate-300 hide-in-print"><i class="fa-solid fa-plus"></i> Adicionar Linha</button>
                    </div>
                    <div id="chart-container" class="mt-6 h-96 w-full"> <!-- Aumentado para 384px (h-96) -->
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>

                <!-- Rodapé -->
                <div class="mt-8 pt-8 border-t border-slate-300 flex flex-col md:flex-row justify-between items-center gap-8 text-slate-800 break-inside-avoid">
                    <div class="w-full md:w-1/2 flex flex-col gap-3 text-left">
                        <p class="text-xs font-bold text-slate-500 uppercase mb-[-5px]">Nutricionista</p>
                        <input type="text" id="prof-name" class="clean-input text-left font-bold text-lg placeholder-slate-400" placeholder="Nome do Profissional" onkeyup="triggerAutoSave(); updateInitials();">
                        <div class="flex items-center gap-2"><span class="font-semibold text-xs text-slate-500 w-8">CRN:</span><input type="text" id="prof-crn" class="clean-input text-left text-sm font-medium placeholder-slate-400 flex-grow" placeholder="00000" onkeyup="triggerAutoSave()"></div>
                        <div class="flex items-center gap-2"><i class="fa-brands fa-whatsapp text-green-600 text-lg w-8 text-center"></i><input type="text" id="prof-phone" class="clean-input text-left text-sm font-medium placeholder-slate-400 flex-grow" placeholder="(00) 00000-0000" onkeyup="triggerAutoSave()"></div>
                        <div class="flex items-center gap-2"><i class="fa-brands fa-instagram text-pink-600 text-lg w-8 text-center"></i><input type="text" id="prof-insta" class="clean-input text-left text-sm font-medium placeholder-slate-400 flex-grow" placeholder="@seu.perfil" onkeyup="triggerAutoSave()"></div>
                    </div>
                    <div class="w-full md:w-1/2 flex flex-col items-center md:items-end">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('logo-upload-footer').click()">
                            <img id="logo-img-footer" src="" class="h-24 object-contain hidden">
                            <div id="logo-placeholder-footer" class="upload-ui-controls w-32 h-24 bg-slate-50 rounded-lg border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400"><i class="fa-solid fa-image text-xl mb-1"></i><span class="text-[10px]">Logo/Assinatura</span></div>
                            <span class="upload-ui-controls text-xs text-blue-500 hover:underline mt-1 block text-center md:text-right no-print">Adicionar Imagem</span>
                            <input type="file" id="logo-upload-footer" accept="image/*" class="hidden" onchange="handleImageUpload(event, 'logo-img-footer', 'logo-placeholder-footer'); triggerAutoSave();">
                        </div>
                    </div>
                </div>
                <div class="text-center mt-10 pb-4 border-t border-slate-100 pt-4 break-inside-avoid">
                    <p class="text-[10px] text-slate-500 italic mb-1">Alimentos da tabela UNICAMP. Tabela Brasileira de Composição de Alimentos – TACO (4ª Edição)</p>
                    <p class="text-[10px] text-slate-400 font-medium">Criado por Rômulo F. Monteiro <span class="text-blue-400">@romulof.monteiro</span></p>
                </div>
            </div>
        </main>
    </div>

    <!-- RODAPÉ FIXO DE IMPRESSÃO -->
    <div id="page-footer" class="hidden print-only">RFM - Plano Alimentar - Dietas personalizadas</div>

    <!-- MODAL SUBSTITUIÇÃO -->
    <div id="substitution-modal" class="fixed inset-0 modal-overlay z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg"><i class="fa-solid fa-exchange-alt"></i> Encontrar Substituto</h3><button onclick="closeSubModal()" class="text-indigo-200 hover:text-white"><i class="fa-solid fa-times"></i></button></div>
            <div class="p-4 bg-indigo-50 border-b border-indigo-100">
                <div id="sub-source-info" class="text-sm text-indigo-900 mb-3 font-medium"></div>
                <div class="mb-3 relative"><i class="fa-solid fa-search absolute left-3 top-3 text-indigo-300 text-xs"></i><input type="text" id="sub-search-input" onkeyup="filterSubstitutes()" placeholder="Buscar substituto específico..." class="w-full pl-8 pr-3 py-2 text-sm border border-indigo-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 bg-white"></div>
                <div class="flex gap-2">
                    <button onclick="filterSubstitutes('carb')" id="btn-sub-carb" class="flex-1 py-2 rounded-lg text-xs font-bold border border-blue-200 bg-white text-blue-600 hover:bg-blue-50 transition shadow-sm">Igualar Carboidrato</button>
                    <button onclick="filterSubstitutes('prot')" id="btn-sub-prot" class="flex-1 py-2 rounded-lg text-xs font-bold border border-emerald-200 bg-white text-emerald-600 hover:bg-emerald-50 transition shadow-sm">Igualar Proteína</button>
                    <button onclick="filterSubstitutes('fat')" id="btn-sub-fat" class="flex-1 py-2 rounded-lg text-xs font-bold border border-yellow-200 bg-white text-yellow-600 hover:bg-yellow-50 transition shadow-sm">Igualar Gordura</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto custom-scroll p-0">
                <table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold text-xs sticky top-0 border-b bg-white z-10 shadow-sm"><tr><th class="p-3">Alimento</th><th class="p-3 text-center w-16">Qtd</th><th class="p-3 text-center w-14">Dif. Kcal</th><th class="p-3 text-center w-20">Ação</th></tr></thead><tbody id="sub-list" class="divide-y divide-slate-100 text-slate-700"></tbody></table>
            </div>
        </div>
    </div>

    <!-- MODAL INFORMATIVO DE COMPARTILHAMENTO -->
    <div id="share-info-modal" class="fixed inset-0 modal-overlay z-[70] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-share-nodes"></i> Compartilhar Link</h3>
                <button onclick="closeShareModal()" class="text-blue-200 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-600 mb-4 leading-relaxed">
                    Nesta seção, você pode salvar o link para envio ao paciente. Vale lembrar que o link é extenso, portanto recomenda-se utilizar sites de encurtamento de links. 
                    <br><br>
                    Caso prefira, você também pode salvar o arquivo em PDF para maior comodidade.
                </p>
                
                <div class="flex gap-3 mb-6">
                    <a href="https://tinyurl.com/" target="_blank" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 rounded-lg text-xs font-bold text-center border border-slate-300 transition">
                        <i class="fa-solid fa-link"></i> TinyURL
                    </a>
                    <a href="https://is.gd/create.php" target="_blank" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 rounded-lg text-xs font-bold text-center border border-slate-300 transition">
                        <i class="fa-solid fa-link"></i> is.gd
                    </a>
                </div>

                <button onclick="generateAndCopyLink()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fa-regular fa-copy"></i> Copiar Link Gerado
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL PACIENTES -->
    <div id="patient-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg"><i class="fa-solid fa-users"></i> Gerenciar Pacientes</h3><button onclick="closePatientModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button></div>
            <div class="p-4 bg-slate-50 border-b border-slate-200 space-y-3">
                <button onclick="createNewPatient()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition"><i class="fa-solid fa-user-plus"></i> Novo Paciente</button>
                <div class="grid grid-cols-2 gap-3 pt-2 border-t border-slate-200">
                     <button onclick="exportBackup()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-xs font-bold shadow-sm flex items-center justify-center gap-2 transition"><i class="fa-solid fa-download"></i> Baixar Backup</button>
                     <button onclick="document.getElementById('backup-upload').click()" class="bg-slate-600 hover:bg-slate-700 text-white py-2 px-3 rounded-lg text-xs font-bold shadow-sm flex items-center justify-center gap-2 transition"><i class="fa-solid fa-upload"></i> Restaurar Backup</button>
                    <input type="file" id="backup-upload" accept=".json" class="hidden" onchange="importBackup(event)">
                </div>
            </div>
            <div class="p-0 max-h-[50vh] overflow-y-auto custom-scroll"><ul id="patient-list" class="divide-y divide-slate-100"></ul><div id="empty-patients" class="p-8 text-center text-slate-400 text-sm italic hidden">Nenhum paciente salvo.</div></div>
        </div>
    </div>

    <div id="emoji-picker" class="fixed hidden bg-white rounded-xl shadow-2xl border border-slate-200 p-2 w-72 z-[70] grid grid-cols-6 gap-2"></div>
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3" data-html2canvas-ignore="true"><i class="fa-solid fa-circle-check text-emerald-400"></i><span id="toast-msg">Ação realizada</span></div>

    <script>
        function closeSplash() { const splash = document.getElementById('splash-screen'); splash.style.opacity = '0'; setTimeout(() => { splash.style.display = 'none'; }, 700); }
        
        function closePatientWelcome() {
             const welcome = document.getElementById('patient-welcome-screen');
             welcome.style.opacity = '0';
             setTimeout(() => {
                 welcome.style.display = 'none';
             }, 700);
        }

        // DADOS TACO (Resumido para o exemplo - manter sua lista completa)
        let foodDatabase = [
            { id: 101, name: "Arroz Integral, Cozido", cal: 124, carb: 25.8, prot: 2.6, fat: 1.0, fiber: 2.7 },
            { id: 102, name: "Arroz Tipo 1, Cozido", cal: 128, carb: 28.1, prot: 2.5, fat: 0.2, fiber: 1.6 },
            { id: 103, name: "Arroz Tipo 2, Cozido", cal: 130, carb: 28.2, prot: 2.6, fat: 0.4, fiber: 1.1 },
            { id: 104, name: "Aveia, Flocos Crus", cal: 394, carb: 66.6, prot: 13.9, fat: 8.5, fiber: 9.1 },
            { id: 120, name: "Feijão Preto, Cozido", cal: 77, carb: 14.0, prot: 4.5, fat: 0.5, fiber: 8.4 },
            { id: 413, name: "Frango, Peito, Grelhado", cal: 159, carb: 0.0, prot: 32.0, fat: 2.5, fiber: 0 },
            { id: 307, name: "Banana, Prata, Crua", cal: 98, carb: 26.0, prot: 1.3, fat: 0.1, fiber: 2.0 },
            { id: 418, name: "Ovo de Galinha, Cozido", cal: 146, carb: 0.6, prot: 13.3, fat: 9.5, fiber: 0 },
            { id: 129, name: "Pão Francês", cal: 300, carb: 58.6, prot: 8.0, fat: 3.1, fiber: 2.3 },
            { id: 511, name: "Manteiga, Com Sal", cal: 726, carb: 0.1, prot: 0.4, fat: 82.0, fiber: 0 }
            // Adicione aqui o restante se necessário, estou usando uma base segura.
        ];
        // RECARREGAR A LISTA COMPLETA DO SEU ARQUIVO ANTERIOR PARA NÃO PERDER DADOS
        // (Assumindo que você copiará a lista completa para cá se precisar de mais itens)

        const defaultMeals = [
            { id: 1, title: "Café da Manhã (Desjejum)", foods: [], observation: "" },
            { id: 2, title: "Lanche da Manhã (Colação)", foods: [], observation: "" },
            { id: 3, title: "Almoço", foods: [], observation: "" },
            { id: 4, title: "Lanche da Tarde", foods: [], observation: "" },
            { id: 5, title: "Jantar", foods: [], observation: "" },
            { id: 6, title: "Ceia", foods: [], observation: "" }
        ];
        
        const defaultActivities = [
             { id: 1, name: "Caminhada - Atual", desc: "Leve, 3x semana, 30min", rec: "Aumentar para 45min" },
             { id: 2, name: "Musculação - Atual", desc: "4x semana, foco hipertrofia", rec: "Manter intensidade" },
             { id: 3, name: "Deslocamento Ativo - Atual", desc: "Ir a pé para o trabalho", rec: "" }
        ];

        let dietMeals = JSON.parse(JSON.stringify(defaultMeals));
        let customGoals = []; // ARRAY PARA AS NOVAS METAS
        let physicalActivities = JSON.parse(JSON.stringify(defaultActivities)); // Array para Atividades
        let currentTheme = 'emerald';
        let showGoals = true;
        let currentPatientId = null;
        let saveTimeout;
        let evolutionChart = null;

        const themes = { emerald: { primary: '#059669', hover: '#047857', light: '#ecfdf5', text: '#065f46', border: '#d1fae5' }, blue: { primary: '#2563eb', hover: '#1d4ed8', light: '#eff6ff', text: '#1e40af', border: '#dbeafe' }, indigo: { primary: '#4f46e5', hover: '#4338ca', light: '#eef2ff', text: '#3730a3', border: '#e0e7ff' }, rose: { primary: '#e11d48', hover: '#be123c', light: '#fff1f2', text: '#9f1239', border: '#ffe4e6' }, amber: { primary: '#d97706', hover: '#b45309', light: '#fffbeb', text: '#92400e', border: '#fef3c7' }, purple: { primary: '#9333ea', hover: '#7e22ce', light: '#f3e8ff', text: '#6b21a8', border: '#e9d5ff' }, cyan: { primary: '#06b6d4', hover: '#0891b2', light: '#ecfeff', text: '#155e75', border: '#cffafe' }, teal: { primary: '#14b8a6', hover: '#0d9488', light: '#f0fdfa', text: '#115e59', border: '#ccfbf1' }, lime: { primary: '#84cc16', hover: '#65a30d', light: '#f7fee7', text: '#3f6212', border: '#d9f99d' }, fuchsia: { primary: '#d946ef', hover: '#c026d3', light: '#fdf4ff', text: '#86198f', border: '#f0abfc' } };
        const emojiList = ["☕", "🥛", "🧃", "🍵", "🧉", "🥤", "🥣", "🍽️", "🥡", "🥢", "🍴", "🥄", "🍞", "🥯", "🥐", "🥖", "🥪", "🥨", "🥞", "🧇", "🥚", "🍳", "🧈", "🧀", "🍎", "🍌", "🍇", "🍓", "🫐", "🥝", "🥑", "🍍", "🥭", "🍑", "🍒", "🍈", "🍉", "🍊", "🍋", "🥗", "🥬", "🥦", "🥒", "🍅", "🥕", "🌽", "🥔", "🧅", "🧄", "🍠", "🥩", "🍗", "🍖", "🥓", "🍔", "🌭", "🥪", "🌮", "🌯", "🥙", "🐟", "🍣", "🍤", "🦞", "🦀", "🦑", "🐙", "🍚", "🍝", "🍜", "🍲", "🍛", "🍱", "🥟", "🍙", "🍘", "🍫", "🍪", "🥜", "🍯", "🍮", "🧁", "🍰", "🍩", "🍦", "🍧", "🍨", "💊", "🧴", "🏋️", "💪", "⚡", "🔋"];
        
        // Ícones específicos para as metas de hábito
        const habitIcons = ["💧", "🌙", "🌱", "💊", "📖", "🧘", "🚶", "📵", "🚭", "🥗", "🏋️", "🍎", "🏃", "🚫🍺", "🏊", "🚲", "🥪", "🍕"];

        function init() {
            if (checkShareMode()) return;
            loadCustomFoodsFromStorage();
            if(document.getElementById('diet-date')) { document.getElementById('diet-date').valueAsDate = new Date(); updateDateDisplay(); }
            initChart();
            const lastPatientId = localStorage.getItem('diet_last_patient_id');
            if (lastPatientId) loadPatient(lastPatientId) || createNewPatient();
            else createNewPatient();
            renderFoodSelect();
            renderEmojiPicker();
            renderActivities();
        }

        // ========================
        // === COMPARTILHAMENTO ===
        // ========================
        
        function updateInitials() {
            const name = document.getElementById('prof-name').value || "RFM";
            const parts = name.trim().split(" ");
            let initials = "";
            // Lógica Atualizada: Pegar 1ª letra das 3 primeiras partes do nome
            if (parts.length === 1) {
                initials = parts[0].substring(0, 3);
            } else {
                initials = parts[0][0];
                if (parts.length >= 2) initials += parts[1][0];
                if (parts.length >= 3) initials += parts[2][0];
            }
            document.getElementById('header-initials').innerText = initials.toUpperCase() || "RFM";
        }

        // Minify: Remove calculated totals to save space
        function minifyData(meals) {
            return meals.map(m => ({
                id: m.id,
                title: m.title,
                observation: m.observation,
                foods: m.foods.map(f => ({
                    id: f.id,
                    name: f.name,
                    qty: f.qty,
                    option: f.option,
                    // Store only base values if custom, else we can lookup from DB
                    // For safety we keep base values but strip TOTALS
                    cal: f.cal, carb: f.carb, prot: f.prot, fat: f.fat, fiber: f.fiber
                }))
            }));
        }

        function restoreTotals(meals) {
            meals.forEach(m => {
                m.foods.forEach(f => {
                    const fac = f.qty / 100;
                    f.totalCal = f.cal * fac;
                    f.totalCarb = f.carb * fac;
                    f.totalProt = f.prot * fac;
                    f.totalFat = f.fat * fac;
                    f.totalFiber = (f.fiber||0) * fac;
                });
            });
            return meals;
        }

        // Funções do Modal de Compartilhamento
        function openShareModal() {
            document.getElementById('share-info-modal').classList.remove('hidden');
        }
        
        function closeShareModal() {
            document.getElementById('share-info-modal').classList.add('hidden');
        }

        function generateAndCopyLink() {
            const inputs = {};
            ['patient-name','patient-goal','diet-date','prof-name','prof-crn','prof-phone','prof-insta','target-cal','target-carb-pct','target-prot-pct','target-fat-pct', 'target-fiber'].forEach(f => inputs[f] = document.getElementById(f).value);

            const history = [];
            document.querySelectorAll('#history-table tbody tr').forEach(r => {
                const row = []; 
                r.querySelectorAll('td.measure-cell').forEach(c => row.push(c.innerText)); 
                if(row.length > 0) history.push(row);
            });

            // Otimização: Minificar refeições
            const minifiedMeals = minifyData(dietMeals);
            
            // Verificar seções ocultas
            const hiddenSections = [];
            if(document.getElementById('habit-goals-section').classList.contains('hidden')) hiddenSections.push('habit-goals-section');
            if(document.getElementById('activity-section').classList.contains('hidden')) hiddenSections.push('activity-section');
            if(document.getElementById('goals-card').classList.contains('hidden')) hiddenSections.push('goals-card');


            // Adicionando customGoals ao shareData
            const shareData = { v: 2, i: inputs, m: minifiedMeals, h: history, t: currentTheme, g: document.getElementById('goals-area').innerText, cg: customGoals, pa: physicalActivities, hs: hiddenSections };
            const jsonStr = JSON.stringify(shareData);
            const compressed = LZString.compressToEncodedURIComponent(jsonStr);
            const patientName = document.getElementById('patient-name').value.trim();
            const safeName = encodeURIComponent(patientName).replace(/%20/g, '+');
            const url = window.location.href.split('?')[0] + '?nome=' + safeName + '&d=' + compressed;

            navigator.clipboard.writeText(url).then(() => {
                showToast("Link copiado para área de transferência!", "success");
                closeShareModal();
            }).catch(err => prompt("Copie:", url));
        }
        
        // Mantém função antiga para compatibilidade se chamada diretamente, mas redireciona para modal
        function shareLink() {
            openShareModal();
        }

        function checkShareMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const data = urlParams.get('d');
            if (data) {
                try {
                    let jsonStr = LZString.decompressFromEncodedURIComponent(data);
                    if (!jsonStr) try { jsonStr = decodeURIComponent(escape(atob(data))); } catch(e) {}
                    if (!jsonStr) throw new Error("Dados inválidos");

                    const c = JSON.parse(jsonStr);
                    // Suporte para versão v1 (antiga) e v2 (nova minificada)
                    if(c.v === 2) {
                        dietMeals = restoreTotals(c.m || []);
                        currentTheme = c.t || 'emerald';
                        if(c.i) for(const [k, v] of Object.entries(c.i)) { const el=document.getElementById(k); if(el) el.value=v; }
                        if(c.g) document.getElementById('goals-area').innerText = c.g;
                        customGoals = c.cg || []; // Carrega as metas de hábito
                        physicalActivities = c.pa || []; // Carrega atividades
                        if(c.hs) c.hs.forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });

                    } else {
                        // Legacy support
                        dietMeals = c.meals || [];
                        currentTheme = c.theme || 'emerald';
                        if(c.inputs) for(const [k, v] of Object.entries(c.inputs)) { const el=document.getElementById(k); if(el) el.value=v; }
                        if(c.goalsText) document.getElementById('goals-area').innerText = c.goalsText;
                        customGoals = [];
                        physicalActivities = [];
                    }

                    // View Mode UI Adjustments
                    const pName = document.getElementById('patient-name');
                    if(pName) pName.outerHTML = `<h1 class="text-3xl font-black text-slate-800 text-center leading-tight mb-1 break-words">${pName.value}</h1>`;
                    const pGoal = document.getElementById('patient-goal');
                    if(pGoal) pGoal.outerHTML = `<p class="text-lg font-medium text-slate-600 text-center mb-2 break-words">${pGoal.value}</p>`;
                    
                    setTheme(currentTheme);
                    renderDiet();
                    renderCustomGoals(); // Renderiza as metas no modo view
                    renderActivities(); // Renderiza atividades
                    updateDateDisplay();
                    updateInitials();

                    const tbody = document.querySelector('#history-table tbody');
                    tbody.innerHTML = '';
                    const histData = c.h || c.history || [];
                    if(histData.length > 0) {
                        histData.forEach((r) => { 
                            const tr = document.createElement('tr');
                            r.forEach(cellText => {
                                const td = document.createElement('td');
                                td.className = "measure-cell";
                                td.innerText = cellText; 
                                tr.appendChild(td);
                            });
                            const tdAction = document.createElement('td');
                            tdAction.className = "nutritionist-only";
                            tr.appendChild(tdAction);
                            tbody.appendChild(tr);
                        });
                    }

                    initChart();
                    updateChartData();

                    // SHOW WELCOME SCREEN INSTEAD OF CONTENT IMMEDIATELY
                    document.getElementById('patient-welcome-screen').classList.remove('hidden');
                    document.getElementById('patient-welcome-screen').style.display = 'flex';

                    document.body.classList.add('view-mode');
                    document.getElementById('splash-screen').style.display = 'none';
                    document.querySelectorAll('.nutritionist-only').forEach(el => el.style.display = 'none');
                    return true;
                } catch (e) {
                    console.error(e);
                    alert("Link inválido.");
                    return false;
                }
            }
            return false;
        }

        // --- CHART JS ---
        function initChart() {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [ { label: 'Peso (kg)', data: [], borderColor: '#059669', backgroundColor: '#059669', tension: 0.3 }, { label: 'Cintura (cm)', data: [], borderColor: '#2563eb', backgroundColor: '#2563eb', tension: 0.3, hidden: true }, { label: 'Abdômen (cm)', data: [], borderColor: '#d97706', backgroundColor: '#d97706', tension: 0.3 }, { label: 'Quadril (cm)', data: [], borderColor: '#7c3aed', backgroundColor: '#7c3aed', tension: 0.3, hidden: true } ] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
        function updateChartData() {
            if(!evolutionChart) return;
            const labels=[], weight=[], waist=[], abdomen=[], hips=[];
            document.querySelectorAll('#history-table tbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if(cells.length < 5) return;
                const date = cells[0].innerText.trim();
                if(date) {
                    labels.push(date);
                    weight.push(parseFloat(cells[1].innerText.replace(',','.'))||null);
                    waist.push(parseFloat(cells[2].innerText.replace(',','.'))||null);
                    abdomen.push(parseFloat(cells[3].innerText.replace(',','.'))||null);
                    hips.push(parseFloat(cells[4].innerText.replace(',','.'))||null);
                }
            });
            evolutionChart.data.labels = labels;
            evolutionChart.data.datasets[0].data = weight;
            evolutionChart.data.datasets[1].data = waist;
            evolutionChart.data.datasets[2].data = abdomen;
            evolutionChart.data.datasets[3].data = hips;
            evolutionChart.update();
        }

        // --- Core Functions ---
        function addHistoryRow() {
            const tbody = document.querySelector('#history-table tbody');
            const tr = document.createElement('tr');
            for(let i=0; i<7; i++) {
                const td = document.createElement('td'); td.className = "measure-cell"; td.contentEditable = "true";
                td.onblur = function() { triggerAutoSave(); updateChartData(); };
                tr.appendChild(td);
            }
            const tdAction = document.createElement('td'); tdAction.className = "p-1 text-center no-print col-history-action nutritionist-only";
            tdAction.innerHTML = '<button onclick="deleteHistoryRow(this)" class="text-slate-300 hover:text-red-500 p-1 transition"><i class="fa-solid fa-trash-can"></i></button>';
            tr.appendChild(tdAction);
            tbody.appendChild(tr);
        }
        function deleteHistoryRow(btn) {
            if(document.querySelectorAll('#history-table tbody tr').length <= 1) return showToast("Mantenha pelo menos uma linha", "error");
            if(confirm("Excluir linha?")) { btn.closest('tr').remove(); triggerAutoSave(); updateChartData(); }
        }
        function hideSection(id) { if(confirm("Ocultar seção do paciente?")) { document.getElementById(id).classList.add('hidden'); triggerAutoSave(); } }

        // --- Table Render Logic (Fixing Mobile "50 g" wrap) ---
        function updateFoodMacro(mid, fid, type, valStr) {
            const m = dietMeals.find(x => x.id === mid); if (!m) return;
            const f = m.foods[fid], val = parseFloat(valStr.replace(/[^0-9.]/g, ''));
            if (isNaN(val)) return;
            if (type === 'cal') f.totalCal = val;
            else if (type === 'carb') f.totalCarb = val;
            else if (type === 'prot') f.totalProt = val;
            else if (type === 'fat') f.totalFat = val;
            else if (type === 'fiber') f.totalFiber = val;
            if (f.qty > 0) { const fac = f.qty / 100; if(type==='cal') f.cal=val/fac; if(type==='carb') f.carb=val/fac; if(type==='prot') f.prot=val/fac; if(type==='fat') f.fat=val/fac; if(type==='fiber') f.fiber=val/fac; }
            renderDiet(); triggerAutoSave();
        }

        function renderDiet() {
            const c = document.getElementById('diet-container'); c.innerHTML='';
            let dt = {cal:0, c:0, p:0, f:0, fib:0};
            const tc=parseFloat(document.getElementById('target-cal').value)||2000, tf=parseFloat(document.getElementById('target-fiber').value)||25;
            const pc=parseFloat(document.getElementById('target-carb-pct').value)||50, pp=parseFloat(document.getElementById('target-prot-pct').value)||30, pf=parseFloat(document.getElementById('target-fat-pct').value)||20;
            document.getElementById('total-pct-display').innerText = (pc+pp+pf);

            dietMeals.forEach((m, idx) => {
                let mc={cal:0, c:0, p:0, f:0, fib:0};
                m.foods.forEach(f => { if(f.option==='A'){ mc.cal+=f.totalCal; mc.c+=f.totalCarb; mc.p+=f.totalProt; mc.f+=f.totalFat; mc.fib+=(f.totalFiber||0); dt.cal+=f.totalCal; dt.c+=f.totalCarb; dt.p+=f.totalProt; dt.f+=f.totalFat; dt.fib+=(f.totalFiber||0); } });

                let html = '';
                ['A','B','C'].forEach(opt => {
                    const g = m.foods.filter(f=>f.option===opt);
                    if(g.length>0) {
                        let headerTitle = opt==='A'?'Opção Principal':'Opção '+opt;
                        let swap = opt==='A' ? `<div class="flex gap-2 no-print group/header nutritionist-only"><button onclick="swapMealOptions(${m.id},'A','B')" class="text-[10px] bg-slate-200 px-2 rounded">⬇ B</button><button onclick="swapMealOptions(${m.id},'A','C')" class="text-[10px] bg-slate-200 px-2 rounded">⬇ C</button></div>` : `<div class="no-print group/header nutritionist-only"><button onclick="swapMealOptions(${m.id},'A','${opt}')" class="text-[10px] bg-emerald-100 text-emerald-700 px-2 rounded font-bold border border-emerald-200">⬆ Principal</button></div>`;
                        if(opt!=='A'||m.foods.some(x=>x.option!=='A')) html+=`<div class="bg-slate-50 px-4 py-2 border-y border-slate-100 mt-2 flex justify-between items-center group/header"><span class="text-xs font-bold text-slate-500 uppercase">${headerTitle}</span>${swap}</div>`;
                        
                        // TABLE START
                        html+=`<div class="table-container"><div class="hidden md:block"><table class="w-full text-left text-sm"><tbody class="divide-y divide-slate-100">`;
                        
                        // DESKTOP ROWS
                        g.forEach(f => {
                            const i = m.foods.indexOf(f);
                            html+=`<tr class="hover:bg-slate-50 group">
                                <td class="p-3 font-medium col-name" contenteditable="true" onblur="updateFoodName(${m.id},${i},this.innerText)">${f.name}</td>
                                <td class="p-3 col-qty whitespace-nowrap"><div class="flex items-center justify-center"><input type="number" class="qty-input" value="${f.qty}" onchange="updateFoodQty(${m.id},${i},this.value)"><span class="ml-1">g</span></div></td>
                                <td class="p-3 text-center text-xs col-cal cursor-text hover:bg-slate-100 rounded whitespace-nowrap" contenteditable="true" onblur="updateFoodMacro(${m.id},${i},'cal',this.innerText)">${f.totalCal.toFixed(0)} kcal</td>
                                <td class="p-3 text-center text-[10px] col-macro cursor-text hover:bg-slate-100 rounded whitespace-nowrap hide-macros" contenteditable="true" onblur="updateFoodMacro(${m.id},${i},'carb',this.innerText)">C: ${f.totalCarb.toFixed(0)}</td>
                                <td class="p-3 text-center text-[10px] col-macro cursor-text hover:bg-slate-100 rounded whitespace-nowrap hide-macros" contenteditable="true" onblur="updateFoodMacro(${m.id},${i},'prot',this.innerText)">P: ${f.totalProt.toFixed(0)}</td>
                                <td class="p-3 text-center text-[10px] col-macro cursor-text hover:bg-slate-100 rounded whitespace-nowrap hide-macros" contenteditable="true" onblur="updateFoodMacro(${m.id},${i},'fat',this.innerText)">G: ${f.totalFat.toFixed(0)}</td>
                                <td class="p-3 text-center text-[10px] col-macro cursor-text hover:bg-slate-100 rounded whitespace-nowrap hide-macros" contenteditable="true" onblur="updateFoodMacro(${m.id},${i},'fiber',this.innerText)">F: ${(f.totalFiber||0).toFixed(1)}</td>
                                <td class="p-3 text-center w-28 col-actions no-print nutritionist-only"><div class="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100"><button onclick="openSubstitutionModal(${m.id},${i})" class="text-indigo-400 px-1"><i class="fa-solid fa-exchange-alt"></i></button><button onclick="removeFood(${m.id},${i})" class="text-red-400 px-1"><i class="fa-solid fa-times"></i></button></div></td>
                            </tr>`;
                        });
                        html+=`</tbody></table></div>`;

                        // MOBILE ROWS (Visible only on small screens)
                        html+=`<div class="md:hidden divide-y divide-slate-100">`;
                        g.forEach(f => {
                            const i = m.foods.indexOf(f);
                            html+=`<div class="meal-table-row">
                                <div class="font-medium text-sm leading-tight" contenteditable="true" onblur="updateFoodName(${m.id},${i},this.innerText)">${f.name}</div>
                                <div class="text-sm font-bold whitespace-nowrap flex items-center bg-slate-50 rounded px-2"><input type="number" class="qty-input w-10 bg-transparent" value="${f.qty}" onchange="updateFoodQty(${m.id},${i},this.value)"> g</div>
                                <div class="text-xs font-bold text-slate-500 whitespace-nowrap">${f.totalCal.toFixed(0)} kcal</div>
                                <div class="meal-table-macros hide-macros">
                                    <span class="text-blue-600">C:${f.totalCarb.toFixed(0)}</span>
                                    <span class="text-emerald-600">P:${f.totalProt.toFixed(0)}</span>
                                    <span class="text-yellow-600">G:${f.totalFat.toFixed(0)}</span>
                                    <span class="text-orange-600">F:${(f.totalFiber||0).toFixed(0)}</span>
                                </div>
                            </div>`;
                        });
                        html+=`</div></div>`;
                    }
                });
                
                if(m.foods.length===0) html=`<div class="p-6 text-center text-slate-400 text-sm italic no-print nutritionist-only">Nenhum alimento.</div>`;

                c.innerHTML += `<div class="card meal-card bg-white rounded-xl shadow-sm theme-border border overflow-hidden relative group mt-4">
                    <div class="absolute top-4 right-4 flex gap-2 no-print opacity-0 group-hover:opacity-100 z-10 nutritionist-only"><button onclick="duplicateMeal(${m.id})" class="text-slate-300 hover:text-blue-500"><i class="fa-regular fa-copy"></i></button><button onclick="deleteMeal(${m.id})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div>
                    <div class="meal-header theme-bg-light p-4 border-b theme-border flex justify-between items-center"><div class="flex items-center gap-3"><div class="flex flex-col gap-1 no-print nutritionist-only"><button onclick="moveMeal(${idx},-1)"><i class="fa-solid fa-chevron-up text-slate-400 text-[10px]"></i></button><button onclick="moveMeal(${idx},1)"><i class="fa-solid fa-chevron-down text-slate-400 text-[10px]"></i></button></div><h3 class="font-bold text-slate-700 cursor-text" contenteditable="true" onblur="updateMealTitle(${m.id},this.innerText)">${m.title}</h3><button onclick="toggleEmojiPicker(${m.id}, event)" class="text-slate-400 hover:text-yellow-500 no-print emoji-trigger nutritionist-only"><i class="fa-solid fa-face-smile"></i></button></div></div>
                    <div>${html}</div>
                    <div class="totals-footer p-3 bg-slate-50 border-t border-slate-100 flex flex-wrap justify-end gap-x-6 gap-y-2 text-xs font-bold text-slate-600">
                        <span>Total: ${mc.cal.toFixed(0)} kcal</span>
                        <span class="text-blue-600">C: ${mc.c.toFixed(0)}g</span>
                        <span class="text-emerald-600">P: ${mc.p.toFixed(0)}g</span>
                        <span class="text-yellow-600">G: ${mc.f.toFixed(0)}g</span>
                        <span class="text-orange-600">F: ${mc.fib.toFixed(1)}g</span>
                    </div>
                    <div class="px-4 pb-4 pt-2 border-t border-slate-100 relative group/obs"><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold text-slate-400 uppercase">Observações</span><button onclick="clearMealObservation(${m.id})" class="no-print opacity-0 group-hover/obs:opacity-100 text-slate-300 hover:text-red-500 nutritionist-only"><i class="fa-solid fa-xmark"></i></button></div><div class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm text-slate-600 outline-none" contenteditable="true" onblur="updateMealObservation(${m.id},this.innerText)">${m.observation||''}</div></div>
                    <div class="patient-footer-link p-2 text-center theme-bg-light border-t theme-border mt-0"><span class="text-[10px] font-medium theme-text">Deseja substituir algum alimento? 🥗 <a href="https://romulo-f-monteiro.github.io/nutrientes/" target="_blank" class="font-bold underline">Clique aqui</a></span></div>
                </div>`;
            });

            c.innerHTML += `<div class="card summary-card bg-slate-800 text-white rounded-xl shadow-md border border-slate-700 mt-6"><div class="p-4 border-b border-slate-700 flex justify-between"><h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-chart-pie text-emerald-400"></i> 🍎 Ingestão Diária</h3><span class="text-xs text-slate-400"></span></div><div class="p-6 pt-2 pb-6"><div class="grid grid-cols-2 md:grid-cols-5 gap-6 text-center"><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Calorias</div><div class="text-3xl font-bold">${dt.cal.toFixed(0)}</div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Carboidrato</div><div class="text-2xl font-bold text-blue-400">${dt.c.toFixed(0)}g</div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Proteína</div><div class="text-2xl font-bold text-emerald-400">${dt.p.toFixed(0)}g</div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Gordura</div><div class="text-2xl font-bold text-yellow-400">${dt.f.toFixed(0)}g</div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Fibras</div><div class="text-2xl font-bold text-orange-400">${dt.fib.toFixed(0)}g</div></div></div><p class="text-xs text-slate-400 mt-6 font-light">Aqui está a soma de todas as opções principais de alimentos que compõem sua dieta. É importante destacar que nem sempre é fácil atingir a meta diária.</p></div></div>`;

            if(showGoals) c.innerHTML += `<div class="card summary-card bg-slate-800 text-white rounded-xl shadow-md border border-slate-700 mt-4 relative group"><button onclick="removeGoals()" class="absolute top-3 right-3 text-slate-400 hover:text-red-500 transition no-print nutritionist-only opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash-can"></i></button><div class="p-4 border-b border-slate-700 flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-flag-checkered text-emerald-400"></i> Meta diária de ingestão</h3></div><div class="p-6 pt-2 pb-6"><div class="grid grid-cols-2 md:grid-cols-5 gap-6 text-center"><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Kcal</div><div class="text-3xl font-bold text-white">${tc.toFixed(0)}</div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Carbo</div><div class="text-2xl font-bold text-blue-400">${(tc*(pc/100)/4).toFixed(0)}g <span class="text-xs text-slate-500 font-normal">(${pc}%)</span></div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Prot</div><div class="text-2xl font-bold text-emerald-400">${(tc*(pp/100)/4).toFixed(0)}g <span class="text-xs text-slate-500 font-normal">(${pp}%)</span></div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Gord</div><div class="text-2xl font-bold text-yellow-400">${(tc*(pf/100)/9).toFixed(0)}g <span class="text-xs text-slate-500 font-normal">(${pf}%)</span></div></div><div><div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Meta Fibras</div><div class="text-2xl font-bold text-orange-400">${tf.toFixed(0)}g</div></div></div><p class="text-xs text-slate-400 mt-6 font-light">Essa meta diária é definida de acordo com seu objetivo, peso, altura, idade, entre outros fatores.</p></div></div>`;
            
            const w=document.getElementById('comparison-widget'); if(w) w.innerHTML=`<div class="flex justify-end border-b pb-1 mb-2 text-[11px] font-bold text-slate-500"><span>Consumido / Meta</span></div><div class="flex justify-between"><span class="text-slate-500">Calorias:</span><span class="font-bold ${dt.cal-tc>100?'text-red-500':'text-green-500'}">${dt.cal.toFixed(0)} / ${tc.toFixed(0)}</span></div><div class="flex justify-between"><span class="text-blue-500">Carboidrato:</span><span>${dt.c.toFixed(0)}g / ${(tc*(pc/100)/4).toFixed(0)}g</span></div><div class="flex justify-between"><span class="text-emerald-500">Proteína:</span><span>${dt.p.toFixed(0)}g / ${(tc*(pp/100)/4).toFixed(0)}g</span></div><div class="flex justify-between"><span class="text-yellow-500">Gordura:</span><span>${dt.f.toFixed(0)}g / ${(tc*(pf/100)/9).toFixed(0)}g</span></div><div class="flex justify-between"><span class="text-orange-500">Fibras:</span><span>${dt.fib.toFixed(0)}g / ${tf}g</span></div>`;
        }

        // ==================================================
        // === LÓGICA DAS NOVAS METAS (HÁBITOS) ===
        // ==================================================

        function renderCustomGoals() {
            const container = document.getElementById('habit-goals-container');
            container.innerHTML = '';

            customGoals.forEach((goal, index) => {
                const daysHtml = goal.days.map((checked, dayIndex) => 
                    `<div class="habit-check ${checked ? 'checked' : 'bg-slate-100'}" 
                           onclick="toggleHabitDay(${index}, ${dayIndex})"></div>`
                ).join('');

                // Opções de ícones para o select
                const iconOptions = habitIcons.map(icon => 
                    `<option value="${icon}" ${goal.icon === icon ? 'selected' : ''}>${icon}</option>`
                ).join('');

                const html = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 relative group">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-2 flex-1">
                                <select class="bg-transparent text-xl cursor-pointer outline-none w-12" 
                                        onchange="updateHabitIcon(${index}, this.value)" 
                                        ${document.body.classList.contains('view-mode') ? 'disabled' : ''}>
                                    ${iconOptions}
                                </select>
                                <input type="text" 
                                       class="font-semibold text-slate-700 bg-transparent outline-none w-full border-b border-transparent hover:border-slate-200 focus:border-blue-400 transition" 
                                       value="${goal.title}" 
                                       placeholder="Nome da Meta"
                                       onblur="updateHabitTitle(${index}, this.value)">
                            </div>
                            <button onclick="deleteCustomGoal(${index})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition nutritionist-only"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div class="habit-grid">
                            ${daysHtml}
                        </div>
                        <div class="flex justify-between items-center mt-2">
                             <span class="text-[10px] text-slate-300 italic">Marque aqui</span>
                             <span class="text-[10px] text-slate-400 font-medium">${goal.days.filter(d => d).length}/30 dias</span>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function addCustomGoal() {
            customGoals.push({
                title: "Nova Meta",
                icon: "💧",
                days: Array(30).fill(false)
            });
            renderCustomGoals();
            triggerAutoSave();
        }

        function deleteCustomGoal(index) {
            if(confirm("Excluir esta meta?")) {
                customGoals.splice(index, 1);
                renderCustomGoals();
                triggerAutoSave();
            }
        }

        function toggleHabitDay(goalIndex, dayIndex) {
            customGoals[goalIndex].days[dayIndex] = !customGoals[goalIndex].days[dayIndex];
            renderCustomGoals();
            triggerAutoSave();
        }

        function updateHabitTitle(index, newTitle) {
            customGoals[index].title = newTitle;
            triggerAutoSave();
        }

        function updateHabitIcon(index, newIcon) {
            customGoals[index].icon = newIcon;
            renderCustomGoals();
            triggerAutoSave();
        }

        // ========================================
        // === LÓGICA DE ATIVIDADES FÍSICAS ===
        // ========================================

        function renderActivities() {
            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            
            physicalActivities.forEach((act, idx) => {
                const html = `
                    <div class="flex flex-col gap-2 p-4 bg-slate-50 border border-slate-100 rounded-lg group hover:border-slate-200 transition">
                         <div class="flex gap-2 items-center">
                             <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-person-running"></i>
                             </div>
                             <div class="flex-1 w-full">
                                <input type="text" class="font-bold text-slate-700 bg-transparent w-full outline-none placeholder-slate-400 text-sm" 
                                       value="${act.name}" placeholder="Nome da Atividade" 
                                       onblur="updateActivityName(${idx}, this.value)">
                             </div>
                             <button onclick="deleteActivity(${idx})" class="nutritionist-only text-slate-300 hover:text-red-500 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash-can"></i></button>
                         </div>
                         
                         <div class="ml-10">
                            <div class="text-sm text-slate-500 bg-transparent w-full outline-none mb-2 whitespace-pre-wrap break-words cursor-text" 
                                 contenteditable="true" 
                                 placeholder="Descreva a prática atual (ex: 3x semana, 30min)..." 
                                 onblur="updateActivityDesc(${idx}, this.innerText)">${act.desc}</div>
                            
                            <div class="flex items-start gap-2 mt-2 pt-2 border-t border-slate-100">
                                <span class="text-xs font-bold text-emerald-600 uppercase w-24 shrink-0 mt-0.5">Recomendação:</span>
                                <div class="text-sm font-medium text-slate-700 bg-transparent w-full outline-none whitespace-pre-wrap break-words cursor-text" 
                                       contenteditable="true" 
                                       placeholder="Digite a meta recomendada..." 
                                       onblur="updateActivityRec(${idx}, this.innerText)">${act.rec || ''}</div>
                            </div>
                         </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        function addActivityRow() {
            physicalActivities.push({ id: Date.now(), name: "Nova Atividade - Atual", desc: "", rec: "" });
            renderActivities();
            triggerAutoSave();
        }
        
        function deleteActivity(idx) {
             if(confirm("Remover atividade?")) {
                 physicalActivities.splice(idx, 1);
                 renderActivities();
                 triggerAutoSave();
             }
        }
        
        function updateActivityName(idx, val) {
            physicalActivities[idx].name = val;
            triggerAutoSave();
        }

        function updateActivityDesc(idx, val) {
            physicalActivities[idx].desc = val;
            triggerAutoSave();
        }
        
        function updateActivityRec(idx, val) {
            physicalActivities[idx].rec = val;
            triggerAutoSave();
        }

        function addToPlan() {
            const mid = parseInt(document.getElementById('select-meal').value);
            const fid = parseInt(document.getElementById('select-food').value);
            const qty = parseFloat(document.getElementById('input-qty').value);
            const opt = document.querySelector('input[name="meal-option"]:checked').value;

            if(!mid || !fid || isNaN(qty) || qty <= 0) return showToast("Dados inválidos", "error");

            const meal = dietMeals.find(m => m.id === mid);
            const food = foodDatabase.find(f => f.id === fid);

            if(!meal || !food) return;

            const fac = qty / 100;
            const newFood = {
                ...food,
                qty: qty,
                option: opt,
                totalCal: food.cal * fac,
                totalCarb: food.carb * fac,
                totalProt: food.prot * fac,
                totalFat: food.fat * fac,
                totalFiber: (food.fiber || 0) * fac
            };

            meal.foods.push(newFood);
            renderDiet();
            triggerAutoSave();
            showToast("Alimento adicionado!");
        }

        // --- Recalcular Macros ao editar quantidade ---
        function updateFoodQty(mid, fid, val) {
            const m = dietMeals.find(x => x.id === mid);
            if (!m) return;
            const f = m.foods[fid];
            let qty = parseFloat(val);
            if (isNaN(qty) || qty < 0) qty = 0; // Permite 0, mas evita NaN
            
            f.qty = qty;
            const fac = qty / 100;
            
            // Recalcula totais com base nos valores por 100g (que já estão em f.cal, f.carb, etc do objeto original ou minificado)
            // Se o app usa f.cal como base 100g:
            f.totalCal = f.cal * fac;
            f.totalCarb = f.carb * fac;
            f.totalProt = f.prot * fac;
            f.totalFat = f.fat * fac;
            f.totalFiber = (f.fiber || 0) * fac;
            
            renderDiet();
            triggerAutoSave();
        }


        // Functions below unchanged but re-declared for scope safety in one file
        function updateFoodName(mid, fid, v) { const m=dietMeals.find(x=>x.id===mid); if(m&&m.foods[fid]) { m.foods[fid].name=v.trim(); triggerAutoSave(); } }
        function moveFood(mid, fid, d) { const m=dietMeals.find(x=>x.id===mid); if(!m)return; const ni=fid+d; if(ni>=0 && ni<m.foods.length) { [m.foods[fid], m.foods[ni]] = [m.foods[ni], m.foods[fid]]; renderDiet(); triggerAutoSave(); } }
        function removeFood(mid, fid) { const m=dietMeals.find(x=>x.id===mid); if(m) { m.foods.splice(fid,1); renderDiet(); triggerAutoSave(); } }
        function removeGoals() { showGoals=false; renderDiet(); }
        function swapMealOptions(mid, o1, o2) { const m=dietMeals.find(x=>x.id===mid); if(!m)return; m.foods.forEach(f=>{ if(f.option===o1)f.option='T'; }); m.foods.forEach(f=>{ if(f.option===o2)f.option=o1; }); m.foods.forEach(f=>{ if(f.option==='T')f.option=o2; }); renderDiet(); triggerAutoSave(); }
        function updateMealTitle(id, v) { const m=dietMeals.find(x=>x.id===id); if(m){ m.title=v.trim(); renderMealSelect(); triggerAutoSave(); } }
        function updateMealObservation(id, v) { const m=dietMeals.find(x=>x.id===id); if(m){ m.observation=v; triggerAutoSave(); } }
        function clearMealObservation(id) { const m=dietMeals.find(x=>x.id===id); if(m && confirm("Limpar obs?")) { m.observation=""; renderDiet(); triggerAutoSave(); } }
        function renderMealSelect() { const s = document.getElementById('select-meal'); const old = s.value; s.innerHTML=''; dietMeals.forEach(m => { const o=document.createElement('option'); o.value=m.id; o.text=m.title; s.appendChild(o); }); if(old) s.value=old; }
        function renderFoodSelect(ft="") { const s = document.getElementById('select-food'); s.innerHTML=''; let list = [...foodDatabase].sort((a,b)=>a.name.localeCompare(b.name)); if(ft) list = list.filter(f=>f.name.toLowerCase().includes(ft.toLowerCase())); if(list.length===0) { const o=document.createElement('option'); o.text="Sem resultados"; s.appendChild(o); s.disabled=true; return; } s.disabled=false; list.forEach(f => { const o=document.createElement('option'); o.value=f.id; o.text=`${f.isCustom?'★ ':''}${f.name} (${f.cal.toFixed(0)}kcal)`; s.appendChild(o); }); if(list.length>0) s.value=list[0].id; }
        function filterFoods() { const v=document.getElementById('search-food').value; renderFoodSelect(v); document.getElementById('search-hint').classList.toggle('hidden', v.length===0); }
        function renderEmojiPicker() { const c = document.getElementById('emoji-picker'); c.innerHTML = emojiList.map(e => `<button onclick="insertEmoji('${e}')" class="emoji-btn text-xl p-1 hover:bg-slate-100 rounded transition">${e}</button>`).join(''); }
        let currentEmojiTargetId = null;
        function toggleEmojiPicker(mid, event) { event.stopPropagation(); currentEmojiTargetId = mid; const p = document.getElementById('emoji-picker'); const b = event.currentTarget; const r = b.getBoundingClientRect(); if (p.classList.contains('hidden')) { p.style.top = (r.bottom + 5) + 'px'; if (r.bottom + 300 > window.innerHeight) p.style.top = (r.top - 200) + 'px'; let l = r.left; if (l + 288 > window.innerWidth) l = window.innerWidth - 300; p.style.left = l + 'px'; p.classList.remove('hidden'); } else { p.classList.add('hidden'); } }
        function insertEmoji(e) { if (currentEmojiTargetId) { const m = dietMeals.find(x => x.id === currentEmojiTargetId); if (m) { m.title += ' ' + e; renderDiet(); triggerAutoSave(); } } document.getElementById('emoji-picker').classList.add('hidden'); }
        document.addEventListener('click', (e) => { const p = document.getElementById('emoji-picker'); if (!p.contains(e.target) && !e.target.closest('.emoji-trigger')) p.classList.add('hidden'); });
        function exportBackup() { const b = { meta: { date: new Date().toISOString(), version: '1.0' }, patientsList: localStorage.getItem('diet_patients_list'), customFoods: localStorage.getItem('dietCustomFoods'), patientData: {} }; getPatientsList().forEach(p => { const k = 'diet_data_' + p.id; b.patientData[k] = localStorage.getItem(k); }); const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(b)); const a = document.createElement('a'); a.setAttribute("href", d); a.setAttribute("download", `backup_dietas_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(a); a.click(); a.remove(); }
        function importBackup(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = function(ex) { try { const b = JSON.parse(ex.target.result); if(!b.meta || !b.patientsList) throw new Error("Inválido."); if(confirm("Restaurar backup?")) { if(b.patientsList) localStorage.setItem('diet_patients_list', b.patientsList); if(b.customFoods) localStorage.setItem('dietCustomFoods', b.customFoods); if(b.patientData) for (const [k, v] of Object.entries(b.patientData)) if(v) localStorage.setItem(k, v); alert("Restaurado!"); location.reload(); } } catch (err) { alert("Erro: " + err.message); } }; r.readAsText(f); }
        function exportFoodBackup() { const f = localStorage.getItem('dietCustomFoods'); if(!f) return showToast("Sem alimentos personalizados.", "error"); const b = { foods: f, type: "food_backup" }; const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(b)); const a = document.createElement('a'); a.setAttribute("href", d); a.setAttribute("download", `meus_alimentos_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(a); a.click(); a.remove(); }
        function importFoodBackup(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = function(ex) { try { const b = JSON.parse(ex.target.result); if(b.type !== "food_backup") throw new Error("Inválido."); if(confirm("Importar alimentos?")) { const nf = JSON.parse(b.foods); const cf = JSON.parse(localStorage.getItem('dietCustomFoods') || "[]"); const m = [...cf]; nf.forEach(n => { if(!m.find(c => c.id === n.id)) m.push(n); }); localStorage.setItem('dietCustomFoods', JSON.stringify(m)); alert("Importado!"); location.reload(); } } catch (err) { alert("Erro arquivo."); } }; r.readAsText(f); }
        function getPatientsList() { const l = localStorage.getItem('diet_patients_list'); return l ? JSON.parse(l) : []; }
        function savePatientsList(l) { localStorage.setItem('diet_patients_list', JSON.stringify(l)); }
        function openPatientModal() { const l = getPatientsList(); const u = document.getElementById('patient-list'); u.innerHTML = ''; if (l.length === 0) document.getElementById('empty-patients').classList.remove('hidden'); else { document.getElementById('empty-patients').classList.add('hidden'); l.forEach(p => { const a = p.id === currentPatientId; const d = new Date(p.lastModified).toLocaleDateString('pt-BR'); const li = document.createElement('li'); li.className = `p-3 flex justify-between items-center hover:bg-slate-100 transition cursor-pointer ${a ? 'bg-blue-50 border-l-4 border-blue-500' : ''}`; li.onclick = (e) => { if(!e.target.closest('button')) loadPatient(p.id); }; li.innerHTML = `<div><div class="font-bold text-slate-800">${p.name}</div><div class="text-[10px] text-slate-400">Mod: ${d}</div></div><div class="flex gap-2">${a ? '<span class="text-xs text-blue-500 font-bold px-2 py-1 bg-blue-100 rounded">Ativo</span>' : ''}<button onclick="deletePatient('${p.id}')" class="text-slate-300 hover:text-red-500 p-2 transition"><i class="fa-solid fa-trash"></i></button></div>`; u.appendChild(li); }); } document.getElementById('patient-modal').classList.remove('hidden'); }
        function closePatientModal() { document.getElementById('patient-modal').classList.add('hidden'); }
        function createNewPatient() { currentPatientId = 'pat_' + Date.now(); dietMeals = JSON.parse(JSON.stringify(defaultMeals)); customGoals = []; physicalActivities = JSON.parse(JSON.stringify(defaultActivities)); activityGoalText = ""; currentTheme = 'emerald'; document.getElementById('patient-name').value = "Novo Paciente"; document.getElementById('patient-goal').value = ""; document.getElementById('diet-date').valueAsDate = new Date(); document.getElementById('logo-img-main').classList.add('hidden'); document.getElementById('logo-placeholder').classList.remove('hidden'); document.getElementById('logo-img-footer').classList.add('hidden'); document.getElementById('logo-placeholder-footer').classList.remove('hidden'); document.getElementById('target-cal').value = 2000; document.getElementById('target-fiber').value = 25; document.getElementById('calc-weight').value = ""; document.getElementById('calc-height').value = ""; document.getElementById('calc-age').value = ""; document.getElementById('goals-area').innerText = ""; const tb = document.querySelector('#history-table tbody'); tb.innerHTML = ''; for(let i=0; i<5; i++) addHistoryRow(); updateChartData(); saveCurrentPatientState(); renderMealSelect(); renderDiet(); renderCustomGoals(); renderActivities(); setTheme('emerald'); closePatientModal(); showToast("Criado!"); }
        function deletePatient(id) { if(!confirm("Apagar?")) return; let l = getPatientsList().filter(p => p.id !== id); savePatientsList(l); localStorage.removeItem('diet_data_' + id); if(id === currentPatientId) createNewPatient(); else openPatientModal(); }
        function loadPatient(id) { const d = localStorage.getItem('diet_data_' + id); if (!d) return false; try { const da = JSON.parse(d); currentPatientId = id; dietMeals = (!da.meals || da.meals.length === 0) ? JSON.parse(JSON.stringify(defaultMeals)) : da.meals; currentTheme = da.theme || 'emerald'; customGoals = da.customGoals || []; physicalActivities = da.physicalActivities || JSON.parse(JSON.stringify(defaultActivities)); activityGoalText = da.activityGoalText || ""; const f = ['patient-name','patient-goal','diet-date','prof-name','prof-crn','prof-phone','prof-insta','calc-weight','calc-height','calc-age','calc-bf','target-cal','target-carb-pct','target-prot-pct','target-fat-pct', 'target-fiber']; f.forEach(x => { if(document.getElementById(x) && da.inputs[x]!==undefined) document.getElementById(x).value = da.inputs[x]; }); if(da.selects) { document.getElementById('calc-formula').value = da.selects['calc-formula'] || 'mifflin'; document.getElementById('calc-activity').value = da.selects['calc-activity'] || '1.55'; const r = document.querySelector(`input[name="calc-sex"][value="${da.selects['calc-sex']}"]`); if(r) r.checked = true; } if(da.images) { const s = (i, p, src) => { if(src) { document.getElementById(i).src=src; document.getElementById(i).classList.remove('hidden'); document.getElementById(p).classList.add('hidden'); } else { document.getElementById(i).classList.add('hidden'); document.getElementById(p).classList.remove('hidden'); } }; s('logo-img-main', 'logo-placeholder', da.images.mainLogo); s('logo-img-footer', 'logo-placeholder-footer', da.images.footerLogo); } const tb = document.querySelector('#history-table tbody'); tb.innerHTML = ''; if(da.history && da.history.length > 0) { da.history.forEach((r) => { const tr = document.createElement('tr'); r.forEach(c => { const td = document.createElement('td'); td.className = "measure-cell"; td.contentEditable = "true"; td.innerText = c; td.onblur = function() { triggerAutoSave(); updateChartData(); }; tr.appendChild(td); }); const ta = document.createElement('td'); ta.className = "p-1 text-center no-print col-history-action nutritionist-only"; ta.innerHTML = '<button onclick="deleteHistoryRow(this)" class="text-slate-300 hover:text-red-500 p-1 transition"><i class="fa-solid fa-trash-can"></i></button>'; tr.appendChild(ta); tb.appendChild(tr); }); } else { for(let i=0; i<5; i++) addHistoryRow(); } if(da.goalsText) document.getElementById('goals-area').innerText = da.goalsText; setTheme(currentTheme); renderMealSelect(); renderDiet(); renderCustomGoals(); renderActivities(); calculateEnergy(); updateDateDisplay(); toggleBodyFatInput(); updateChartData(); updateInitials(); localStorage.setItem('diet_last_patient_id', id); closePatientModal(); showToast("Carregado!"); return true; } catch (e) { return false; } }
        function triggerAutoSave() { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveCurrentPatientState, 1000); }
        function saveCurrentPatientState() { if (!currentPatientId) return; const inp = {}; ['patient-name','patient-goal','diet-date','prof-name','prof-crn','prof-phone','prof-insta','calc-weight','calc-height','calc-age','calc-bf','target-cal','target-carb-pct','target-prot-pct','target-fat-pct', 'target-fiber'].forEach(f => inp[f] = document.getElementById(f).value); const his = []; document.querySelectorAll('#history-table tbody tr').forEach(r => { const ro = []; r.querySelectorAll('td.measure-cell').forEach(c => ro.push(c.innerText)); his.push(ro); }); const da = { id: currentPatientId, lastModified: Date.now(), theme: currentTheme, inputs: inp, history: his, meals: dietMeals, customGoals: customGoals, physicalActivities: physicalActivities, activityGoalText: activityGoalText, goalsText: document.getElementById('goals-area').innerText, selects: { 'calc-formula': document.getElementById('calc-formula').value, 'calc-activity': document.getElementById('calc-activity').value, 'calc-sex': document.querySelector('input[name="calc-sex"]:checked').value }, images: { mainLogo: document.getElementById('logo-img-main').src.includes('data:') ? document.getElementById('logo-img-main').src : null, footerLogo: document.getElementById('logo-img-footer').src.includes('data:') ? document.getElementById('logo-img-footer').src : null } }; localStorage.setItem('diet_data_' + currentPatientId, JSON.stringify(da)); let l = getPatientsList(); const ix = l.findIndex(p => p.id === currentPatientId); const m = { id: currentPatientId, name: inp['patient-name'] || "Sem Nome", lastModified: Date.now() }; if (ix >= 0) l[ix] = m; else l.push(m); savePatientsList(l); const lb = document.getElementById('current-patient-label'); if(lb) lb.innerText = inp['patient-name'] || "Pacientes"; }
        function toggleBodyFatInput() { const f = document.getElementById('calc-formula').value; if(f==='tinsley_katch'||f==='cunningham') document.getElementById('bf-container').classList.remove('hidden'); else document.getElementById('bf-container').classList.add('hidden'); }
        function calculateEnergy() { const w = parseFloat(document.getElementById('calc-weight').value)||0, h = parseFloat(document.getElementById('calc-height').value)||0, a = parseFloat(document.getElementById('calc-age').value)||0, bf = parseFloat(document.getElementById('calc-bf').value)||0, act = parseFloat(document.getElementById('calc-activity').value)||1.2, s = document.querySelector('input[name="calc-sex"]:checked').value, f = document.getElementById('calc-formula').value; if(w>0 && h>0) document.getElementById('res-bmi').innerText = (w/((h/100)*(h/100))).toFixed(1); else document.getElementById('res-bmi').innerText = '--'; let b = 0; if(w>0) { if(f==='mifflin' && h>0 && a>0) b = (10*w) + (6.25*h) - (5*a) + (s==='m'?5:-161); else if(f==='harris' && h>0 && a>0) b = s==='m' ? 88.362+(13.397*w)+(4.799*h)-(5.677*a) : 447.593+(9.247*w)+(3.098*h)-(4.330*a); else if(f==='tinsley_ph' && h>0) b = (9.65*w) + (573*(h/100)) - (s==='m'?5.08:4.92); else if((f==='tinsley_katch'||f==='cunningham') && bf>0) { const mlg = w*(1-(bf/100)); b = f==='cunningham' ? 500+(22*mlg) : 370+(21.6*mlg); } } if(b>0) { document.getElementById('res-bmr').innerText = b.toFixed(0)+' kcal'; document.getElementById('res-tdee').innerText = (b*act).toFixed(0)+' kcal'; } else { document.getElementById('res-bmr').innerText = '--'; document.getElementById('res-tdee').innerText = '--'; } }
        function addNewMeal() { const n = document.getElementById('new-meal-name').value.trim(); if(!n) return showToast("Nome vazio","error"); dietMeals.push({ id: Date.now(), title: n, foods: [], observation: "" }); document.getElementById('new-meal-name').value=''; renderMealSelect(); renderDiet(); showToast("Criada!"); }
        function deleteMeal(id) { if(confirm("Apagar?")) { dietMeals = dietMeals.filter(m=>m.id!==id); renderMealSelect(); renderDiet(); triggerAutoSave(); } }
        function duplicateMeal(id) { const i = dietMeals.findIndex(m=>m.id===id); if(i===-1)return; const c = JSON.parse(JSON.stringify(dietMeals[i])); c.id=Date.now(); c.title+=' (Cópia)'; dietMeals.splice(i+1,0,c); renderDiet(); renderMealSelect(); triggerAutoSave(); }
        function toggleCustomForm() { document.getElementById('custom-food-form').classList.toggle('hidden'); }
        function loadCustomFoodsFromStorage() { try{const c=JSON.parse(localStorage.getItem('dietCustomFoods')); if(Array.isArray(c)) foodDatabase=[...foodDatabase,...c];}catch(e){} }
        function saveCustomFoodToStorage(f) { const c=JSON.parse(localStorage.getItem('dietCustomFoods'))||[]; c.push(f); localStorage.setItem('dietCustomFoods',JSON.stringify(c)); }
        function clearCustomFoods() { if(confirm("Limpar?")) { localStorage.removeItem('dietCustomFoods'); location.reload(); } }
        function createCustomFood() { const n=document.getElementById('new-name').value, s=parseFloat(document.getElementById('new-serving').value), c=parseFloat(document.getElementById('new-cal').value); const fib = parseFloat(document.getElementById('new-fiber').value)||0; if(!n||!s||isNaN(c)) return showToast("Preencha tudo","error"); const fac=100/s, nf={id:Date.now(), name:n, cal:c*fac, carb:(parseFloat(document.getElementById('new-carb').value)||0)*fac, prot:(parseFloat(document.getElementById('new-prot').value)||0)*fac, fat:(parseFloat(document.getElementById('new-fat').value)||0)*fac, fiber:fib*fac, isCustom:true}; foodDatabase.push(nf); saveCustomFoodToStorage(nf); renderFoodSelect(); document.getElementById('select-food').value=nf.id; toggleCustomForm(); showToast("Criado!"); }
        function setTheme(n) { currentTheme=n; const t=themes[n], r=document.documentElement; r.style.setProperty('--primary',t.primary); r.style.setProperty('--primary-hover',t.hover); r.style.setProperty('--primary-light',t.light); r.style.setProperty('--primary-text',t.text); r.style.setProperty('--border-color',t.border); }
        function updateDateDisplay() { const d=document.getElementById('diet-date').value; if(d) document.getElementById('date-display').innerText=d.split('-').reverse().join('/'); }
        function printDiet() { updateDateDisplay(); window.print(); }
        function showToast(m,t) { const x=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; x.classList.remove('translate-y-20','opacity-0'); setTimeout(()=>x.classList.add('translate-y-20','opacity-0'),3000); }
        function handleImageUpload(e, id, pid) { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(v)=>{ const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas'), ctx=c.getContext('2d'); let w=i.width, h=i.height; if(w>h){if(w>300){h*=300/w;w=300}}else{if(h>150){w*=150/h;h=150}} c.width=w; c.height=h; ctx.drawImage(i,0,0,w,h); const d=c.toDataURL('image/png'); document.getElementById(id).src=d; document.getElementById(id).classList.remove('hidden'); document.getElementById(pid).classList.add('hidden'); triggerAutoSave(); }; i.src=v.target.result; }; r.readAsDataURL(f); }
        
        let currentSubMealId = null, currentSubFoodIndex = null, currentSubMacro = 'carb', currentSubSource = null;
        function openSubstitutionModal(mid, fid) { currentSubMealId = mid; currentSubFoodIndex = fid; const m = dietMeals.find(x => x.id === mid); if (!m || !m.foods[fid]) return; const f = m.foods[fid]; if(document.getElementById('sub-search-input')) document.getElementById('sub-search-input').value = ''; currentSubSource = { name: f.name, cal: f.totalCal, carb: f.totalCarb, prot: f.totalProt, fat: f.totalFat, fiber: f.totalFiber || 0 }; document.getElementById('sub-source-info').innerHTML = `Base: <b>${f.name}</b> (${f.qty}g)<br><span class='text-xs text-slate-500'>Kcal:${f.totalCal.toFixed(0)} C:${f.totalCarb.toFixed(1)} P:${f.totalProt.toFixed(1)} G:${f.totalFat.toFixed(1)} F:${(f.totalFiber||0).toFixed(1)}</span>`; filterSubstitutes('carb'); document.getElementById('substitution-modal').classList.remove('hidden'); }
        function closeSubModal() { document.getElementById('substitution-modal').classList.add('hidden'); }
        function filterSubstitutes(mac) { const tb = document.getElementById('sub-list'); tb.innerHTML = ''; if (mac) currentSubMacro = mac; else mac = currentSubMacro; ['carb','prot','fat'].forEach(m => { const b = document.getElementById('btn-sub-'+m); if(m === mac) b.classList.add('ring-2', 'ring-offset-1'); else b.classList.remove('ring-2', 'ring-offset-1'); }); const tv = currentSubSource[mac]; if (tv <= 0.5) { tb.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-400">Sem quantidade significativa.</td></tr>`; return; } const fd = (v) => { const r = Math.round(v); let c = 'text-slate-400'; if(r > 2) c = 'text-red-500 font-bold'; else if(r < -2) c = 'text-emerald-600 font-bold'; return `<span class="${c} text-[10px] font-mono whitespace-nowrap">${r>0?'+':''}${r}</span>`; }; let cands = foodDatabase.map(f => { const cpg = f[mac] / 100; if (cpg <= 0) return null; const nq = tv / cpg; const rc = (f.cal/100)*nq; const dif = rc - currentSubSource.cal; return { id: f.id, name: f.name, qty: nq, d: dif, s: Math.abs(dif), raw: f }; }).filter(x => x !== null); const st = document.getElementById('sub-search-input').value.toLowerCase().trim(); if (st.length > 0) cands = cands.filter(c => c.name.toLowerCase().includes(st)); cands.sort((a,b) => a.s - b.s); cands.slice(0, 20).forEach(c => { const rq = Math.round(c.qty); const fac = rq / 100; const det = `Kcal:${(c.raw.cal*fac).toFixed(0)} C:${(c.raw.carb*fac).toFixed(1)} P:${(c.raw.prot*fac).toFixed(1)} G:${(c.raw.fat*fac).toFixed(1)}`; const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 border-b border-slate-50"; tr.innerHTML = `<td class="p-3 font-medium text-sm truncate max-w-[200px]" title="${c.name}">${c.name}<div class="text-[10px] text-slate-400 font-normal">${det}</div></td><td class="p-3 text-center font-bold text-blue-600 text-xs">${rq}g</td><td class="p-3 text-center">${fd(c.d)}</td><td class="p-3 text-center"><button onclick="confirmSubstitution(${c.id}, ${rq})" class="bg-indigo-100 text-indigo-700 text-xs font-bold px-3 py-1 rounded">Trocar</button></td>`; tb.appendChild(tr); }); if (cands.length === 0) tb.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-400">Nada encontrado.</td></tr>`; }
        function confirmSubstitution(nid, nq) { const m = dietMeals.find(x => x.id === currentSubMealId); if(!m || !m.foods[currentSubFoodIndex]) return; const of = m.foods[currentSubFoodIndex]; const db = foodDatabase.find(f => f.id === nid); if(!db) return; const fac = nq / 100; const no = { ...db, qty: nq, option: of.option, totalCal: db.cal*fac, totalCarb: db.carb*fac, totalProt: db.prot*fac, totalFat: db.fat*fac, totalFiber: (db.fiber||0)*fac }; m.foods[currentSubFoodIndex] = no; renderDiet(); triggerAutoSave(); closeSubModal(); showToast("Substituído!"); }

        init();
    </script>
</body>
</html>

